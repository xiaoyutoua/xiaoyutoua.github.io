<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰ | å°æ¼å¤´|å°æˆ´</title><meta name="author" content="å°æ¼å¤´&amp;å°æˆ´"><meta name="copyright" content="å°æ¼å¤´&amp;å°æˆ´"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="æœ¬æ–‡æ˜¯æ·±åº¦å­¦ä¹ çš„ç¬¬åäº”ç¯‡ï¼Œæœ¬æ–‡ä»‹ç»åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒå’Œå•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰">
<meta property="og:url" content="http://blog.dai2yutou.space/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.3-YOLOv3%E5%AE%9E%E7%8E%B0AI%E8%AF%86%E8%99%AB%EF%BC%88%E4%B8%8B%EF%BC%89/index.html">
<meta property="og:site_name" content="å°æ¼å¤´|å°æˆ´">
<meta property="og:description" content="æœ¬æ–‡æ˜¯æ·±åº¦å­¦ä¹ çš„ç¬¬åäº”ç¯‡ï¼Œæœ¬æ–‡ä»‹ç»åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒå’Œå•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picbed.dai2yutou.space/web_img/19.png">
<meta property="article:published_time" content="2023-01-03T13:05:55.000Z">
<meta property="article:modified_time" content="2023-03-30T12:13:05.781Z">
<meta property="article:author" content="å°æ¼å¤´&amp;å°æˆ´">
<meta property="article:tag" content="æ·±åº¦å­¦ä¹ ">
<meta property="article:tag" content="äººå·¥æ™ºèƒ½">
<meta property="article:tag" content="paddle">
<meta property="article:tag" content="æ·±åº¦å­¦ä¹ é«˜çº§_è®¡ç®—æœºè§†è§‰ä¹‹ç›®æ ‡æ£€æµ‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picbed.dai2yutou.space/web_img/19.png"><link rel="shortcut icon" href="/img/basketball.png"><link rel="canonical" href="http://blog.dai2yutou.space/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.3-YOLOv3%E5%AE%9E%E7%8E%B0AI%E8%AF%86%E8%99%AB%EF%BC%88%E4%B8%8B%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":50,"languages":{"author":"ä½œè€…: å°æ¼å¤´&å°æˆ´","link":"é“¾æ¥: ","source":"æ¥æº: å°æ¼å¤´|å°æˆ´","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-30 20:13:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/css.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/at.alicdn.com/t/c/font_3829236_a49e40pee5.css"><link rel="stylesheet" href="/css/font-awesome.css"><link rel="stylesheet" href="/css/progress_bar.css"><link rel="stylesheet" href="/css/nav_menu.css"><link rel="stylesheet" href="/css/color.css"><link rel="apple-touch-icon" href="/img/apple-touch-icon.jpg"><meta name="apple-mobile-web-app-title" content="å°æ¼å¤´ğŸ€"><link rel="bookmark" href="/img/apple-touch-icon.jpg"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/apple-touch-icon.jpg" ><link rel="stylesheet" href="/css/card_author.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://www.fomal.cc/static/css/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (ture) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/progress_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.dai2yutou.space/"><span> Home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw hide"></i><span> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><span> ğŸ“¦å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><span> ğŸ”–æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><span> ğŸ“‚åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw hide"></i><span> ä¸‡èŠ±ç­’</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%94%A0%E5%97%91/"><span> ğŸ’­å” å—‘</span></a></li><li><a class="site-page child" href="/HTML/%E6%96%B0%E5%B9%B4%E5%80%92%E8%AE%A1%E6%97%B6/index.html"><span> ğŸ”é¡¹ç›®</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/love/"><span> æ‹çˆ±å°å±‹</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E8%A3%85%E4%BF%AE%E6%97%A5%E5%BF%97/"><span> â°è£…ä¿®æ—¥å¿—</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://picbed.dai2yutou.space/web_img/19.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å°æ¼å¤´|å°æˆ´</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.dai2yutou.space/"><span> Home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw hide"></i><span> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><span> ğŸ“¦å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><span> ğŸ”–æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><span> ğŸ“‚åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw hide"></i><span> ä¸‡èŠ±ç­’</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%94%A0%E5%97%91/"><span> ğŸ’­å” å—‘</span></a></li><li><a class="site-page child" href="/HTML/%E6%96%B0%E5%B9%B4%E5%80%92%E8%AE%A1%E6%97%B6/index.html"><span> ğŸ”é¡¹ç›®</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/love/"><span> æ‹çˆ±å°å±‹</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E8%A3%85%E4%BF%AE%E6%97%A5%E5%BF%97/"><span> â°è£…ä¿®æ—¥å¿—</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-01-03T13:05:55.000Z" title="å‘è¡¨äº 2023-01-03 21:05:55">2023-01-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-30T12:13:05.781Z" title="æ›´æ–°äº 2023-03-30 20:13:05">2023-03-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ </a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">20.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>87åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ä¸€ã€åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒ"><a href="#ä¸€ã€åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒ" class="headerlink" title="ä¸€ã€åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒ"></a>ä¸€ã€åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒ</h1><p>åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…å«å¦‚ä¸‹9ä¸ªæ­¥éª¤ï¼š</p>
<p><strong>1.æ•°æ®å¤„ç†</strong>ï¼šæ ¹æ®ç½‘ç»œæ¥æ”¶çš„æ•°æ®æ ¼å¼ï¼Œå®Œæˆç›¸åº”çš„é¢„å¤„ç†æ“ä½œï¼Œä¿è¯æ¨¡å‹æ­£å¸¸è¯»å–ï¼ŒåŒæ—¶ï¼Œå¯¹äºè®­ç»ƒæ•°æ®ï¼Œä½¿ç”¨æ•°æ®å¢å¹¿ç­–ç•¥æ¥æå‡æ¨¡å‹æ³›åŒ–æ€§èƒ½ï¼›</p>
<p><strong>2.æ¨¡å‹æ„å»º</strong>ï¼šè®¾è®¡æ·±åº¦ç¥ç»ç½‘ç»œç»“æ„ï¼ˆæ¨¡å‹çš„å‡è®¾ç©ºé—´ï¼‰ï¼›</p>
<p><strong>3.æ¨¡å‹åå¤„ç†</strong>ï¼šé€šè¿‡æ¨¡å‹é¢„æµ‹å¾—åˆ°çš„æ¦‚ç‡å›¾ï¼Œç»è¿‡ä¸€ç³»åˆ—åå¤„ç†æ“ä½œå¾—åˆ°çœŸå®çš„è¾“å‡ºå€¼ï¼›</p>
<p><strong>4.æŸå¤±å‡½æ•°å®šä¹‰</strong>ï¼šæ ¹æ®é¢„æµ‹å€¼å’ŒçœŸå®å€¼æ„å»ºæŸå¤±å‡½æ•°ï¼Œç¥ç»ç½‘ç»œé€šè¿‡æœ€å°åŒ–æŸå¤±å‡½æ•°ä½¿å¾—ç½‘ç»œçš„è¾“å‡ºå€¼æ›´æ¥è¿‘çœŸå®å€¼ï¼›</p>
<p><strong>5.è®­ç»ƒé…ç½®</strong>ï¼šå®ä¾‹åŒ–æ¨¡å‹ï¼ŒåŠ è½½æ¨¡å‹å‚æ•°ï¼ŒæŒ‡å®šæ¨¡å‹é‡‡ç”¨çš„å¯»è§£ç®—æ³•ï¼ˆä¼˜åŒ–å™¨ï¼‰ï¼›</p>
<p><strong>6.æ¨¡å‹è®­ç»ƒ</strong>ï¼šæ‰§è¡Œå¤šè½®è®­ç»ƒä¸æ–­è°ƒæ•´å‚æ•°ï¼Œä»¥è¾¾åˆ°è¾ƒå¥½çš„æ•ˆæœï¼›</p>
<p><strong>7.æ¨¡å‹ä¿å­˜</strong>ï¼šå°†æ¨¡å‹å‚æ•°ä¿å­˜åˆ°æŒ‡å®šä½ç½®ï¼Œä¾¿äºåç»­æ¨ç†æˆ–ç»§ç»­è®­ç»ƒä½¿ç”¨ï¼›</p>
<p><strong>8.æ¨¡å‹è¯„ä¼°</strong>ï¼šå¯¹è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œè¯„ä¼°æµ‹è¯•ï¼Œè§‚å¯Ÿå‡†ç¡®ç‡å’ŒLossï¼›</p>
<p><strong>9.æ¨¡å‹æ¨ç†åŠå¯è§†åŒ–</strong>ï¼šä½¿ç”¨ä¸€å¼ çœŸå®å›¾ç‰‡æ¥éªŒè¯æ¨¡å‹è¯†åˆ«çš„æ•ˆæœï¼Œå¹¶å¯è§†åŒ–æ¨ç†ç»“æœã€‚</p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/fc58e8f1fa1943448d5077d7bff25afa94c4d41925274f3985592cc935f253c9" width = "900"></center>

<blockquote>
<p>ä¸Šè¿°ä¸æ˜¯æ–‡æœ¬æ£€æµ‹æ˜¯ç›®æ ‡æ£€æµ‹ï¼Œæ‰“é”™äº†ï¼ï¼ï¼</p>
</blockquote>
<p><br></br></p>
<hr>
<blockquote>
<p><strong>è¯´æ˜ï¼š</strong></p>
<p>ä¸åŒçš„æ·±åº¦å­¦ä¹ ä»»åŠ¡ï¼Œä½¿ç”¨æ·±åº¦å­¦ä¹ æ¡†æ¶çš„ä»£ç ç»“æ„åŸºæœ¬ç›¸ä¼¼ã€‚å¤§å®¶æŒæ¡äº†ä¸€ä¸ªä»»åŠ¡çš„å®ç°æ–¹æ³•ï¼Œä¾¿å¾ˆå®¹æ˜“åœ¨æ­¤åŸºç¡€ä¸Šä¸¾ä¸€åä¸‰ã€‚ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¡†æ¶å¯ä»¥å±è”½åº•å±‚å®ç°ï¼Œç”¨æˆ·åªéœ€å…³æ³¨æ¨¡å‹çš„é€»è¾‘ç»“æ„ã€‚åŒæ—¶ï¼Œç®€åŒ–äº†è®¡ç®—ï¼Œé™ä½äº†æ·±åº¦å­¦ä¹ å…¥é—¨é—¨æ§›ã€‚</p>
</blockquote>
<hr>
<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>æœ¬å®éªŒæ”¯æŒåœ¨é£æ¡¨å®è®­å¹³å°æˆ–æœ¬åœ°ç¯å¢ƒæ“ä½œï¼Œå»ºè®®æ‚¨ä½¿ç”¨é£æ¡¨å®è®­å¹³å°ã€‚</p>
<ul>
<li><strong>é£æ¡¨å®è®­å¹³å°</strong>ï¼šå®è®­å¹³å°é›†æˆäº†å®éªŒå¿…é¡»çš„å¤§éƒ¨åˆ†ç›¸å…³ç¯å¢ƒï¼Œä»£ç å¯åœ¨çº¿è¿è¡Œï¼ŒåŒæ—¶è¿˜æä¾›äº†å…è´¹ç®—åŠ›ï¼Œå³ä½¿å®è·µå¤æ‚æ¨¡å‹ä¹Ÿæ— ç®—åŠ›ä¹‹å¿§ã€‚</li>
<li><strong>æœ¬åœ°ç¯å¢ƒ</strong>ï¼šå¦‚æœæ‚¨é€‰æ‹©åœ¨æœ¬åœ°ç¯å¢ƒä¸Šæ“ä½œï¼Œéœ€è¦å®‰è£…Python3.Xã€é£æ¡¨å¼€æºæ¡†æ¶2.X ç­‰å®éªŒå¿…é¡»çš„ç¯å¢ƒï¼Œå…·ä½“è¯·å‚è§<a target="_blank" rel="noopener" href="https://www.paddlepaddle.org.cn/install/quick?docurl=/documentation/docs/zh/install/pip/windows-pip.html">ã€Šé£æ¡¨å¼€å§‹ä½¿ç”¨-å®‰è£…ã€‹</a>ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§£å‹æ•°æ®è„šæœ¬ï¼Œå°†æ–‡ä»¶è§£å‹åˆ°workç›®å½•ä¸‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¼€å§‹è§£å‹......&#x27;</span>)</span><br><span class="line">!unzip  -o -q -d  /home/aistudio/work /home/aistudio/data/data170339/insects.<span class="built_in">zip</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;è§£å‹å®Œæˆ&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageEnhance</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"></span><br><span class="line">INSECT_NAMES = [<span class="string">&#x27;Boerner&#x27;</span>, <span class="string">&#x27;Leconte&#x27;</span>, <span class="string">&#x27;Linnaeus&#x27;</span>, </span><br><span class="line">                <span class="string">&#x27;acuminatus&#x27;</span>, <span class="string">&#x27;armandi&#x27;</span>, <span class="string">&#x27;coleoptera&#x27;</span>, <span class="string">&#x27;linnaeus&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_insect_names</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    return a dict, as following,</span></span><br><span class="line"><span class="string">        &#123;&#x27;Boerner&#x27;: 0,</span></span><br><span class="line"><span class="string">         &#x27;Leconte&#x27;: 1,</span></span><br><span class="line"><span class="string">         &#x27;Linnaeus&#x27;: 2, </span></span><br><span class="line"><span class="string">         &#x27;acuminatus&#x27;: 3,</span></span><br><span class="line"><span class="string">         &#x27;armandi&#x27;: 4,</span></span><br><span class="line"><span class="string">         &#x27;coleoptera&#x27;: 5,</span></span><br><span class="line"><span class="string">         &#x27;linnaeus&#x27;: 6</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    It can map the insect name into an integer label.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    insect_category2id = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(INSECT_NAMES):</span><br><span class="line">        insect_category2id[item] = i <span class="comment"># æ„å»ºé”®å€¼å¯¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> insect_category2id</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_annotations</span>(<span class="params">cname2cid, datadir</span>):</span><br><span class="line">    filenames = os.listdir(os.path.join(datadir, <span class="string">&#x27;annotations&#x27;</span>, <span class="string">&#x27;xmls&#x27;</span>))</span><br><span class="line">    records = []</span><br><span class="line">    ct = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> fname <span class="keyword">in</span> filenames:</span><br><span class="line">        fid = fname.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] <span class="comment"># åºå·</span></span><br><span class="line">        fpath = os.path.join(datadir, <span class="string">&#x27;annotations&#x27;</span>, <span class="string">&#x27;xmls&#x27;</span>, fname) <span class="comment"># è·¯å¾„</span></span><br><span class="line">        img_file = os.path.join(datadir, <span class="string">&#x27;images&#x27;</span>, fid + <span class="string">&#x27;.jpeg&#x27;</span>) <span class="comment"># åºå·--&gt;å›¾ç‰‡</span></span><br><span class="line">        tree = ET.parse(fpath) <span class="comment"># è¯»å–xmlæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tree.find(<span class="string">&#x27;id&#x27;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            im_id = np.array([ct])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            im_id = np.array([<span class="built_in">int</span>(tree.find(<span class="string">&#x27;id&#x27;</span>).text)])</span><br><span class="line"></span><br><span class="line">        objs = tree.findall(<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">        im_w = <span class="built_in">float</span>(tree.find(<span class="string">&#x27;size&#x27;</span>).find(<span class="string">&#x27;width&#x27;</span>).text)</span><br><span class="line">        im_h = <span class="built_in">float</span>(tree.find(<span class="string">&#x27;size&#x27;</span>).find(<span class="string">&#x27;height&#x27;</span>).text)</span><br><span class="line">        gt_bbox = np.zeros((<span class="built_in">len</span>(objs), <span class="number">4</span>), dtype=np.float32)</span><br><span class="line">        gt_class = np.zeros((<span class="built_in">len</span>(objs), ), dtype=np.int32)</span><br><span class="line">        is_crowd = np.zeros((<span class="built_in">len</span>(objs), ), dtype=np.int32)</span><br><span class="line">        difficult = np.zeros((<span class="built_in">len</span>(objs), ), dtype=np.int32)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, obj <span class="keyword">in</span> <span class="built_in">enumerate</span>(objs):</span><br><span class="line">            cname = obj.find(<span class="string">&#x27;name&#x27;</span>).text</span><br><span class="line">            gt_class[i] = cname2cid[cname]</span><br><span class="line">            _difficult = <span class="built_in">int</span>(obj.find(<span class="string">&#x27;difficult&#x27;</span>).text)</span><br><span class="line">            x1 = <span class="built_in">float</span>(obj.find(<span class="string">&#x27;bndbox&#x27;</span>).find(<span class="string">&#x27;xmin&#x27;</span>).text)</span><br><span class="line">            y1 = <span class="built_in">float</span>(obj.find(<span class="string">&#x27;bndbox&#x27;</span>).find(<span class="string">&#x27;ymin&#x27;</span>).text)</span><br><span class="line">            x2 = <span class="built_in">float</span>(obj.find(<span class="string">&#x27;bndbox&#x27;</span>).find(<span class="string">&#x27;xmax&#x27;</span>).text)</span><br><span class="line">            y2 = <span class="built_in">float</span>(obj.find(<span class="string">&#x27;bndbox&#x27;</span>).find(<span class="string">&#x27;ymax&#x27;</span>).text)</span><br><span class="line">            x1 = <span class="built_in">max</span>(<span class="number">0</span>, x1)</span><br><span class="line">            y1 = <span class="built_in">max</span>(<span class="number">0</span>, y1)</span><br><span class="line">            x2 = <span class="built_in">min</span>(im_w - <span class="number">1</span>, x2)</span><br><span class="line">            y2 = <span class="built_in">min</span>(im_h - <span class="number">1</span>, y2)</span><br><span class="line">            <span class="comment"># è¿™é‡Œå°†åŸäºŒç‚¹è¡¨ç¤ºè½¬æ¢ä¸ºxywhæ ¼å¼ï¼Œä½¿ç”¨xywhæ ¼å¼æ¥è¡¨ç¤ºç›®æ ‡ç‰©ä½“çœŸå®æ¡†</span></span><br><span class="line">            gt_bbox[i] = [(x1+x2)/<span class="number">2.0</span> , (y1+y2)/<span class="number">2.0</span>, x2-x1+<span class="number">1.</span>, y2-y1+<span class="number">1.</span>]</span><br><span class="line">            is_crowd[i] = <span class="number">0</span></span><br><span class="line">            difficult[i] = _difficult</span><br><span class="line"></span><br><span class="line">        voc_rec = &#123;</span><br><span class="line">            <span class="string">&#x27;im_file&#x27;</span>: img_file,</span><br><span class="line">            <span class="string">&#x27;im_id&#x27;</span>: im_id,</span><br><span class="line">            <span class="string">&#x27;h&#x27;</span>: im_h,</span><br><span class="line">            <span class="string">&#x27;w&#x27;</span>: im_w,</span><br><span class="line">            <span class="string">&#x27;is_crowd&#x27;</span>: is_crowd,</span><br><span class="line">            <span class="string">&#x27;gt_class&#x27;</span>: gt_class,</span><br><span class="line">            <span class="string">&#x27;gt_bbox&#x27;</span>: gt_bbox,</span><br><span class="line">            <span class="string">&#x27;gt_poly&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;difficult&#x27;</span>: difficult</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(objs) != <span class="number">0</span>:</span><br><span class="line">            records.append(voc_rec)</span><br><span class="line">        ct += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> records</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bbox</span>(<span class="params">gt_bbox, gt_class</span>):</span><br><span class="line">    <span class="comment"># å¯¹äºä¸€èˆ¬çš„æ£€æµ‹ä»»åŠ¡æ¥è¯´ï¼Œä¸€å¼ å›¾ç‰‡ä¸Šå¾€å¾€ä¼šæœ‰å¤šä¸ªç›®æ ‡ç‰©ä½“</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å‚æ•°MAX_NUM = 50ï¼Œ å³ä¸€å¼ å›¾ç‰‡æœ€å¤šå–50ä¸ªçœŸå®æ¡†ï¼›</span></span><br><span class="line">    <span class="comment"># å¦‚æœçœŸå®æ¡†çš„æ•°ç›®å°‘äº50ä¸ªï¼Œåˆ™å°†ä¸è¶³éƒ¨åˆ†çš„gt_bbox, gt_classå’Œgt_scoreçš„å„é¡¹æ•°å€¼å…¨è®¾ç½®ä¸º0</span></span><br><span class="line">    MAX_NUM = <span class="number">50</span></span><br><span class="line">    gt_bbox2 = np.zeros((MAX_NUM, <span class="number">4</span>))</span><br><span class="line">    gt_class2 = np.zeros((MAX_NUM,))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(gt_bbox)):</span><br><span class="line">        gt_bbox2[i, :] = gt_bbox[i, :]</span><br><span class="line">        gt_class2[i] = gt_class[i]</span><br><span class="line">        <span class="keyword">if</span> i &gt;= MAX_NUM:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> gt_bbox2, gt_class2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_img_data_from_file</span>(<span class="params">record</span>):</span><br><span class="line">    im_file = record[<span class="string">&#x27;im_file&#x27;</span>]</span><br><span class="line">    h = record[<span class="string">&#x27;h&#x27;</span>]</span><br><span class="line">    w = record[<span class="string">&#x27;w&#x27;</span>]</span><br><span class="line">    is_crowd = record[<span class="string">&#x27;is_crowd&#x27;</span>]</span><br><span class="line">    gt_class = record[<span class="string">&#x27;gt_class&#x27;</span>]</span><br><span class="line">    gt_bbox = record[<span class="string">&#x27;gt_bbox&#x27;</span>]</span><br><span class="line">    difficult = record[<span class="string">&#x27;difficult&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    img = cv2.imread(im_file)</span><br><span class="line">    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æœºå™¨æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">assert</span> img.shape[<span class="number">0</span>] == <span class="built_in">int</span>(h), \</span><br><span class="line">             <span class="string">&quot;image height of &#123;&#125; inconsistent in record(&#123;&#125;) and img file(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">               im_file, h, img.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> img.shape[<span class="number">1</span>] == <span class="built_in">int</span>(w), \</span><br><span class="line">             <span class="string">&quot;image width of &#123;&#125; inconsistent in record(&#123;&#125;) and img file(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">               im_file, w, img.shape[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    gt_boxes, gt_labels = get_bbox(gt_bbox, gt_class)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># gt_bbox ç”¨ç›¸å¯¹å€¼</span></span><br><span class="line">    gt_boxes[:, <span class="number">0</span>] = gt_boxes[:, <span class="number">0</span>] / <span class="built_in">float</span>(w)</span><br><span class="line">    gt_boxes[:, <span class="number">1</span>] = gt_boxes[:, <span class="number">1</span>] / <span class="built_in">float</span>(h)</span><br><span class="line">    gt_boxes[:, <span class="number">2</span>] = gt_boxes[:, <span class="number">2</span>] / <span class="built_in">float</span>(w)</span><br><span class="line">    gt_boxes[:, <span class="number">3</span>] = gt_boxes[:, <span class="number">3</span>] / <span class="built_in">float</span>(h)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> img, gt_boxes, gt_labels, (h, w)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”åŸå›¾å’Œå›¾åƒå¢å¼ºçš„æ•ˆæœ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">srcimg, img_enhance</span>):</span><br><span class="line">    plt.figure(num=<span class="number">2</span>, figsize=(<span class="number">6</span>,<span class="number">12</span>))</span><br><span class="line">    plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Src Image&#x27;</span>, color=<span class="string">&#x27;#0000FF&#x27;</span>)</span><br><span class="line">    plt.axis(<span class="string">&#x27;off&#x27;</span>) <span class="comment"># ä¸æ˜¾ç¤ºåæ ‡è½´</span></span><br><span class="line">    plt.imshow(srcimg) <span class="comment"># æ˜¾ç¤ºåŸå›¾ç‰‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹åŸå›¾åšéšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰æ•°æ®å¢å¼º</span></span><br><span class="line">    srcimg_gtbox = records[<span class="number">0</span>][<span class="string">&#x27;gt_bbox&#x27;</span>]</span><br><span class="line">    srcimg_label = records[<span class="number">0</span>][<span class="string">&#x27;gt_class&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Enhance Image&#x27;</span>, color=<span class="string">&#x27;#0000FF&#x27;</span>)</span><br><span class="line">    plt.axis(<span class="string">&#x27;off&#x27;</span>) <span class="comment"># ä¸æ˜¾ç¤ºåæ ‡è½´</span></span><br><span class="line">    plt.imshow(img_enhance/<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_distort</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="comment"># éšæœºæ”¹å˜äº®åº¦</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_brightness</span>(<span class="params">img, lower=<span class="number">0.5</span>, upper=<span class="number">1.5</span></span>):</span><br><span class="line">        e = np.random.uniform(lower, upper)</span><br><span class="line">        <span class="keyword">return</span> ImageEnhance.Brightness(img).enhance(e)</span><br><span class="line">    <span class="comment"># éšæœºæ”¹å˜å¯¹æ¯”åº¦</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_contrast</span>(<span class="params">img, lower=<span class="number">0.5</span>, upper=<span class="number">1.5</span></span>):</span><br><span class="line">        e = np.random.uniform(lower, upper)</span><br><span class="line">        <span class="keyword">return</span> ImageEnhance.Contrast(img).enhance(e)</span><br><span class="line">    <span class="comment"># éšæœºæ”¹å˜é¢œè‰²</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_color</span>(<span class="params">img, lower=<span class="number">0.5</span>, upper=<span class="number">1.5</span></span>):</span><br><span class="line">        e = np.random.uniform(lower, upper)</span><br><span class="line">        <span class="keyword">return</span> ImageEnhance.Color(img).enhance(e)</span><br><span class="line"></span><br><span class="line">    ops = [random_brightness, random_contrast, random_color]</span><br><span class="line">    np.random.shuffle(ops)</span><br><span class="line"></span><br><span class="line">    img = Image.fromarray(img)</span><br><span class="line">    img = ops[<span class="number">0</span>](img)</span><br><span class="line">    img = ops[<span class="number">1</span>](img)</span><br><span class="line">    img = ops[<span class="number">2</span>](img)</span><br><span class="line">    img = np.asarray(img)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºå¡«å……</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_expand</span>(<span class="params">img,</span></span><br><span class="line"><span class="params">                  gtboxes,</span></span><br><span class="line"><span class="params">                  max_ratio=<span class="number">4.</span>,</span></span><br><span class="line"><span class="params">                  fill=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                  keep_ratio=<span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                  thresh=<span class="number">0.5</span></span>):</span><br><span class="line">    <span class="keyword">if</span> random.random() &gt; thresh:</span><br><span class="line">        <span class="keyword">return</span> img, gtboxes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> max_ratio &lt; <span class="number">1.0</span>:</span><br><span class="line">        <span class="keyword">return</span> img, gtboxes</span><br><span class="line"></span><br><span class="line">    h, w, c = img.shape</span><br><span class="line">    ratio_x = random.uniform(<span class="number">1</span>, max_ratio)</span><br><span class="line">    <span class="keyword">if</span> keep_ratio:</span><br><span class="line">        ratio_y = ratio_x</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ratio_y = random.uniform(<span class="number">1</span>, max_ratio)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€šè¿‡ç¼©æ”¾ä¸å¹³ç§»å®ç°å¡«å……çš„ç›®çš„</span></span><br><span class="line">    oh = <span class="built_in">int</span>(h * ratio_y)</span><br><span class="line">    ow = <span class="built_in">int</span>(w * ratio_x)</span><br><span class="line">    off_x = random.randint(<span class="number">0</span>, ow - w)</span><br><span class="line">    off_y = random.randint(<span class="number">0</span>, oh - h)</span><br><span class="line"></span><br><span class="line">    out_img = np.zeros((oh, ow, c))</span><br><span class="line">    <span class="keyword">if</span> fill <span class="keyword">and</span> <span class="built_in">len</span>(fill) == c:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(c):</span><br><span class="line">            out_img[:, :, i] = fill[i] * <span class="number">255.0</span></span><br><span class="line"></span><br><span class="line">    out_img[off_y:off_y + h, off_x:off_x + w, :] = img</span><br><span class="line">    gtboxes[:, <span class="number">0</span>] = ((gtboxes[:, <span class="number">0</span>] * w) + off_x) / <span class="built_in">float</span>(ow)</span><br><span class="line">    gtboxes[:, <span class="number">1</span>] = ((gtboxes[:, <span class="number">1</span>] * h) + off_y) / <span class="built_in">float</span>(oh)</span><br><span class="line">    gtboxes[:, <span class="number">2</span>] = gtboxes[:, <span class="number">2</span>] / ratio_x</span><br><span class="line">    gtboxes[:, <span class="number">3</span>] = gtboxes[:, <span class="number">3</span>] / ratio_y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out_img.astype(<span class="string">&#x27;uint8&#x27;</span>), gtboxes <span class="comment"># è¿”å›å¡«å……åçš„å›¾ç‰‡ä¸è¾¹ç•Œæ¡†</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºç¿»è½¬</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_flip</span>(<span class="params">img, gtboxes, thresh=<span class="number">0.5</span></span>):</span><br><span class="line">    <span class="keyword">if</span> random.random() &gt; thresh:</span><br><span class="line">        <span class="comment"># è°ƒæ•´æ­¥é•¿</span></span><br><span class="line">        img = img[:, ::-<span class="number">1</span>, :]</span><br><span class="line">        gtboxes[:, <span class="number">0</span>] = <span class="number">1.0</span> - gtboxes[:, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> img, gtboxes</span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shuffle_gtbox</span>(<span class="params">gtbox, gtlabel</span>):</span><br><span class="line">    gt = np.concatenate([gtbox, gtlabel[:, np.newaxis]], axis=<span class="number">1</span>)</span><br><span class="line">    idx = np.arange(gt.shape[<span class="number">0</span>])</span><br><span class="line">    np.random.shuffle(idx)</span><br><span class="line">    gt = gt[idx, :]</span><br><span class="line">    <span class="keyword">return</span> gt[:, :<span class="number">4</span>], gt[:, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºç¼©æ”¾</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_interp</span>(<span class="params">img, size, interp=<span class="literal">None</span></span>):</span><br><span class="line">    interp_method = [cv2.INTER_NEAREST,   <span class="comment"># æœ€è¿‘é‚»æ’å€¼</span></span><br><span class="line">                    cv2.INTER_LINEAR,     <span class="comment"># çº¿æ€§æ’å€¼</span></span><br><span class="line">                    cv2.INTER_AREA,       <span class="comment"># åŒºåŸŸæ’å€¼</span></span><br><span class="line">                    cv2.INTER_CUBIC,      <span class="comment"># ä¸‰æ¬¡æ ·æ¡æ’å€¼</span></span><br><span class="line">                    cv2.INTER_LANCZOS4]   <span class="comment"># LANCZOS4æ’å€¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éšæœºé€‰æ‹©ç¼©æ”¾æ—¶çš„æ’å€¼æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> interp <span class="keyword">or</span> interp <span class="keyword">not</span> <span class="keyword">in</span> interp_method:</span><br><span class="line">        interp = interp_method[random.randint(<span class="number">0</span>, <span class="built_in">len</span>(interp_method) - <span class="number">1</span>)]</span><br><span class="line">    h, w, _ = img.shape</span><br><span class="line">    im_scale_x = size / <span class="built_in">float</span>(w)</span><br><span class="line">    im_scale_y = size / <span class="built_in">float</span>(h)</span><br><span class="line">    <span class="comment"># è°ƒæ•´å›¾åƒå¤§å°</span></span><br><span class="line">    img = cv2.resize(img, <span class="literal">None</span>, <span class="literal">None</span>, fx=im_scale_x, fy=im_scale_y, interpolation=interp)</span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="comment"># å›¾åƒå¢å¹¿æ–¹æ³•æ±‡æ€»</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_augment</span>(<span class="params">img, gtboxes, gtlabels, size, means=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰</span></span><br><span class="line">    img = random_distort(img)</span><br><span class="line">    <span class="comment"># éšæœºå¡«å……</span></span><br><span class="line">    img, gtboxes = random_expand(img, gtboxes, fill=means)</span><br><span class="line">    <span class="comment"># éšæœºç¼©æ”¾</span></span><br><span class="line">    img = random_interp(img, size)</span><br><span class="line">    <span class="comment"># éšæœºç¿»è½¬</span></span><br><span class="line">    img, gtboxes = random_flip(img, gtboxes)</span><br><span class="line">    <span class="comment"># éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº</span></span><br><span class="line">    gtboxes, gtlabels = shuffle_gtbox(gtboxes, gtlabels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.astype(<span class="string">&#x27;float32&#x27;</span>), gtboxes.astype(<span class="string">&#x27;float32&#x27;</span>), gtlabels.astype(<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_img_data</span>(<span class="params">record, size=<span class="number">640</span></span>):</span><br><span class="line">    img, gt_boxes, gt_labels, scales = get_img_data_from_file(record)</span><br><span class="line">    img, gt_boxes, gt_labels = image_augment(img, gt_boxes, gt_labels, size)</span><br><span class="line">    mean = [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]</span><br><span class="line">    std = [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]</span><br><span class="line">    mean = np.array(mean).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">    std = np.array(std).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">    img = (img / <span class="number">255.0</span> - mean) / std</span><br><span class="line">    img = img.astype(<span class="string">&#x27;float32&#x27;</span>).transpose((<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> img, gt_boxes, gt_labels, scales</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ä¸€ä¸ªæ‰¹æ¬¡å†…æ ·æœ¬éšæœºç¼©æ”¾çš„å°ºå¯¸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_img_size</span>(<span class="params">mode</span>):</span><br><span class="line">    <span class="keyword">if</span> (mode == <span class="string">&#x27;train&#x27;</span>) <span class="keyword">or</span> (mode == <span class="string">&#x27;valid&#x27;</span>):</span><br><span class="line">        inds = np.array([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>])</span><br><span class="line">        ii = np.random.choice(inds)</span><br><span class="line">        img_size = <span class="number">320</span> + ii * <span class="number">32</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img_size = <span class="number">608</span></span><br><span class="line">    <span class="keyword">return</span> img_size</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†listå½¢å¼çš„batchæ•°æ®è½¬åŒ–æˆå¤šä¸ªarrayæ„æˆçš„tuple</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_array</span>(<span class="params">batch_data</span>):</span><br><span class="line">    img_array = np.array([item[<span class="number">0</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype = <span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    gt_box_array = np.array([item[<span class="number">1</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype = <span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    gt_labels_array = np.array([item[<span class="number">2</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype = <span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">    img_scale = np.array([item[<span class="number">3</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype=<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> img_array, gt_box_array, gt_labels_array, img_scale</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ•°æ®è¯»å–ç±»ï¼Œç»§æ‰¿Paddle.io.Dataset</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrainDataset</span>(paddle.io.Dataset):</span><br><span class="line">    <span class="keyword">def</span>  <span class="title function_">__init__</span>(<span class="params">self, datadir, mode=<span class="string">&#x27;train&#x27;</span></span>):</span><br><span class="line">        self.datadir = datadir</span><br><span class="line">        cname2cid = get_insect_names()</span><br><span class="line">        self.records = get_annotations(cname2cid, datadir)</span><br><span class="line">        self.img_size = <span class="number">640</span>  <span class="comment"># get_img_size(mode)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        record = self.records[idx]</span><br><span class="line">        <span class="comment"># print(&quot;print: &quot;, record)</span></span><br><span class="line">        img, gt_bbox, gt_labels, im_shape = get_img_data(record, size=self.img_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img, gt_bbox, gt_labels, np.array(im_shape)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.records)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† listå½¢å¼çš„batchæ•°æ® è½¬åŒ–æˆå¤šä¸ªarrayæ„æˆçš„tuple</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_test_array</span>(<span class="params">batch_data</span>):</span><br><span class="line">    img_name_array = np.array([item[<span class="number">0</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data])</span><br><span class="line">    img_data_array = np.array([item[<span class="number">1</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype = <span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    img_scale_array = np.array([item[<span class="number">2</span>] <span class="keyword">for</span> item <span class="keyword">in</span> batch_data], dtype=<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> img_name_array, img_data_array, img_scale_array</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•æ•°æ®è¯»å–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_data_loader</span>(<span class="params">datadir, batch_size= <span class="number">10</span>, test_image_size=<span class="number">608</span>, mode=<span class="string">&#x27;test&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åŠ è½½æµ‹è¯•ç”¨çš„å›¾ç‰‡ï¼Œæµ‹è¯•æ•°æ®æ²¡æœ‰groundtruthæ ‡ç­¾</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_names = os.listdir(datadir)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reader</span>():</span><br><span class="line">        batch_data = []</span><br><span class="line">        img_size = test_image_size</span><br><span class="line">        <span class="keyword">for</span> image_name <span class="keyword">in</span> image_names:</span><br><span class="line">            file_path = os.path.join(datadir, image_name)</span><br><span class="line">            img = cv2.imread(file_path)</span><br><span class="line">            img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">            H = img.shape[<span class="number">0</span>]</span><br><span class="line">            W = img.shape[<span class="number">1</span>]</span><br><span class="line">            img = cv2.resize(img, (img_size, img_size))</span><br><span class="line"></span><br><span class="line">            mean = [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]</span><br><span class="line">            std = [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]</span><br><span class="line">            mean = np.array(mean).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">            std = np.array(std).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">            out_img = (img / <span class="number">255.0</span> - mean) / std</span><br><span class="line">            out_img = out_img.astype(<span class="string">&#x27;float32&#x27;</span>).transpose((<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            img = out_img <span class="comment">#np.transpose(out_img, (2,0,1))</span></span><br><span class="line">            im_shape = [H, W]</span><br><span class="line"></span><br><span class="line">            batch_data.append((image_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>], img, im_shape))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(batch_data) == batch_size:</span><br><span class="line">                <span class="keyword">yield</span> make_test_array(batch_data)</span><br><span class="line">                batch_data = []</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(batch_data) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">yield</span> make_test_array(batch_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> reader</span><br></pre></td></tr></table></figure>

<pre><code>å¼€å§‹è§£å‹......
è§£å‹å®Œæˆ
</code></pre>
<h1 id="äºŒã€å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3"><a href="#äºŒã€å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3" class="headerlink" title="äºŒã€å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3"></a>äºŒã€å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a><strong>1. æ¦‚è¿°</strong></h2><p>ç»å…¸çš„R-CNNç³»åˆ—ç®—æ³•ä¹Ÿè¢«ç§°ä¸º<strong>ä¸¤é˜¶æ®µç›®æ ‡æ£€æµ‹ç®—æ³•</strong>ï¼Œç”±äºè¿™ç§æ–¹æ³•éœ€è¦<strong>å…ˆäº§ç”Ÿå€™é€‰åŒºåŸŸï¼Œå†å¯¹å€™é€‰åŒºåŸŸåšåˆ†ç±»å’Œä½ç½®åæ ‡çš„é¢„æµ‹</strong>ï¼Œå› æ­¤ç®—æ³•é€Ÿåº¦éå¸¸æ…¢ï¼Œè¿™ç±»ç®—æ³•è¢«ç§°ä¸ºä¸¤é˜¶æ®µç›®æ ‡æ£€æµ‹ç®—æ³•ã€‚ä¸æ­¤å¯¹åº”çš„æ˜¯ä»¥YOLOç®—æ³•ä¸ºä»£è¡¨çš„<strong>å•é˜¶æ®µæ£€æµ‹ç®—æ³•</strong>ï¼Œåªéœ€è¦ä¸€ä¸ªç½‘ç»œå³å¯<strong>åŒæ—¶äº§ç”Ÿå€™é€‰åŒºåŸŸå¹¶é¢„æµ‹å‡ºç‰©ä½“çš„ç±»åˆ«å’Œä½ç½®åæ ‡</strong>ã€‚</p>
<p>ä¸R-CNNç³»åˆ—ç®—æ³•ä¸åŒï¼ŒYOLOv3ä½¿ç”¨å•ä¸ªç½‘ç»œç»“æ„ï¼Œåœ¨äº§ç”Ÿå€™é€‰åŒºåŸŸçš„åŒæ—¶å³å¯é¢„æµ‹å‡ºç‰©ä½“ç±»åˆ«å’Œä½ç½®ï¼Œä¸éœ€è¦åˆ†æˆä¸¤é˜¶æ®µæ¥å®Œæˆæ£€æµ‹ä»»åŠ¡ã€‚å¦å¤–ï¼ŒYOLOv3ç®—æ³•äº§ç”Ÿçš„é¢„æµ‹æ¡†æ•°ç›®æ¯”Faster R-CNNå°‘å¾ˆå¤šã€‚Faster R-CNNä¸­æ¯ä¸ªçœŸå®æ¡†å¯èƒ½å¯¹åº”å¤šä¸ªæ ‡ç­¾ä¸ºæ­£çš„å€™é€‰åŒºåŸŸï¼Œè€ŒYOLOv3é‡Œé¢æ¯ä¸ªçœŸå®æ¡†åªå¯¹åº”ä¸€ä¸ªæ­£çš„å€™é€‰åŒºåŸŸã€‚è¿™äº›ç‰¹æ€§ä½¿å¾—YOLOv3ç®—æ³•å…·æœ‰æ›´å¿«çš„é€Ÿåº¦ï¼Œèƒ½åˆ°è¾¾å®æ—¶å“åº”çš„æ°´å¹³ã€‚</p>
<p>Joseph Redmonç­‰äººåœ¨2015å¹´æå‡ºYOLOï¼ˆYou Only Look Onceï¼ŒYOLOï¼‰ç®—æ³•ï¼Œé€šå¸¸ä¹Ÿè¢«ç§°ä¸ºYOLOv1ï¼›2016å¹´ï¼Œä»–ä»¬å¯¹ç®—æ³•è¿›è¡Œæ”¹è¿›ï¼Œåˆæå‡ºYOLOv2ç‰ˆæœ¬ï¼›2018å¹´å‘å±•å‡ºYOLOv3ç‰ˆæœ¬ã€‚<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/539932517">[YOLOå®¶æ—è¿›åŒ–å²ï¼ˆv1-v7ï¼‰]</a></p>
<h2 id="2-YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³"><a href="#2-YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³" class="headerlink" title="2. YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³"></a><strong>2. YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³</strong></h2><p>YOLOv3ç®—æ³•çš„åŸºæœ¬æ€æƒ³å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<p><strong>åœ¨è®­ç»ƒé˜¶æ®µ</strong>ï¼š</p>
<ol>
<li>æŒ‰ä¸€å®šè§„åˆ™åœ¨å›¾ç‰‡ä¸Šäº§ç”Ÿä¸€ç³»åˆ—çš„å€™é€‰åŒºåŸŸï¼Œç„¶åæ ¹æ®è¿™äº›å€™é€‰åŒºåŸŸä¸å›¾ç‰‡ä¸Šç‰©ä½“çœŸå®æ¡†ä¹‹é—´çš„ä½ç½®å…³ç³»å¯¹å€™é€‰åŒºåŸŸè¿›è¡Œæ ‡æ³¨ã€‚</li>
</ol>
<ul>
<li>è·ŸçœŸå®æ¡†è¶³å¤Ÿæ¥è¿‘çš„é‚£äº›å€™é€‰åŒºåŸŸä¼šè¢«æ ‡æ³¨ä¸ºæ­£æ ·æœ¬ï¼ŒåŒæ—¶å°†çœŸå®æ¡†çš„ä½ç½®ä½œä¸ºæ­£æ ·æœ¬çš„ä½ç½®ç›®æ ‡ã€‚</li>
<li>åç¦»çœŸå®æ¡†è¾ƒå¤§çš„é‚£äº›å€™é€‰åŒºåŸŸåˆ™ä¼šè¢«æ ‡æ³¨ä¸ºè´Ÿæ ·æœ¬ï¼Œè´Ÿæ ·æœ¬ä¸éœ€è¦é¢„æµ‹ä½ç½®æˆ–è€…ç±»åˆ«ã€‚</li>
</ul>
<ol start="2">
<li>ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œæå–å›¾ç‰‡ç‰¹å¾å¹¶å¯¹å€™é€‰åŒºåŸŸçš„ä½ç½®å’Œç±»åˆ«è¿›è¡Œé¢„æµ‹ã€‚è¿™æ ·æ¯ä¸ªé¢„æµ‹æ¡†å°±å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªæ ·æœ¬ï¼Œæ ¹æ®çœŸå®æ¡†ç›¸å¯¹å®ƒçš„ä½ç½®å’Œç±»åˆ«è¿›è¡Œäº†æ ‡æ³¨è€Œè·å¾—æ ‡ç­¾å€¼ï¼Œé€šè¿‡ç½‘ç»œæ¨¡å‹é¢„æµ‹å…¶ä½ç½®å’Œç±»åˆ«ï¼Œå°†ç½‘ç»œé¢„æµ‹å€¼å’Œæ ‡ç­¾å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå°±å¯ä»¥å»ºç«‹èµ·æŸå¤±å‡½æ•°ã€‚</li>
</ol>
<p><strong>åœ¨é¢„æµ‹é˜¶æ®µ</strong>ï¼šè®¡ç®—é¢„æµ‹æ¡†å¾—åˆ†å’Œä½ç½®ï¼Œç„¶åä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶æ¶ˆé™¤é‡åˆè¾ƒå¤§çš„æ¡†ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚</p>
<p>YOLOv3çš„ç®—æ³•æµç¨‹å¦‚ <strong>å›¾1</strong> æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/46fbb2f9d1734a10a79d342dd443a4a0ec9c362af417484a972d7ee9525d0c8c" width = "900"></center>
<center><br>å›¾1ï¼šYOLOv3çš„ç®—æ³•æµç¨‹å›¾</br></center>

<p><br></br></p>
<h2 id="3-YOLOv3æ¨¡å‹è®­ç»ƒ"><a href="#3-YOLOv3æ¨¡å‹è®­ç»ƒ" class="headerlink" title="3. YOLOv3æ¨¡å‹è®­ç»ƒ"></a><strong>3. YOLOv3æ¨¡å‹è®­ç»ƒ</strong></h2><p>æ‹†åˆ†æ¥çœ‹ï¼ŒYOLOv3ç®—æ³•çš„è®­ç»ƒæµç¨‹å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå¦‚ <strong>å›¾2</strong> æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/362b1599a9bf403c982ccf76b6f35d23ead0a520921b4e84a6952181d6692d40" width = "800"></center>
<center><br>å›¾2ï¼šYOLOv3ç®—æ³•è®­ç»ƒæµç¨‹å›¾ </br></center>

<p><br></br></p>
<ul>
<li><strong>å›¾2</strong> å·¦è¾¹æ˜¯è¾“å…¥å›¾ç‰‡ï¼Œä¸ŠåŠéƒ¨åˆ†æ‰€ç¤ºçš„è¿‡ç¨‹æ˜¯ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œå¯¹å›¾ç‰‡æå–ç‰¹å¾ï¼Œéšç€ç½‘ç»œä¸æ–­å‘å‰ä¼ æ’­ï¼Œç‰¹å¾å›¾çš„å°ºå¯¸è¶Šæ¥è¶Šå°ï¼Œæ¯ä¸ªåƒç´ ç‚¹ä¼šä»£è¡¨æ›´åŠ æŠ½è±¡çš„ç‰¹å¾æ¨¡å¼ï¼Œç›´åˆ°è¾“å‡ºç‰¹å¾å›¾ï¼Œå…¶å°ºå¯¸å‡å°ä¸ºåŸå›¾çš„$\frac{1}{32}$ã€‚</li>
<li><strong>å›¾2</strong> ä¸‹åŠéƒ¨åˆ†æè¿°äº†ç”Ÿæˆå€™é€‰åŒºåŸŸçš„è¿‡ç¨‹ï¼Œé¦–å…ˆå°†åŸå›¾åˆ’åˆ†æˆå¤šä¸ªå°æ–¹å—ï¼Œæ¯ä¸ªå°æ–¹å—çš„å¤§å°æ˜¯$32 \times 32$ï¼Œç„¶åä»¥æ¯ä¸ªå°æ–¹å—ä¸ºä¸­å¿ƒåˆ†åˆ«ç”Ÿæˆä¸€ç³»åˆ—é”šæ¡†ï¼Œæ•´å¼ å›¾ç‰‡éƒ½ä¼šè¢«é”šæ¡†è¦†ç›–åˆ°ã€‚åœ¨æ¯ä¸ªé”šæ¡†çš„åŸºç¡€ä¸Šäº§ç”Ÿä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„é¢„æµ‹æ¡†ï¼Œæ ¹æ®é”šæ¡†å’Œé¢„æµ‹æ¡†ä¸å›¾ç‰‡ä¸Šç‰©ä½“çœŸå®æ¡†ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œå¯¹è¿™äº›é¢„æµ‹æ¡†è¿›è¡Œæ ‡æ³¨ã€‚</li>
<li>å°†ä¸Šæ–¹æ”¯è·¯ä¸­è¾“å‡ºçš„ç‰¹å¾å›¾ä¸ä¸‹æ–¹æ”¯è·¯ä¸­äº§ç”Ÿçš„é¢„æµ‹æ¡†æ ‡ç­¾å»ºç«‹å…³è”ï¼Œåˆ›å»ºæŸå¤±å‡½æ•°ï¼Œå¼€å¯ç«¯åˆ°ç«¯çš„è®­ç»ƒè¿‡ç¨‹ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥ä¾æ®ä¸Šé¢çš„å›¾è¿›ä¸€æ­¥å¯¹è®­ç»ƒæµç¨‹è¿›è¡Œæ‹†è§£ï¼Œæ€»ç»“å‡ºå®ç°æ–¹æ¡ˆï¼š</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/0321f37cc92940888349662ad4526c95c3498bfa4a094f44a80650fe4147c5de" width = "800"></center>
<center><br>å›¾3ï¼šè®­ç»ƒæµç¨‹é—®é¢˜æ‹†è§£ </br></center>

<p><br></br></p>
<p>æ¥ä¸‹æ¥å…·ä½“ä»‹ç»æµç¨‹ä¸­å„èŠ‚ç‚¹çš„ç®—æ³•åŸç†ã€‚</p>
<h3 id="3-1-äº§ç”Ÿå€™é€‰åŒºåŸŸ"><a href="#3-1-äº§ç”Ÿå€™é€‰åŒºåŸŸ" class="headerlink" title="3.1 äº§ç”Ÿå€™é€‰åŒºåŸŸ"></a><strong>3.1 äº§ç”Ÿå€™é€‰åŒºåŸŸ</strong></h3><p>å¦‚ä½•äº§ç”Ÿå€™é€‰åŒºåŸŸï¼Œæ˜¯æ£€æµ‹æ¨¡å‹çš„æ ¸å¿ƒè®¾è®¡æ–¹æ¡ˆã€‚ç›®å‰å¤§å¤šæ•°åŸºäºå·ç§¯ç¥ç»ç½‘ç»œçš„æ¨¡å‹æ‰€é‡‡ç”¨çš„æ–¹å¼å¤§ä½“å¦‚ä¸‹ï¼š</p>
<ol>
<li>æŒ‰ä¸€å®šçš„è§„åˆ™åœ¨å›¾ç‰‡ä¸Šç”Ÿæˆä¸€ç³»åˆ—ä½ç½®å›ºå®šçš„é”šæ¡†ï¼Œå°†è¿™äº›é”šæ¡†çœ‹ä½œæ˜¯å¯èƒ½çš„å€™é€‰åŒºåŸŸã€‚</li>
<li>å¯¹é”šæ¡†æ˜¯å¦åŒ…å«ç›®æ ‡ç‰©ä½“è¿›è¡Œé¢„æµ‹ï¼Œå¦‚æœåŒ…å«ç›®æ ‡ç‰©ä½“ï¼Œè¿˜éœ€è¦é¢„æµ‹æ‰€åŒ…å«ç‰©ä½“çš„ç±»åˆ«ï¼Œä»¥åŠé¢„æµ‹æ¡†ç›¸å¯¹äºé”šæ¡†ä½ç½®éœ€è¦è°ƒæ•´çš„å¹…åº¦ã€‚</li>
</ol>
<p><strong>1ï¼‰ç”Ÿæˆé”šæ¡†</strong></p>
<p>å°†åŸå§‹å›¾ç‰‡åˆ’åˆ†æˆ$m\times n$ä¸ªåŒºåŸŸï¼Œå¦‚ <strong>å›¾3</strong> æ‰€ç¤ºï¼ŒåŸå§‹å›¾ç‰‡é«˜åº¦$H&#x3D;640$, å®½åº¦$W&#x3D;480$ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©å°å—åŒºåŸŸçš„å°ºå¯¸ä¸º$32 \times 32$ï¼Œåˆ™$m$å’Œ$n$åˆ†åˆ«ä¸ºï¼š</p>
<p>$$<br>m &#x3D; \frac{640}{32} &#x3D; 20<br>$$</p>
<p>$$<br>n &#x3D; \frac{480}{32} &#x3D; 15<br>$$</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å°†åŸå§‹å›¾åƒåˆ†æˆäº†20è¡Œ15åˆ—å°æ–¹å—åŒºåŸŸã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/2dd1cbeb53644552a8cb38f3f834dbdda5046a489465454d93cdc88d1ce65ca5" width = "400"></center>
<center><br>å›¾4ï¼šå°†å›¾ç‰‡åˆ’åˆ†æˆå¤šä¸ª32x32çš„å°æ–¹å— </br></center>

<p><br></br></p>
<p>YOLOv3ç®—æ³•ä¼šåœ¨æ¯ä¸ªåŒºåŸŸçš„ä¸­å¿ƒï¼Œç”Ÿæˆä¸€ç³»åˆ—é”šæ¡†ã€‚ä¸ºäº†å±•ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä»…åœ¨å›¾ä¸­ç¬¬åè¡Œç¬¬å››åˆ—çš„å°æ–¹å—ä½ç½®é™„è¿‘ç”»å‡ºç”Ÿæˆçš„é”šæ¡†ï¼Œå¦‚ <strong>å›¾5</strong> æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/b9eca2257fc0432d9f59bdecc8d54d144dd590e990f54c6d82f60a1a1531915b" width = "400"></center>
<center><br>å›¾5ï¼šåœ¨ç¬¬10è¡Œç¬¬4åˆ—çš„å°æ–¹å—åŒºåŸŸç”Ÿæˆ3ä¸ªé”šæ¡† </br></center>

<p><br></br></p>
<hr>
<blockquote>
<p><strong>è¯´æ˜ï¼š</strong></p>
<p>è¿™é‡Œä¸ºäº†è·Ÿç¨‹åºä¸­çš„ç¼–å·å¯¹åº”ï¼Œæœ€ä¸Šé¢çš„è¡Œå·æ˜¯ç¬¬0è¡Œï¼Œæœ€å·¦è¾¹çš„åˆ—å·æ˜¯ç¬¬0åˆ—ã€‚</p>
</blockquote>
<hr>
<p><strong>å›¾6</strong> å±•ç¤ºåœ¨æ¯ä¸ªåŒºåŸŸé™„è¿‘éƒ½ç”Ÿæˆ3ä¸ªé”šæ¡†ï¼Œå¾ˆå¤šé”šæ¡†å †å åœ¨ä¸€èµ·å¯èƒ½ä¸å¤ªå®¹æ˜“çœ‹æ¸…æ¥šï¼Œä½†è¿‡ç¨‹è·Ÿä¸Šé¢ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦ä»¥æ¯ä¸ªåŒºåŸŸçš„ä¸­å¿ƒç‚¹ä¸ºä¸­å¿ƒï¼Œåˆ†åˆ«ç”Ÿæˆ3ä¸ªé”šæ¡†ã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/0880c3b5ec2d40edb476f4fcbadd87aa9f37059cd24d4a1a9d37c627ce5f618a" width = "400"></center>
<center><br>å›¾6ï¼šåœ¨æ¯ä¸ªå°æ–¹å—åŒºåŸŸç”Ÿæˆ3ä¸ªé”šæ¡† </br></center>

<p><br></br></p>
<p>åœ¨æ¯ä¸ªå°æ–¹å—åŒºåŸŸéƒ½ç”Ÿæˆä¸‰ä¸ªé”šæ¡†ï¼Œè¿™ä¼šè¦†ç›–æ•´å¼ å›¾ç‰‡ï¼Œåœ¨è¿™å¼ å›¾ç‰‡ä¸Šä¸€å…±ç”Ÿæˆäº†900ä¸ªé”šæ¡†ã€‚</p>
<p><strong>2ï¼‰ç”Ÿæˆé¢„æµ‹æ¡†</strong></p>
<p>åœ¨å‰é¢å·²ç»æŒ‡å‡ºï¼Œé”šæ¡†çš„ä½ç½®éƒ½æ˜¯å›ºå®šå¥½çš„ï¼Œä¸å¯èƒ½åˆšå¥½è·Ÿç‰©ä½“è¾¹ç•Œæ¡†é‡åˆï¼Œéœ€è¦<strong>åœ¨é”šæ¡†çš„åŸºç¡€ä¸Šè¿›è¡Œä½ç½®çš„å¾®è°ƒä»¥ç”Ÿæˆé¢„æµ‹æ¡†</strong>ã€‚é¢„æµ‹æ¡†ç›¸å¯¹äºé”šæ¡†ä¼šæœ‰ä¸åŒçš„ä¸­å¿ƒä½ç½®å’Œå¤§å°ï¼Œé‡‡ç”¨ä»€ä¹ˆæ–¹å¼èƒ½å¾—åˆ°é¢„æµ‹æ¡†å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥è€ƒè™‘å¦‚ä½•ç”Ÿæˆå…¶ä¸­å¿ƒä½ç½®åæ ‡ã€‚</p>
<p>æ¯”å¦‚ä¸Šé¢å›¾ä¸­åœ¨ç¬¬10è¡Œç¬¬4åˆ—çš„å°æ–¹å—åŒºåŸŸä¸­å¿ƒç”Ÿæˆçš„ä¸€ä¸ªé”šæ¡†ï¼Œå¦‚ç»¿è‰²è™šçº¿æ¡†æ‰€ç¤ºã€‚ä»¥å°æ–¹æ ¼çš„å®½åº¦ä¸ºå•ä½é•¿åº¦ï¼Œ</p>
<p>æ­¤å°æ–¹å—åŒºåŸŸå·¦ä¸Šè§’çš„ä½ç½®åæ ‡æ˜¯ï¼š<br>$$<br>c_x &#x3D; 4\<br>c_y &#x3D; 10<br>$$<br>æ­¤é”šæ¡†çš„åŒºåŸŸä¸­å¿ƒåæ ‡æ˜¯ï¼š<br>$$<br>center_x &#x3D; c_x + 0.5 &#x3D; 4.5\<br>center_y &#x3D; c_y + 0.5 &#x3D; 10.5<br>$$<br>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ç”Ÿæˆé¢„æµ‹æ¡†çš„ä¸­å¿ƒåæ ‡ï¼š<br>$$<br>b_x &#x3D; c_x + \sigma(t_x)<br>$$</p>
<p>$$<br>b_y &#x3D; c_y + \sigma(t_y)<br>$$</p>
<p>å…¶ä¸­$t_x$å’Œ$t_y$ä¸ºå®æ•°ï¼Œ$\sigma(x)$æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„Sigmoidå‡½æ•°ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>$$<br>\sigma(x) &#x3D; \frac{1}{1 + exp(-x)}<br>$$<br>ç”±äºSigmoidçš„å‡½æ•°å€¼åœ¨$0 \thicksim 1$ä¹‹é—´ï¼Œå› æ­¤ç”±ä¸Šé¢å…¬å¼è®¡ç®—å‡ºæ¥çš„é¢„æµ‹æ¡†çš„ä¸­å¿ƒç‚¹æ€»æ˜¯è½åœ¨ç¬¬åè¡Œç¬¬å››åˆ—çš„å°åŒºåŸŸå†…éƒ¨ã€‚</p>
<p>å½“$t_x&#x3D;t_y&#x3D;0$æ—¶ï¼Œ$b_x &#x3D; c_x + 0.5$ï¼Œ$b_y &#x3D; c_y + 0.5$ï¼Œé¢„æµ‹æ¡†ä¸­å¿ƒä¸é”šæ¡†ä¸­å¿ƒé‡åˆï¼Œéƒ½æ˜¯å°åŒºåŸŸçš„ä¸­å¿ƒã€‚</p>
<p>é”šæ¡†çš„å¤§å°æ˜¯é¢„å…ˆè®¾å®šå¥½çš„ï¼Œåœ¨æ¨¡å‹ä¸­å¯ä»¥å½“ä½œæ˜¯è¶…å‚æ•°ï¼Œä¸‹å›¾ä¸­ç”»å‡ºçš„é”šæ¡†å°ºå¯¸æ˜¯</p>
<p>$$<br>p_h &#x3D; 350<br>$$</p>
<p>$$<br>p_w &#x3D; 250<br>$$</p>
<p>é€šè¿‡ä¸‹é¢çš„å…¬å¼ç”Ÿæˆé¢„æµ‹æ¡†çš„å¤§å°ï¼š</p>
<p>$$<br>b_h &#x3D; p_h e^{t_h}<br>$$</p>
<p>$$<br>b_w &#x3D; p_w e^{t_w}<br>$$</p>
<p>å¦‚æœ$t_x&#x3D;t_y&#x3D;0, t_h&#x3D;t_w&#x3D;0$ï¼Œåˆ™é¢„æµ‹æ¡†è·Ÿé”šæ¡†é‡åˆã€‚</p>
<p>å¦‚æœç»™$t_x, t_y, t_h, t_w$éšæœºèµ‹å€¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>t_x &#x3D; 0.2,  t_y &#x3D; 0.3, t_w &#x3D; 0.1, t_h &#x3D; -0.12<br>$$<br>åˆ™å¯ä»¥å¾—åˆ°é¢„æµ‹æ¡†çš„åæ ‡æ˜¯(154.98, 357.44, 276.29, 310.42)ï¼Œå¦‚ <strong>å›¾7</strong> ä¸­è“è‰²æ¡†æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/28ae0fbc087e42449cdea6c48ad53f64cffdf66216a646d884ae778f7c341149" width = "400"></center>
<center><br>å›¾7ï¼šç”Ÿæˆé¢„æµ‹æ¡† </br></center>

<p><br></br></p>
<hr>
<blockquote>
<p><strong>è¯´æ˜ï¼š</strong><br>è¿™é‡Œåæ ‡é‡‡ç”¨$xywh$çš„æ ¼å¼ã€‚é¢„æµ‹æ¡†æ˜¯åœ¨é”šæ¡†çš„åŸºç¡€ä¸Šè¿›è¡Œçš„å¾®è°ƒã€‚</p>
</blockquote>
<hr>
<p>è¿™é‡Œæˆ‘ä»¬ä¼šé—®ï¼šå½“$t_x, t_y, t_w, t_h$å–å€¼ä¸ºå¤šå°‘çš„æ—¶å€™ï¼Œé¢„æµ‹æ¡†èƒ½å¤Ÿè·ŸçœŸå®æ¡†é‡åˆï¼Ÿä¸ºäº†å›ç­”é—®é¢˜ï¼Œåªéœ€è¦å°†ä¸Šé¢é¢„æµ‹æ¡†åæ ‡ä¸­çš„$b_x, b_y, b_h, b_w$è®¾ç½®ä¸ºçœŸå®æ¡†çš„ä½ç½®ï¼Œå³å¯æ±‚è§£å‡º$t$çš„æ•°å€¼ã€‚</p>
<p>ä»¤ï¼š<br>$$<br>\sigma(t^*_x) + c_x &#x3D; gt_x<br>$$</p>
<p>$$<br>\sigma(t^*_y) + c_y &#x3D; gt_y<br>$$</p>
<p>$$<br>p_w e^{t^*_w} &#x3D; gt_h<br>$$</p>
<p>$$<br>p_h e^{t^*_h} &#x3D; gt_w<br>$$</p>
<p>å¯ä»¥æ±‚è§£å‡ºï¼š$(t^*_x, t^*_y, t^*_w, t^*_h)$</p>
<p>å¦‚æœ$t$æ˜¯ç½‘ç»œé¢„æµ‹çš„è¾“å‡ºå€¼ï¼Œå°†$t^*$ä½œä¸ºç›®æ ‡å€¼ï¼Œä»¥ä»–ä»¬ä¹‹é—´çš„å·®è·ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œåˆ™å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªå›å½’é—®é¢˜ï¼Œé€šè¿‡å­¦ä¹ ç½‘ç»œå‚æ•°ï¼Œä½¿å¾—$t$è¶³å¤Ÿæ¥è¿‘$t^*$ï¼Œä»è€Œèƒ½å¤Ÿæ±‚è§£å‡ºé¢„æµ‹æ¡†çš„ä½ç½®åæ ‡å’Œå¤§å°ã€‚</p>
<p>é¢„æµ‹æ¡†å¯ä»¥çœ‹ä½œæ˜¯åœ¨é”šæ¡†åŸºç¡€ä¸Šçš„ä¸€ä¸ªå¾®è°ƒï¼Œæ¯ä¸ªé”šæ¡†ä¼šæœ‰ä¸€ä¸ªè·Ÿå®ƒå¯¹åº”çš„é¢„æµ‹æ¡†ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šä¸Šé¢è®¡ç®—å¼ä¸­çš„$t_x, t_y, t_w, t_h$ï¼Œä»è€Œè®¡ç®—å‡ºä¸é”šæ¡†å¯¹åº”çš„é¢„æµ‹æ¡†çš„ä½ç½®å’Œå½¢çŠ¶ã€‚</p>
<p><strong>3ï¼‰æ ‡æ³¨å€™é€‰åŒºåŸŸ</strong></p>
<p>åœ¨YOLOv3ä¸­ï¼Œæ¯ä¸ªåŒºåŸŸä¼šäº§ç”Ÿ3ç§ä¸åŒå½¢çŠ¶çš„é”šæ¡†ï¼Œæ¯ä¸ªé”šæ¡†éƒ½æ˜¯ä¸€ä¸ªå¯èƒ½çš„å€™é€‰åŒºåŸŸï¼Œå¯¹è¿™äº›å€™é€‰åŒºåŸŸæˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>é”šæ¡†æ˜¯å¦åŒ…å«ç‰©ä½“ï¼Œè¿™å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼Œä½¿ç”¨æ ‡ç­¾<code>objectness</code>æ¥è¡¨ç¤ºã€‚</li>
</ul>
<p>å½“é”šæ¡†åŒ…å«äº†ç‰©ä½“æ—¶ï¼Œ<code>objectness=1</code>ï¼Œè¡¨ç¤ºé¢„æµ‹æ¡†å±äºæ­£ç±»ï¼›å½“é”šæ¡†ä¸åŒ…å«ç‰©ä½“æ—¶ï¼Œè®¾ç½®<code>objectness=0</code>ï¼Œè¡¨ç¤ºé”šæ¡†å±äºè´Ÿç±»ï¼›</p>
<p>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œæœ‰äº›é¢„æµ‹æ¡†è·ŸçœŸå®æ¡†ä¹‹é—´çš„IoUå¾ˆå¤§ï¼Œä½†å¹¶ä¸æ˜¯æœ€å¤§çš„é‚£ä¸ªï¼Œé‚£ä¹ˆç›´æ¥å°†å…¶objectnessæ ‡ç­¾è®¾ç½®ä¸º0å½“ä½œè´Ÿæ ·æœ¬ï¼Œå¯èƒ½å¹¶ä¸å¦¥å½“ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒYOLOv3ç®—æ³•è®¾ç½®äº†ä¸€ä¸ªIoUé˜ˆå€¼<code>iou_threshold</code>ï¼Œå½“é¢„æµ‹æ¡†çš„objectnessä¸ä¸º1ï¼Œä½†æ˜¯å…¶ä¸æŸä¸ªçœŸå®æ¡†çš„IoUå¤§äºiou_thresholdæ—¶ï¼Œå°±å°†å…¶objectnessæ ‡ç­¾è®¾ç½®ä¸º-1ï¼Œä¸å‚ä¸æŸå¤±å‡½æ•°çš„è®¡ç®—ã€‚</p>
<ul>
<li><p>å¦‚æœé”šæ¡†åŒ…å«äº†ç‰©ä½“ï¼Œé‚£ä¹ˆå°±éœ€è¦è®¡ç®—å¯¹åº”çš„é¢„æµ‹æ¡†ä¸­å¿ƒä½ç½®å’Œå¤§å°åº”è¯¥æ˜¯å¤šå°‘ï¼Œæˆ–è€…è¯´ä¸Šæ–‡ä¸­çš„$t_x, t_y, t_w, t_h$åº”è¯¥æ˜¯å¤šå°‘ï¼Œä½¿ç”¨<code>location</code>æ ‡ç­¾ã€‚</p>
</li>
<li><p>å¦‚æœé”šæ¡†åŒ…å«äº†ç‰©ä½“ï¼Œé‚£ä¹ˆå°±éœ€è¦è®¡ç®—å…·ä½“ç±»åˆ«æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œä½¿ç”¨å˜é‡<code>label</code>æ¥è¡¨ç¤ºå…¶æ‰€å±ç±»åˆ«çš„æ ‡ç­¾ã€‚</p>
</li>
</ul>
<p>æ€»ç»“èµ·æ¥ï¼Œå¦‚ <strong>å›¾8</strong> æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/3b914be0c6274916bc7abe4922d4d0fb75be340172764f7096af5be0c2737c57" width = "700"></center>
<center><br>å›¾8ï¼šæ ‡æ³¨æµç¨‹ç¤ºæ„å›¾ </br></center>

<p><br></br></p>
<p>é€‰å–ä»»æ„ä¸€ä¸ªé”šæ¡†å¯¹å®ƒè¿›è¡Œæ ‡æ³¨ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ç¡®å®šå…¶å¯¹åº”çš„<code>objectness</code>ï¼Œ<code>(t_x, t_y, t_w, t_h)</code>å’Œ<code>label</code>ï¼Œä¸‹é¢å°†åˆ†åˆ«è®²è¿°å¦‚ä½•ç¡®å®šè¿™ä¸‰ä¸ªæ ‡ç­¾çš„å€¼ã€‚</p>
<br>

<p><strong>â‘ æ ‡æ³¨é”šæ¡†æ˜¯å¦åŒ…å«ç‰©ä½“ï¼ˆobjectnessï¼‰</strong></p>
<p>å¦‚ <strong>å›¾9</strong> æ‰€ç¤ºï¼Œè¿™é‡Œä¸€å…±æœ‰3ä¸ªç›®æ ‡ï¼Œä»¥æœ€å·¦è¾¹çš„äººåƒä¸ºä¾‹ï¼Œå…¶çœŸå®æ¡†æ˜¯$(133.96, 328.42, 186.06, 374.63)$ã€‚<br><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/f21679e68d2b496698ed788a16d4ea2e5bc6f82b253a44ef9508b6a4fc9b6be4" width = "600"></center>
<center><br>å›¾9ï¼šé€‰å‡ºä¸çœŸå®æ¡†ä¸­å¿ƒä½äºåŒä¸€åŒºåŸŸçš„é”šæ¡† </br></center>

<p><br></br></p>
<p>çœŸå®æ¡†çš„ä¸­å¿ƒç‚¹åæ ‡æ˜¯ï¼š</p>
<p>$$<br>center_x &#x3D; 133.96\<br>center_y &#x3D; 328.42\<br>i &#x3D; 133.96 &#x2F; 32 &#x3D; 4.18625\<br>j &#x3D; 328.42 &#x2F; 32 &#x3D; 10.263125<br>$$<br>å®ƒè½åœ¨äº†ç¬¬10è¡Œç¬¬4åˆ—çš„å°æ–¹å—å†…ï¼Œå¦‚<strong>å›¾10</strong>æ‰€ç¤ºã€‚æ­¤å°æ–¹å—åŒºåŸŸå¯ä»¥ç”Ÿæˆ3ä¸ªä¸åŒå½¢çŠ¶çš„é”šæ¡†ï¼Œå…¶åœ¨å›¾ä¸Šçš„ç¼–å·å’Œå¤§å°åˆ†åˆ«æ˜¯$A_1(116, 90), A_2(156, 198), A_3(373, 326)$ã€‚</p>
<p>ç”¨è¿™3ä¸ªä¸åŒå½¢çŠ¶çš„é”šæ¡†è·ŸçœŸå®æ¡†è®¡ç®—IoUï¼Œé€‰å‡ºIoUæœ€å¤§çš„é”šæ¡†ã€‚è¿™é‡Œä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œåªè€ƒè™‘é”šæ¡†çš„å½¢çŠ¶ï¼Œä¸è€ƒè™‘å…¶è·ŸçœŸå®æ¡†ä¸­å¿ƒä¹‹é—´çš„åç§»ï¼Œå…·ä½“è®¡ç®—ç»“æœå¦‚ <strong>å›¾14</strong> æ‰€ç¤ºã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/3008337ea66c44068042c670db54368edc56b1e43ced4b6b811bdc95b64ca3d5" width = "400"></center>
<center><br>å›¾10ï¼šé€‰å‡ºä¸çœŸå®æ¡†ä¸é”šæ¡†çš„IoU </br></center>

<p><br></br></p>
<p>å…¶ä¸­è·ŸçœŸå®æ¡†IoUæœ€å¤§çš„æ˜¯é”šæ¡†$A_3$ï¼Œå½¢çŠ¶æ˜¯$(373, 326)$ï¼Œå°†å®ƒæ‰€å¯¹åº”çš„é¢„æµ‹æ¡†çš„objectnessæ ‡ç­¾è®¾ç½®ä¸º1ï¼Œå…¶æ‰€åŒ…æ‹¬çš„ç‰©ä½“ç±»åˆ«å°±æ˜¯çœŸå®æ¡†é‡Œé¢çš„ç‰©ä½“æ‰€å±ç±»åˆ«ã€‚</p>
<p>ä¾æ¬¡å¯ä»¥æ‰¾å‡ºå…¶ä»–å‡ ä¸ªçœŸå®æ¡†å¯¹åº”çš„IoUæœ€å¤§çš„é”šæ¡†ï¼Œç„¶åå°†å®ƒä»¬çš„é¢„æµ‹æ¡†çš„objectnessæ ‡ç­¾ä¹Ÿéƒ½è®¾ç½®ä¸º1ã€‚è¿™é‡Œä¸€å…±æœ‰$20 \times 15 \times 3 &#x3D; 900$ä¸ªé”šæ¡†ï¼Œåªæœ‰3ä¸ªé¢„æµ‹æ¡†ä¼šè¢«æ ‡æ³¨ä¸ºæ­£ã€‚</p>
<p>ç”±äºæ¯ä¸ªçœŸå®æ¡†åªå¯¹åº”ä¸€ä¸ªobjectnessæ ‡ç­¾ä¸ºæ­£çš„é¢„æµ‹æ¡†ï¼Œå¦‚æœæœ‰äº›é¢„æµ‹æ¡†è·ŸçœŸå®æ¡†ä¹‹é—´çš„IoUå¾ˆå¤§ï¼Œä½†å¹¶ä¸æ˜¯æœ€å¤§çš„é‚£ä¸ªï¼Œé‚£ä¹ˆç›´æ¥å°†å…¶objectnessæ ‡ç­¾è®¾ç½®ä¸º0å½“ä½œè´Ÿæ ·æœ¬ï¼Œå¯èƒ½å¹¶ä¸å¦¥å½“ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒYOLOv3ç®—æ³•è®¾ç½®äº†ä¸€ä¸ªIoUé˜ˆå€¼iou_thresholdï¼Œå½“é¢„æµ‹æ¡†çš„objectnessä¸ä¸º1ï¼Œä½†æ˜¯å…¶ä¸æŸä¸ªçœŸå®æ¡†çš„IoUå¤§äºiou_thresholdæ—¶ï¼Œå°±å°†å…¶objectnessæ ‡ç­¾è®¾ç½®ä¸º-1ï¼Œä¸å‚ä¸æŸå¤±å‡½æ•°çš„è®¡ç®—ã€‚</p>
<p>æ‰€æœ‰å…¶ä»–çš„é¢„æµ‹æ¡†ï¼Œå…¶objectnessæ ‡ç­¾å‡è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºè´Ÿç±»ã€‚</p>
<p>å¯¹äºobjectness&#x3D;1çš„é¢„æµ‹æ¡†ï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®å®šå…¶ä½ç½®å’ŒåŒ…å«ç‰©ä½“çš„å…·ä½“åˆ†ç±»æ ‡ç­¾ï¼Œä½†æ˜¯å¯¹äºobjectness&#x3D;0æˆ–è€…-1çš„é¢„æµ‹æ¡†ï¼Œåˆ™ä¸ç”¨ç®¡ä»–ä»¬çš„ä½ç½®å’Œç±»åˆ«ã€‚</p>
<br>

<p><strong>â‘¡æ ‡æ³¨é¢„æµ‹æ¡†çš„ä½ç½®åæ ‡æ ‡ç­¾ï¼ˆlocationï¼‰</strong></p>
<p>å½“é”šæ¡†objectness&#x3D;1æ—¶ï¼Œéœ€è¦ç¡®å®šé¢„æµ‹æ¡†ä½ç½®ç›¸å¯¹äºå®ƒå¾®è°ƒçš„å¹…åº¦ï¼Œä¹Ÿå°±æ˜¯é”šæ¡†çš„ä½ç½®æ ‡ç­¾ã€‚</p>
<p>åœ¨å‰é¢æˆ‘ä»¬å·²ç»é—®è¿‡è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå½“$t_x, t_y, t_w, t_h$å–å€¼ä¸ºå¤šå°‘çš„æ—¶å€™ï¼Œé¢„æµ‹æ¡†èƒ½å¤Ÿè·ŸçœŸå®æ¡†é‡åˆï¼Ÿå…¶åšæ³•æ˜¯å°†é¢„æµ‹æ¡†åæ ‡ä¸­çš„$b_x, b_y, b_h, b_w$è®¾ç½®ä¸ºçœŸå®æ¡†çš„åæ ‡ï¼Œå³å¯æ±‚è§£å‡º$t$çš„æ•°å€¼ã€‚</p>
<p>ä»¤ï¼š<br>$$<br>\sigma(t^*_x) + c_x &#x3D; gt_x\<br>\sigma(t^*_y) + c_y &#x3D; gt_y\<br>p_w e^{t^*_w} &#x3D; gt_w\<br>p_h e^{t^*_h} &#x3D; gt_h<br>$$<br>å¯¹äº$t_x^*$å’Œ$t_y^*$ï¼Œç”±äºSigmoidçš„åå‡½æ•°ä¸å¥½è®¡ç®—ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨$\sigma(t^*_x)$å’Œ$\sigma(t^*_y)$ä½œä¸ºå›å½’çš„ç›®æ ‡ã€‚</p>
<p>$$<br>d_x^* &#x3D; \sigma(t^*_x) &#x3D; gt_x - c_x\<br>d_y^* &#x3D; \sigma(t^*_y) &#x3D; gt_y - c_y\<br>t^*_w &#x3D; log(\frac{gt_w}{p_w})\<br>t^*_h &#x3D; log(\frac{gt_h}{p_h})<br>$$<br>å¦‚æœ$(t_x, t_y, t_h, t_w)$æ˜¯ç½‘ç»œé¢„æµ‹çš„è¾“å‡ºå€¼ï¼Œå°†$(d_x^*, d_y^*, t_w^*, t_h^*)$ä½œä¸º$(\sigma(t_x), \sigma(t_y), t_h, t_w)$çš„ç›®æ ‡å€¼ï¼Œä»¥å®ƒä»¬ä¹‹é—´çš„å·®è·ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œåˆ™å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªå›å½’é—®é¢˜ï¼Œé€šè¿‡å­¦ä¹ ç½‘ç»œå‚æ•°ï¼Œä½¿å¾—$t$è¶³å¤Ÿæ¥è¿‘$t^*$ï¼Œä»è€Œèƒ½å¤Ÿæ±‚è§£å‡ºé¢„æµ‹æ¡†çš„ä½ç½®ã€‚</p>
<br>

<p><strong>â‘¢æ ‡æ³¨é”šæ¡†åŒ…å«ç‰©ä½“ç±»åˆ«çš„æ ‡ç­¾ï¼ˆlabelï¼‰</strong></p>
<p>å¯¹äºobjectness&#x3D;1çš„é”šæ¡†ï¼Œéœ€è¦ç¡®å®šå…¶å…·ä½“ç±»åˆ«ã€‚æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œobjectnessæ ‡æ³¨ä¸º1çš„é”šæ¡†ï¼Œä¼šæœ‰ä¸€ä¸ªçœŸå®æ¡†è·Ÿå®ƒå¯¹åº”ï¼Œè¯¥é”šæ¡†æ‰€å±ç‰©ä½“ç±»åˆ«ï¼Œå³æ˜¯å…¶æ‰€å¯¹åº”çš„çœŸå®æ¡†åŒ…å«çš„ç‰©ä½“ç±»åˆ«ã€‚è¿™é‡Œä½¿ç”¨one-hotå‘é‡æ¥è¡¨ç¤ºç±»åˆ«æ ‡ç­¾labelã€‚æ¯”å¦‚ä¸€å…±æœ‰10ä¸ªåˆ†ç±»ï¼Œè€ŒçœŸå®æ¡†é‡Œé¢åŒ…å«çš„ç‰©ä½“ç±»åˆ«æ˜¯ç¬¬2ç±»ï¼Œåˆ™labelä¸º$(0,1,0,0,0,0,0,0,0,0)$</p>
<p><strong>4ï¼‰æ ‡æ³¨é”šæ¡†çš„å…·ä½“ç¨‹åº</strong></p>
<p>æœ€åï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªå°æ–¹å—åŒºåŸŸéƒ½ç”Ÿæˆäº†ä¸€ç³»åˆ—çš„é”šæ¡†ä½œä¸ºå€™é€‰åŒºåŸŸï¼Œå¹¶ä¸”æ ¹æ®å›¾ç‰‡ä¸ŠçœŸå®ç‰©ä½“çš„ä½ç½®ï¼Œæ ‡æ³¨å‡ºäº†æ¯ä¸ªå€™é€‰åŒºåŸŸå¯¹åº”çš„objectnessæ ‡ç­¾ã€ä½ç½®éœ€è¦è°ƒæ•´çš„å¹…åº¦ä»¥åŠåŒ…å«çš„ç‰©ä½“æ‰€å±çš„ç±»åˆ«ã€‚ä½ç½®éœ€è¦è°ƒæ•´çš„å¹…åº¦ç”±4ä¸ªå˜é‡æè¿°$(t_x, t_y, t_w, t_h)$ï¼Œobjectnessæ ‡ç­¾éœ€è¦ç”¨ä¸€ä¸ªå˜é‡æè¿°$obj$ï¼Œæè¿°æ‰€å±ç±»åˆ«çš„å˜é‡é•¿åº¦ç­‰äºç±»åˆ«æ•°Cã€‚</p>
<p>å¯¹äºæ¯ä¸ªé”šæ¡†ï¼Œæ¨¡å‹éœ€è¦é¢„æµ‹è¾“å‡º$(t_x, t_y, t_w, t_h, P_{obj}, P_1, P_2,â€¦ , P_C)$ï¼Œå…¶ä¸­$P_{obj}$æ˜¯é”šæ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡ï¼Œ$P_1, P_2,â€¦ , P_C$åˆ™æ˜¯é”šæ¡†åŒ…å«çš„ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ‡æ³¨é¢„æµ‹æ¡†çš„objectness</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_objectness_label</span>(<span class="params">img, gt_boxes, gt_labels, iou_threshold = <span class="number">0.7</span>,</span></span><br><span class="line"><span class="params">                         anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span></span><br><span class="line"><span class="params">                         num_classes=<span class="number">7</span>, downsample=<span class="number">32</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    imgï¼šæ˜¯è¾“å…¥çš„å›¾åƒæ•°æ®ï¼Œå½¢çŠ¶æ˜¯[N, C, H, W]</span></span><br><span class="line"><span class="string">    gt_boxesï¼šçœŸå®æ¡†ï¼Œç»´åº¦æ˜¯[N, 50, 4]ï¼Œå…¶ä¸­50æ˜¯çœŸå®æ¡†æ•°ç›®çš„ä¸Šé™ï¼ŒçœŸå®æ¡†åæ ‡æ ¼å¼æ˜¯xywhï¼Œè¿™é‡Œä½¿ç”¨ç›¸å¯¹å€¼</span></span><br><span class="line"><span class="string">    gt_labelsï¼šçœŸå®æ¡†æ‰€å±ç±»åˆ«ï¼Œç»´åº¦æ˜¯[N, 50]</span></span><br><span class="line"><span class="string">    iou_thresholdï¼šå½“é¢„æµ‹æ¡†ä¸çœŸå®æ¡†çš„iouå¤§äºiou_thresholdæ—¶ä¸å°†å…¶çœ‹ä½œæ˜¯è´Ÿæ ·æœ¬</span></span><br><span class="line"><span class="string">    anchorsï¼šé”šæ¡†å¯é€‰çš„å°ºå¯¸</span></span><br><span class="line"><span class="string">    anchor_masksï¼šé€šè¿‡ä¸anchorsä¸€èµ·ç¡®å®šæœ¬å±‚çº§çš„ç‰¹å¾å›¾åº”è¯¥é€‰ç”¨å¤šå¤§å°ºå¯¸çš„é”šæ¡†</span></span><br><span class="line"><span class="string">    num_classesï¼šç±»åˆ«æ•°ç›®</span></span><br><span class="line"><span class="string">    downsampleï¼šç‰¹å¾å›¾ç›¸å¯¹äºè¾“å…¥ç½‘ç»œçš„å›¾ç‰‡å°ºå¯¸å˜åŒ–çš„æ¯”ä¾‹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    img_shape = img.shape</span><br><span class="line">    batchsize = img_shape[<span class="number">0</span>]</span><br><span class="line">    num_anchors = <span class="built_in">len</span>(anchors) // <span class="number">2</span>		<span class="comment"># é”šæ¡†çš„æ•°ç›®</span></span><br><span class="line">    input_h = img_shape[<span class="number">2</span>]</span><br><span class="line">    input_w = img_shape[<span class="number">3</span>]</span><br><span class="line">    <span class="comment"># å°†è¾“å…¥å›¾ç‰‡åˆ’åˆ†æˆnum_rows x num_colsä¸ªå°æ–¹å—åŒºåŸŸï¼Œæ¯ä¸ªå°æ–¹å—çš„è¾¹é•¿æ˜¯ downsample</span></span><br><span class="line">    <span class="comment"># è®¡ç®—ä¸€å…±æœ‰å¤šå°‘è¡Œå°æ–¹å—</span></span><br><span class="line">    num_rows = input_h // downsample</span><br><span class="line">    <span class="comment"># è®¡ç®—ä¸€å…±æœ‰å¤šå°‘åˆ—å°æ–¹å—</span></span><br><span class="line">    num_cols = input_w // downsample</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹è±¡æ ‡ç­¾ 3ä¸ª</span></span><br><span class="line">    label_objectness = np.zeros([batchsize, num_anchors, num_rows, num_cols])</span><br><span class="line">    <span class="comment"># ç±»åˆ«æ ‡ç­¾ æ¯ä¸ªé”šæ¡†7ä¸ªç±»åˆ«</span></span><br><span class="line">    label_classification = np.zeros([batchsize, num_anchors, num_classes, num_rows, num_cols])</span><br><span class="line">    <span class="comment"># ä½ç½®åæ ‡æ ‡ç­¾ æ¯ä¸ªé”šæ¡†å¯¹åº”4ä¸ªåæ ‡å€¼</span></span><br><span class="line">    label_location = np.zeros([batchsize, num_anchors, <span class="number">4</span>, num_rows, num_cols])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”¨æ¥è°ƒèŠ‚ä¸åŒå°ºå¯¸çš„é”šæ¡†å¯¹æŸå¤±å‡½æ•°çš„è´¡çŒ®ï¼Œä½œä¸ºåŠ æƒç³»æ•°å’Œä½ç½®æŸå¤±å‡½æ•°ç›¸ä¹˜</span></span><br><span class="line">    scale_location = np.ones([batchsize, num_anchors, num_rows, num_cols])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹batchsizeè¿›è¡Œå¾ªç¯ï¼Œä¾æ¬¡å¤„ç†æ¯å¼ å›¾ç‰‡</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(batchsize):</span><br><span class="line">        <span class="comment"># å¯¹å›¾ç‰‡ä¸Šçš„çœŸå®æ¡†è¿›è¡Œå¾ªç¯ï¼Œä¾æ¬¡æ‰¾å‡ºè·ŸçœŸå®æ¡†å½¢çŠ¶æœ€åŒ¹é…çš„é”šæ¡†</span></span><br><span class="line">        <span class="keyword">for</span> n_gt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(gt_boxes[n])):</span><br><span class="line">            gt = gt_boxes[n][n_gt] <span class="comment"># çœŸå®æ¡†</span></span><br><span class="line">            gt_cls = gt_labels[n][n_gt] <span class="comment"># çœŸå®æ¡†æ‰€å±ç±»åˆ«</span></span><br><span class="line">            gt_center_x = gt[<span class="number">0</span>]</span><br><span class="line">            gt_center_y = gt[<span class="number">1</span>]</span><br><span class="line">            gt_width = gt[<span class="number">2</span>]</span><br><span class="line">            gt_height = gt[<span class="number">3</span>]</span><br><span class="line">            <span class="keyword">if</span> (gt_width &lt; <span class="number">1e-3</span>) <span class="keyword">or</span> (gt_height &lt; <span class="number">1e-3</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            i = <span class="built_in">int</span>(gt_center_y * num_rows)</span><br><span class="line">            j = <span class="built_in">int</span>(gt_center_x * num_cols)</span><br><span class="line">            ious = []</span><br><span class="line">            <span class="keyword">for</span> ka <span class="keyword">in</span> <span class="built_in">range</span>(num_anchors):</span><br><span class="line">                bbox1 = [<span class="number">0.</span>, <span class="number">0.</span>, <span class="built_in">float</span>(gt_width), <span class="built_in">float</span>(gt_height)] <span class="comment"># çœŸå®æ¡†</span></span><br><span class="line">                anchor_w = anchors[ka * <span class="number">2</span>]</span><br><span class="line">                anchor_h = anchors[ka * <span class="number">2</span> + <span class="number">1</span>]</span><br><span class="line">                bbox2 = [<span class="number">0.</span>, <span class="number">0.</span>, anchor_w/<span class="built_in">float</span>(input_w), anchor_h/<span class="built_in">float</span>(input_h)] <span class="comment"># é”šæ¡†</span></span><br><span class="line">                <span class="comment"># è®¡ç®—iou</span></span><br><span class="line">                iou = box_iou_xywh(bbox1, bbox2)</span><br><span class="line">                ious.append(iou)</span><br><span class="line">            ious = np.array(ious)</span><br><span class="line">            inds = np.argsort(ious) <span class="comment"># ç”ŸæˆæŠŠiousä»å°åˆ°å¤§æ’åºåçš„ç´¢å¼•</span></span><br><span class="line">            k = inds[-<span class="number">1</span>]</span><br><span class="line">            label_objectness[n, k, i, j] = <span class="number">1</span></span><br><span class="line">            c = gt_cls</span><br><span class="line">            label_classification[n, k, c, i, j] = <span class="number">1.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># for those prediction bbox with objectness =1, set label of location</span></span><br><span class="line">            dx_label = gt_center_x * num_cols - j</span><br><span class="line">            dy_label = gt_center_y * num_rows - i</span><br><span class="line">            dw_label = np.log(gt_width * input_w / anchors[k*<span class="number">2</span>])</span><br><span class="line">            dh_label = np.log(gt_height * input_h / anchors[k*<span class="number">2</span> + <span class="number">1</span>])</span><br><span class="line">            label_location[n, k, <span class="number">0</span>, i, j] = dx_label</span><br><span class="line">            label_location[n, k, <span class="number">1</span>, i, j] = dy_label</span><br><span class="line">            label_location[n, k, <span class="number">2</span>, i, j] = dw_label</span><br><span class="line">            label_location[n, k, <span class="number">3</span>, i, j] = dh_label</span><br><span class="line">            <span class="comment"># scale_locationç”¨æ¥è°ƒèŠ‚ä¸åŒå°ºå¯¸çš„é”šæ¡†å¯¹æŸå¤±å‡½æ•°çš„è´¡çŒ®ï¼Œä½œä¸ºåŠ æƒç³»æ•°å’Œä½ç½®æŸå¤±å‡½æ•°ç›¸ä¹˜</span></span><br><span class="line">            scale_location[n, k, i, j] = <span class="number">2.0</span> - gt_width * gt_height <span class="comment"># scales--&gt;(h, w)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç›®å‰æ ¹æ®æ¯å¼ å›¾ç‰‡ä¸Šæ‰€æœ‰å‡ºç°è¿‡çš„gt_boxï¼Œéƒ½æ ‡æ³¨å‡ºäº†objectnessä¸ºæ­£çš„é¢„æµ‹æ¡†ï¼Œå‰©ä¸‹çš„é¢„æµ‹æ¡†åˆ™é»˜è®¤objectnessä¸º0</span></span><br><span class="line">    <span class="comment"># å¯¹äºobjectnessä¸º1çš„é¢„æµ‹æ¡†ï¼Œæ ‡å‡ºäº†ä»–ä»¬æ‰€åŒ…å«çš„ç‰©ä½“ç±»åˆ«ï¼Œä»¥åŠä½ç½®å›å½’çš„ç›®æ ‡</span></span><br><span class="line">    <span class="keyword">return</span> label_objectness.astype(<span class="string">&#x27;float32&#x27;</span>), \</span><br><span class="line">            label_location.astype(<span class="string">&#x27;float32&#x27;</span>), \</span><br><span class="line">            label_classification.astype(<span class="string">&#x27;float32&#x27;</span>),\</span><br><span class="line">            scale_location.astype(<span class="string">&#x27;float32&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—IoUï¼ŒçŸ©å½¢æ¡†çš„åæ ‡å½¢å¼ä¸ºxywh</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">box_iou_xywh</span>(<span class="params">box1, box2</span>):</span><br><span class="line">    x1min, y1min = box1[<span class="number">0</span>] - box1[<span class="number">2</span>]/<span class="number">2.0</span>, box1[<span class="number">1</span>] - box1[<span class="number">3</span>]/<span class="number">2.0</span></span><br><span class="line">    x1max, y1max = box1[<span class="number">0</span>] + box1[<span class="number">2</span>]/<span class="number">2.0</span>, box1[<span class="number">1</span>] + box1[<span class="number">3</span>]/<span class="number">2.0</span></span><br><span class="line">    s1 = box1[<span class="number">2</span>] * box1[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    x2min, y2min = box2[<span class="number">0</span>] - box2[<span class="number">2</span>]/<span class="number">2.0</span>, box2[<span class="number">1</span>] - box2[<span class="number">3</span>]/<span class="number">2.0</span></span><br><span class="line">    x2max, y2max = box2[<span class="number">0</span>] + box2[<span class="number">2</span>]/<span class="number">2.0</span>, box2[<span class="number">1</span>] + box2[<span class="number">3</span>]/<span class="number">2.0</span></span><br><span class="line">    s2 = box2[<span class="number">2</span>] * box2[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    xmin = np.maximum(x1min, x2min)</span><br><span class="line">    ymin = np.maximum(y1min, y2min)</span><br><span class="line">    xmax = np.minimum(x1max, x2max)</span><br><span class="line">    ymax = np.minimum(y1max, y2max)</span><br><span class="line">    inter_h = np.maximum(ymax - ymin, <span class="number">0.</span>)</span><br><span class="line">    inter_w = np.maximum(xmax - xmin, <span class="number">0.</span>)</span><br><span class="line">    intersection = inter_h * inter_w</span><br><span class="line"></span><br><span class="line">    union = s1 + s2 - intersection</span><br><span class="line">    iou = intersection / union</span><br><span class="line">    <span class="keyword">return</span> iou </span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TRAINDIR = <span class="string">&#x27;/home/aistudio/work/insects/train&#x27;</span></span><br><span class="line">TESTDIR = <span class="string">&#x27;/home/aistudio/work/insects/test&#x27;</span></span><br><span class="line">VALIDDIR = <span class="string">&#x27;/home/aistudio/work/insects/val&#x27;</span></span><br><span class="line">train_dataset = TrainDataset(TRAINDIR, mode=<span class="string">&#x27;train&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–æ•°æ®</span></span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line">reader = paddle.io.DataLoader(</span><br><span class="line">                            train_dataset, </span><br><span class="line">                            batch_size=<span class="number">2</span>, </span><br><span class="line">                            shuffle=<span class="literal">True</span>, </span><br><span class="line">                            num_workers=<span class="number">1</span>, </span><br><span class="line">                            drop_last=<span class="literal">True</span>)</span><br><span class="line">img, gt_boxes, gt_labels, im_shape = <span class="built_in">next</span>(reader())</span><br><span class="line">img, gt_boxes, gt_labels, im_shape = img.numpy(), gt_boxes.numpy(), gt_labels.numpy(), im_shape.numpy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—å‡ºé”šæ¡†å¯¹åº”çš„æ ‡ç­¾</span></span><br><span class="line">label_objectness, \</span><br><span class="line">label_location, \</span><br><span class="line">label_classification, \</span><br><span class="line">scale_location \</span><br><span class="line">= get_objectness_label(img, gt_boxes, gt_labels, </span><br><span class="line">                        iou_threshold = <span class="number">0.7</span>,</span><br><span class="line">                        anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span><br><span class="line">                        num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img.shape, gt_boxes.shape, gt_labels.shape, im_shape.shape</span><br></pre></td></tr></table></figure>


<pre><code>((2, 3, 640, 640), (2, 50, 4), (2, 50), (2, 2))
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (æ‰¹é‡ï¼Œé”šæ¡†æ•°ï¼Œåç§»é‡/ç±»åˆ«æ•°ï¼Œhï¼Œw)</span></span><br><span class="line">label_objectness.shape, label_location.shape, label_classification.shape, scale_location.shape</span><br></pre></td></tr></table></figure>


<pre><code>((2, 3, 20, 20), (2, 3, 4, 20, 20), (2, 3, 7, 20, 20), (2, 3, 20, 20))
</code></pre>
<p>ä¸Šé¢çš„ç¨‹åºå®ç°äº†å¯¹é”šæ¡†è¿›è¡Œæ ‡æ³¨ï¼Œå¯¹äºæ¯ä¸ªçœŸå®æ¡†ï¼Œé€‰å‡ºäº†ä¸å®ƒå½¢çŠ¶æœ€åŒ¹é…çš„é”šæ¡†ï¼Œå°†å…¶objectnessæ ‡æ³¨ä¸º1ï¼Œå¹¶ä¸”å°†$[d_x^*, d_y^*, t_h^*, t_w^*]$ä½œä¸ºæ­£æ ·æœ¬ä½ç½®çš„æ ‡ç­¾ï¼ŒçœŸå®æ¡†åŒ…å«çš„ç‰©ä½“ç±»åˆ«ä½œä¸ºé”šæ¡†çš„ç±»åˆ«ã€‚è€Œå…¶ä½™çš„é”šæ¡†ï¼Œobjectnesså°†è¢«æ ‡æ³¨ä¸º0ï¼Œæ— éœ€æ ‡æ³¨å‡ºä½ç½®å’Œç±»åˆ«çš„æ ‡ç­¾ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œè¿˜é—ç•™ä¸€ä¸ªå°é—®é¢˜ï¼Œå‰é¢æˆ‘ä»¬è¯´äº†å¯¹äºä¸çœŸå®æ¡†IoUè¾ƒå¤§çš„é‚£äº›é”šæ¡†ï¼Œéœ€è¦å°†å…¶objectnessæ ‡æ³¨ä¸º-1ï¼Œä¸å‚ä¸æŸå¤±å‡½æ•°çš„è®¡ç®—ã€‚æˆ‘ä»¬å…ˆå°†è¿™ä¸ªé—®é¢˜æ”¾ä¸€æ”¾ï¼Œç­‰åˆ°åé¢å»ºç«‹æŸå¤±å‡½æ•°çš„æ—¶å€™å†è¡¥ä¸Šã€‚</p>
<h3 id="3-2-å·ç§¯ç½‘ç»œæå–ç‰¹å¾"><a href="#3-2-å·ç§¯ç½‘ç»œæå–ç‰¹å¾" class="headerlink" title="3.2 å·ç§¯ç½‘ç»œæå–ç‰¹å¾"></a><strong>3.2 å·ç§¯ç½‘ç»œæå–ç‰¹å¾</strong></h3><p>åœ¨ä¸Šä¸€èŠ‚å›¾åƒåˆ†ç±»çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡äº†é€šè¿‡å·ç§¯ç¥ç»ç½‘ç»œæå–å›¾åƒç‰¹å¾ã€‚é€šè¿‡è¿ç»­ä½¿ç”¨å¤šå±‚å·ç§¯å’Œæ± åŒ–ç­‰æ“ä½œï¼Œèƒ½å¾—åˆ°è¯­ä¹‰å«ä¹‰æ›´åŠ ä¸°å¯Œçš„ç‰¹å¾å›¾ã€‚åœ¨æ£€æµ‹é—®é¢˜ä¸­ï¼Œä¹Ÿä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œé€å±‚æå–å›¾åƒç‰¹å¾ï¼Œé€šè¿‡æœ€ç»ˆçš„è¾“å‡ºç‰¹å¾å›¾æ¥è¡¨å¾ç‰©ä½“ä½ç½®å’Œç±»åˆ«ç­‰ä¿¡æ¯ã€‚</p>
<p><strong>éª¨å¹²ç½‘ç»œ[backbone]</strong></p>
<p>YOLOv3ç®—æ³•ä½¿ç”¨çš„éª¨å¹²ç½‘ç»œæ˜¯<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_48167570/article/details/120688156">Darknet53</a>ã€‚Darknet53ç½‘ç»œçš„å…·ä½“ç»“æ„å¦‚ <strong>å›¾11</strong> æ‰€ç¤ºï¼š</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/d5cb1e88d3f44259be1427a90ee454a57738ee8083ad40269f5485988526f30d" width = "400"></center>
<center><br>å›¾11ï¼šDarknet53ç½‘ç»œç»“æ„ </br></center>

<p><br></br></p>
<p>åœ¨æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œå°†å›¾ä¸­C0åé¢çš„å¹³å‡æ± åŒ–ã€å…¨è¿æ¥å±‚å’ŒSoftmaxå»æ‰ï¼Œä¿ç•™ä»è¾“å…¥åˆ°C0éƒ¨åˆ†çš„ç½‘ç»œç»“æ„ï¼Œä½œä¸ºæ£€æµ‹æ¨¡å‹çš„åŸºç¡€ç½‘ç»œç»“æ„ï¼Œä¹Ÿç§°ä¸ºéª¨å¹²ç½‘ç»œã€‚YOLOv3æ¨¡å‹ä¼šåœ¨éª¨å¹²ç½‘ç»œçš„åŸºç¡€ä¸Šï¼Œå†æ·»åŠ æ£€æµ‹ç›¸å…³çš„ç½‘ç»œæ¨¡å—ã€‚</p>
<hr>
<blockquote>
<ul>
<li><strong>åè¯è§£é‡Š</strong>ï¼šç‰¹å¾å›¾çš„æ­¥å¹…</li>
</ul>
<p>åœ¨æå–ç‰¹å¾çš„è¿‡ç¨‹ä¸­é€šå¸¸ä¼šä½¿ç”¨æ­¥å¹…å¤§äº1çš„å·ç§¯æˆ–è€…æ± åŒ–ï¼Œå¯¼è‡´åé¢çš„ç‰¹å¾å›¾å°ºå¯¸è¶Šæ¥è¶Šå°ï¼Œ<strong>ç‰¹å¾å›¾çš„æ­¥å¹…ç­‰äºè¾“å…¥å›¾ç‰‡å°ºå¯¸é™¤ä»¥ç‰¹å¾å›¾å°ºå¯¸</strong>ã€‚</p>
<p>ä¾‹å¦‚ï¼šC0çš„å°ºå¯¸æ˜¯$20\times20$ï¼ŒåŸå›¾å°ºå¯¸æ˜¯$640\times640$ï¼Œåˆ™C0çš„æ­¥å¹…æ˜¯$\frac{640}{20}&#x3D;32$ã€‚åŒç†ï¼ŒC1çš„æ­¥å¹…æ˜¯16ï¼ŒC2çš„æ­¥å¹…æ˜¯8ã€‚</p>
</blockquote>
<hr>
<p>ä¸‹é¢çš„ç¨‹åºæ˜¯Darknet53éª¨å¹²ç½‘ç»œçš„å®ç°ä»£ç ï¼Œè¿™é‡Œå°†ä¸Šå›¾ä¸­C0ã€C1ã€C2æ‰€è¡¨ç¤ºçš„è¾“å‡ºæ•°æ®å–å‡ºï¼Œå¹¶æŸ¥çœ‹å®ƒä»¬çš„å½¢çŠ¶åˆ†åˆ«æ˜¯ï¼Œ$C0 [1, 1024, 20, 20]$ï¼Œ$C1 [1, 512, 40, 40]$ï¼Œ$C2 [1, 256, 80, 80]$ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"><span class="keyword">import</span> paddle.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å·ç§¯å’Œæ‰¹å½’ä¸€åŒ–å°è£…ä¸ºConvBNLayerï¼Œæ–¹ä¾¿åç»­å¤ç”¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConvBNLayer</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ch_in, ch_out, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, groups=<span class="number">1</span>, padding=<span class="number">0</span>, act=<span class="string">&quot;leaky&quot;</span></span>):</span><br><span class="line">        <span class="comment"># actä¸ºæ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="comment"># kernel_size=3 è¡¨ç¤ºä½¿ç”¨äº†3Ã—3çš„å·ç§¯æ ¸</span></span><br><span class="line">        <span class="comment"># stride=1 è¡¨ç¤ºæ­¥å¹…ä¸º1</span></span><br><span class="line">        <span class="built_in">super</span>(ConvBNLayer, self).__init__()</span><br><span class="line">        <span class="comment"># åˆ›å»ºå·ç§¯å±‚</span></span><br><span class="line">        self.conv = paddle.nn.Conv2D(</span><br><span class="line">            in_channels=ch_in,</span><br><span class="line">            out_channels=ch_out,</span><br><span class="line">            kernel_size=kernel_size,</span><br><span class="line">            stride=stride,</span><br><span class="line">            padding=padding,</span><br><span class="line">            groups=groups,</span><br><span class="line">            <span class="comment"># éšæœºæ­£æ€ï¼ˆé«˜æ–¯ï¼‰åˆ†å¸ƒåˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line">            weight_attr=paddle.ParamAttr(initializer=paddle.nn.initializer.Normal(<span class="number">0.</span>, <span class="number">0.02</span>)),</span><br><span class="line">            bias_attr=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># åˆ›å»ºæ‰¹å½’ä¸€åŒ–å±‚</span></span><br><span class="line">        self.batch_norm = paddle.nn.BatchNorm2D(</span><br><span class="line">            num_features=ch_out,</span><br><span class="line">            weight_attr=paddle.ParamAttr(</span><br><span class="line">                <span class="comment"># å°†å‚æ•°éšæœºåˆå§‹åŒ–</span></span><br><span class="line">                initializer=paddle.nn.initializer.Normal(<span class="number">0.</span>, <span class="number">0.02</span>),</span><br><span class="line">                <span class="comment"># L2 æƒé‡è¡°å‡æ­£åˆ™åŒ–ï¼Œé»˜è®¤æ­£åˆ™åŒ–ç³»æ•°ä¸º0.</span></span><br><span class="line">                regularizer=paddle.regularizer.L2Decay(<span class="number">0.</span>)),</span><br><span class="line">            bias_attr=paddle.ParamAttr(</span><br><span class="line">                initializer=paddle.nn.initializer.Constant(<span class="number">0.0</span>),</span><br><span class="line">                regularizer=paddle.regularizer.L2Decay(<span class="number">0.</span>)))</span><br><span class="line">        self.act = act</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):	<span class="comment"># è¾“å…¥ä¼ å…¥</span></span><br><span class="line">        out = self.conv(inputs)	<span class="comment"># å·ç§¯</span></span><br><span class="line">        out = self.batch_norm(out)	<span class="comment"># æ‰¹é‡å½’ä¸€åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> self.act == <span class="string">&#x27;leaky&#x27;</span>:</span><br><span class="line">            out = F.leaky_relu(x=out, negative_slope=<span class="number">0.1</span>)	<span class="comment"># æ”¾å…¥æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> out	<span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸‹é‡‡æ ·æ¨¡å—ï¼Œä½¿å›¾ç‰‡å°ºå¯¸å‡åŠï¼Œæ¯æ¬¡è¿è¡Œå®Œåé«˜å®½å‡åŠ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownSample</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 ch_in,</span></span><br><span class="line"><span class="params">                 ch_out,</span></span><br><span class="line"><span class="params">                 kernel_size=<span class="number">3</span>,</span></span><br><span class="line"><span class="params">                 stride=<span class="number">2</span>,</span></span><br><span class="line"><span class="params">                 padding=<span class="number">1</span></span>):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>(DownSample, self).__init__()</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ stride=2 çš„å·ç§¯ï¼Œå¯ä»¥ä½¿å›¾ç‰‡å°ºå¯¸å‡åŠ</span></span><br><span class="line">        self.conv_bn_layer = ConvBNLayer(</span><br><span class="line">            ch_in=ch_in,</span><br><span class="line">            ch_out=ch_out,</span><br><span class="line">            kernel_size=kernel_size,</span><br><span class="line">            stride=stride,</span><br><span class="line">            padding=padding)</span><br><span class="line">        self.ch_out = ch_out</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        out = self.conv_bn_layer(inputs)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ®‹å·®å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicBlock</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;	</span></span><br><span class="line"><span class="string">    åŸºæœ¬æ®‹å·®å—çš„å®šä¹‰ï¼Œè¾“å…¥xç»è¿‡ä¸¤å±‚å·ç§¯ï¼Œç„¶åæ¥ç¬¬äºŒå±‚å·ç§¯çš„è¾“å‡ºå’Œè¾“å…¥xç›¸åŠ </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ch_in, ch_out</span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicBlock, self).__init__()</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªå·ç§¯å±‚</span></span><br><span class="line">        self.conv1 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_in,</span><br><span class="line">            ch_out=ch_out,</span><br><span class="line">            kernel_size=<span class="number">1</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªå·ç§¯å±‚</span></span><br><span class="line">        self.conv2 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out,</span><br><span class="line">            ch_out=ch_out*<span class="number">2</span>,	<span class="comment"># è¾“å‡ºé€šé“Ã—2</span></span><br><span class="line">            kernel_size=<span class="number">3</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        conv1 = self.conv1(inputs)</span><br><span class="line">        conv2 = self.conv2(conv1)</span><br><span class="line">        <span class="comment"># å°†ç¬¬äºŒä¸ªå·ç§¯å±‚çš„è¾“å‡ºå’Œæœ€åˆçš„è¾“å…¥å€¼æŒ‰å…ƒç´ å¯¹åº”ä½ç½®ç›¸åŠ ï¼ˆå‰æï¼šå½¢çŠ¶ä¸å˜ï¼‰</span></span><br><span class="line">        out = paddle.add(x=inputs, y=conv2)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å¤šä¸ªæ®‹å·®å—å°è£…ä¸ºä¸€ä¸ªå±‚çº§ï¼Œæ–¹ä¾¿åç»­å¤ç”¨     </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LayerWarp</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ·»åŠ å¤šå±‚ï¼ˆcountï¼‰æ®‹å·®å—ï¼Œç»„æˆDarknet53ç½‘ç»œçš„ä¸€ä¸ªå±‚çº§</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ch_in, ch_out, count, is_test=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(LayerWarp,self).__init__()</span><br><span class="line">        self.basicblock0 = BasicBlock(ch_in, ch_out)</span><br><span class="line">        self.res_out_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, count):</span><br><span class="line">            <span class="comment"># ä½¿ç”¨add_sublayeræ·»åŠ å­å±‚</span></span><br><span class="line">            res_out = self.add_sublayer(<span class="string">&quot;basic_block_%d&quot;</span> % (i),</span><br><span class="line">                BasicBlock(ch_out*<span class="number">2</span>, ch_out))</span><br><span class="line">            self.res_out_list.append(res_out)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self,inputs</span>):</span><br><span class="line">        y = self.basicblock0(inputs)</span><br><span class="line">        <span class="keyword">for</span> basic_block_i <span class="keyword">in</span> self.res_out_list:</span><br><span class="line">            y = basic_block_i(y)</span><br><span class="line">        <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"><span class="comment"># DarkNet æ¯ç»„æ®‹å·®å—çš„ä¸ªæ•°ï¼Œæ¥è‡ªDarkNetçš„ç½‘ç»œç»“æ„å›¾</span></span><br><span class="line">DarkNet_cfg = &#123;<span class="number">53</span>: ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">4</span>])&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºDarkNet53éª¨å¹²ç½‘ç»œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DarkNet53_conv_body</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(DarkNet53_conv_body, self).__init__()</span><br><span class="line">        self.stages = DarkNet_cfg[<span class="number">53</span>]</span><br><span class="line">        self.stages = self.stages[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¬¬ä¸€å±‚å·ç§¯</span></span><br><span class="line">        self.conv0 = ConvBNLayer(</span><br><span class="line">            ch_in=<span class="number">3</span>,</span><br><span class="line">            ch_out=<span class="number">32</span>,</span><br><span class="line">            kernel_size=<span class="number">3</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¸‹é‡‡æ ·ï¼Œä½¿ç”¨stride=2çš„å·ç§¯æ¥å®ç°</span></span><br><span class="line">        self.downsample0 = DownSample(</span><br><span class="line">            ch_in=<span class="number">32</span>,</span><br><span class="line">            ch_out=<span class="number">32</span> * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ å„ä¸ªå±‚çº§çš„å®ç°</span></span><br><span class="line">        self.darknet53_conv_block_list = []</span><br><span class="line">        self.downsample_list = []</span><br><span class="line">        <span class="keyword">for</span> i, stage <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.stages):</span><br><span class="line">            conv_block = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;stage_%d&quot;</span> % (i),</span><br><span class="line">                LayerWarp(<span class="number">32</span>*(<span class="number">2</span>**(i+<span class="number">1</span>)),</span><br><span class="line">                <span class="number">32</span>*(<span class="number">2</span>**i),</span><br><span class="line">                stage))</span><br><span class="line">            self.darknet53_conv_block_list.append(conv_block)</span><br><span class="line">        <span class="comment"># ä¸¤ä¸ªå±‚çº§ä¹‹é—´ä½¿ç”¨DownSampleå°†å°ºå¯¸å‡åŠ</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.stages) - <span class="number">1</span>):</span><br><span class="line">            downsample = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;stage_%d_downsample&quot;</span> % i,</span><br><span class="line">                DownSample(ch_in=<span class="number">32</span>*(<span class="number">2</span>**(i+<span class="number">1</span>)),</span><br><span class="line">                    ch_out=<span class="number">32</span>*(<span class="number">2</span>**(i+<span class="number">2</span>))))</span><br><span class="line">            self.downsample_list.append(downsample)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self,inputs</span>):</span><br><span class="line">        out = self.conv0(inputs)</span><br><span class="line">        <span class="comment">#print(&quot;conv1:&quot;,out.numpy())</span></span><br><span class="line">        out = self.downsample0(out)</span><br><span class="line">        <span class="comment">#print(&quot;downsample:&quot;,out.numpy())</span></span><br><span class="line">        blocks = []</span><br><span class="line">        <span class="comment"># ä¾æ¬¡å°†å„ä¸ªå±‚çº§ä½œç”¨åœ¨è¾“å…¥ä¸Šé¢</span></span><br><span class="line">        <span class="keyword">for</span> i, conv_block_i <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.darknet53_conv_block_list):</span><br><span class="line">            out = conv_block_i(out)</span><br><span class="line">            blocks.append(out)</span><br><span class="line">            <span class="keyword">if</span> i &lt; <span class="built_in">len</span>(self.stages) - <span class="number">1</span>:</span><br><span class="line">                out = self.downsample_list[i](out)</span><br><span class="line">        <span class="comment"># å°†C0, C1, C2ä½œä¸ºè¿”å›å€¼</span></span><br><span class="line">        <span class="keyword">return</span> blocks[-<span class="number">1</span>:-<span class="number">4</span>:-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼ŒæŒ‡å®šè¾“å…¥æ•°æ®çš„å½¢çŠ¶æ˜¯$(1, 3, 640, 640)$ï¼Œåˆ™3ä¸ªå±‚çº§çš„è¾“å‡ºç‰¹å¾å›¾çš„å½¢çŠ¶åˆ†åˆ«æ˜¯$C0 (1, 1024, 20, 20)$ï¼Œ$C1 (1, 512, 40, 40)$å’Œ$C2 (1, 256, 80, 80)$ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹Darknet53ç½‘ç»œè¾“å‡ºç‰¹å¾å›¾</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line"><span class="built_in">print</span>(C0.shape, C1.shape, C2.shape)</span><br></pre></td></tr></table></figure>

<pre><code>[1, 1024, 20, 20] [1, 512, 40, 40] [1, 256, 80, 80]
</code></pre>
<h2 id="4-æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«"><a href="#4-æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«" class="headerlink" title="4.æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«"></a>4.æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«</h2><p>YOLOv3ä¸­å¯¹æ¯ä¸ªé¢„æµ‹æ¡†è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“ã€‚ä¹Ÿå¯ç†è§£ä¸ºobjectness&#x3D;1çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Œå¯ä»¥ç”¨ç½‘ç»œè¾“å‡ºä¸€ä¸ªå®æ•°$x$ï¼Œå¯ä»¥ç”¨$Sigmoid(x)$è¡¨ç¤ºobjectnessä¸ºæ­£çš„æ¦‚ç‡$P_{obj}$</p>
</li>
<li><p>é¢„æµ‹ç‰©ä½“ä½ç½®å’Œå½¢çŠ¶ã€‚ç‰©ä½“ä½ç½®å’Œå½¢çŠ¶$t_x, t_y, t_w, t_h$å¯ä»¥ç”¨ç½‘ç»œè¾“å‡º4ä¸ªå®æ•°æ¥è¡¨ç¤º$t_x, t_y, t_w, t_h$</p>
</li>
<li><p>é¢„æµ‹ç‰©ä½“ç±»åˆ«ã€‚é¢„æµ‹å›¾åƒä¸­ç‰©ä½“çš„å…·ä½“ç±»åˆ«æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…è¯´å…¶å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡åˆ†åˆ«æ˜¯å¤šå°‘ã€‚æ€»çš„ç±»åˆ«æ•°ä¸ºCï¼Œéœ€è¦é¢„æµ‹ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡$(P_1, P_2, â€¦, P_C)$ï¼Œå¯ä»¥ç”¨ç½‘ç»œè¾“å‡ºCä¸ªå®æ•°$(x_1, x_2, â€¦, x_C)$ï¼Œå¯¹æ¯ä¸ªå®æ•°åˆ†åˆ«æ±‚Sigmoidå‡½æ•°ï¼Œè®©$P_i &#x3D; Sigmoid(x_i)$ï¼Œåˆ™å¯ä»¥è¡¨ç¤ºå‡ºç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</p>
</li>
</ul>
<p>å¯¹äºä¸€ä¸ªé¢„æµ‹æ¡†ï¼Œç½‘ç»œéœ€è¦è¾“å‡º$(5 + C)$ä¸ªå®æ•°æ¥è¡¨å¾å®ƒæ˜¯å¦åŒ…å«ç‰©ä½“ã€ä½ç½®å’Œå½¢çŠ¶å°ºå¯¸ä»¥åŠå±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚ç”±äºæˆ‘ä»¬åœ¨æ¯ä¸ªå°æ–¹å—åŒºåŸŸéƒ½ç”Ÿæˆäº†Kä¸ªé¢„æµ‹æ¡†ï¼Œåˆ™æ‰€æœ‰é¢„æµ‹æ¡†ä¸€å…±éœ€è¦ç½‘ç»œè¾“å‡ºçš„é¢„æµ‹å€¼æ•°ç›®æ˜¯ï¼š</p>
<p>$$<br>[K(5 + C)] \times m \times n<br>$$<br>è¿˜æœ‰æ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ç½‘ç»œè¾“å‡ºå¿…é¡»è¦èƒ½åŒºåˆ†å‡ºå°æ–¹å—åŒºåŸŸçš„ä½ç½®æ¥ï¼Œä¸èƒ½ç›´æ¥å°†ç‰¹å¾å›¾è¿æ¥ä¸€ä¸ªè¾“å‡ºå¤§å°ä¸º$[K(5 + C)] \times m \times n$çš„å…¨è¿æ¥å±‚ã€‚</p>
<h3 id="4-1å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”"><a href="#4-1å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”" class="headerlink" title="4.1å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”"></a><strong>4.1å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”</strong></h3><p>ç°åœ¨è§‚å¯Ÿç‰¹å¾å›¾ï¼Œç»è¿‡å¤šæ¬¡å·ç§¯æ ¸æ± åŒ–ä¹‹åï¼Œå…¶æ­¥å¹…stride&#x3D;32ï¼Œ$640 \times 480$å¤§å°çš„è¾“å…¥å›¾ç‰‡å˜æˆäº†$20\times15$çš„ç‰¹å¾å›¾ï¼›è€Œå°æ–¹å—åŒºåŸŸçš„æ•°ç›®æ­£å¥½æ˜¯$20\times15$ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è®©ç‰¹å¾å›¾ä¸Šæ¯ä¸ªåƒç´ ç‚¹åˆ†åˆ«è·ŸåŸå›¾ä¸Šä¸€ä¸ªå°æ–¹å—åŒºåŸŸå¯¹åº”ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ€å¼€å§‹å°†å°æ–¹å—åŒºåŸŸçš„å°ºå¯¸è®¾ç½®ä¸º32çš„åŸå› ï¼Œè¿™æ ·å¯ä»¥å·§å¦™çš„å°†å°æ–¹å—åŒºåŸŸè·Ÿç‰¹å¾å›¾ä¸Šçš„åƒç´ ç‚¹å¯¹åº”èµ·æ¥ï¼Œè§£å†³äº†ç©ºé—´ä½ç½®çš„å¯¹åº”å…³ç³»ã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/59bd2592dd9f4f4dada8333307198888e667b15969ce434eb52c0232d9608a62" width = "600"></center>
<center><br>å›¾12ï¼šç‰¹å¾å›¾C0ä¸å°æ–¹å—åŒºåŸŸå½¢çŠ¶å¯¹æ¯” </br></center>

<p><br></br></p>
<p>ä¸‹é¢éœ€è¦å°†åƒç´ ç‚¹$(i,j)$ä¸ç¬¬iè¡Œç¬¬jåˆ—çš„å°æ–¹å—åŒºåŸŸæ‰€éœ€è¦çš„é¢„æµ‹å€¼å…³è”èµ·æ¥ï¼Œæ¯ä¸ªå°æ–¹å—åŒºåŸŸäº§ç”ŸKä¸ªé¢„æµ‹æ¡†ï¼Œæ¯ä¸ªé¢„æµ‹æ¡†éœ€è¦$(5 + C)$ä¸ªå®æ•°é¢„æµ‹å€¼ï¼Œåˆ™æ¯ä¸ªåƒç´ ç‚¹ç›¸å¯¹åº”çš„è¦æœ‰$K(5 + C)$ä¸ªå®æ•°ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¯¹ç‰¹å¾å›¾è¿›è¡Œå¤šæ¬¡å·ç§¯ï¼Œå¹¶å°†æœ€ç»ˆçš„è¾“å‡ºé€šé“æ•°è®¾ç½®ä¸º$K(5 + C)$ï¼Œå³å¯å°†ç”Ÿæˆçš„ç‰¹å¾å›¾ä¸æ¯ä¸ªé¢„æµ‹æ¡†æ‰€éœ€è¦çš„é¢„æµ‹å€¼å·§å¦™çš„å¯¹åº”èµ·æ¥ã€‚å½“ç„¶ï¼Œè¿™ç§å¯¹åº”æ˜¯ä¸ºäº†å°†éª¨å¹²ç½‘ç»œæå–çš„ç‰¹å¾å¯¹æ¥è¾“å‡ºå±‚æ¥å½¢æˆLossã€‚å®é™…ä¸­ï¼Œè¿™å‡ ä¸ªå°ºå¯¸å¯ä»¥éšç€ä»»åŠ¡æ•°æ®åˆ†å¸ƒçš„ä¸åŒè€Œè°ƒæ•´ï¼Œåªè¦ä¿è¯ç‰¹å¾å›¾è¾“å‡ºå°ºå¯¸ï¼ˆæ§åˆ¶å·ç§¯æ ¸å’Œä¸‹é‡‡æ ·ï¼‰å’Œè¾“å‡ºå±‚å°ºå¯¸ï¼ˆæ§åˆ¶å°æ–¹å—åŒºåŸŸçš„å¤§å°ï¼‰ç›¸åŒå³å¯ã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/f1d445d77cd84c60897ade92cc24f951a7672a72dc6f43b8aeb6932b6db778d6" width = "600"></center>
<center><br>å›¾13ï¼šç‰¹å¾å›¾C0ä¸å°æ–¹å—åŒºåŸŸä¸€ä¸€å¯¹åº” </br></center>

<p><br></br></p>
<p>éª¨å¹²ç½‘ç»œçš„è¾“å‡ºç‰¹å¾å›¾æ˜¯C0ï¼Œä¸‹é¢çš„ç¨‹åºæ˜¯å¯¹C0è¿›è¡Œå¤šæ¬¡å·ç§¯ä»¥å¾—åˆ°è·Ÿé¢„æµ‹æ¡†ç›¸å…³çš„ç‰¹å¾å›¾P0ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ YOLOv3 åç»­è¿æ¥çš„ç½‘ç»œå±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YoloDetectionBlock</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="comment"># ä½¿ç”¨å¤šå±‚å·ç§¯å’ŒBNæå–ç‰¹å¾</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,ch_in,ch_out,is_test=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(YoloDetectionBlock, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> ch_out % <span class="number">2</span> == <span class="number">0</span>, \</span><br><span class="line">            <span class="string">&quot;channel &#123;&#125; cannot be divided by 2&quot;</span>.<span class="built_in">format</span>(ch_out)</span><br><span class="line"></span><br><span class="line">        self.conv0 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_in,</span><br><span class="line">            ch_out=ch_out,</span><br><span class="line">            kernel_size=<span class="number">1</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">0</span>)</span><br><span class="line">        self.conv1 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out,</span><br><span class="line">            ch_out=ch_out*<span class="number">2</span>,</span><br><span class="line">            kernel_size=<span class="number">3</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">1</span>)</span><br><span class="line">        self.conv2 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out*<span class="number">2</span>,</span><br><span class="line">            ch_out=ch_out,</span><br><span class="line">            kernel_size=<span class="number">1</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">0</span>)</span><br><span class="line">        self.conv3 = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out,</span><br><span class="line">            ch_out=ch_out*<span class="number">2</span>,</span><br><span class="line">            kernel_size=<span class="number">3</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># çº¿æ€§å±‚</span></span><br><span class="line">        self.route = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out*<span class="number">2</span>,</span><br><span class="line">            ch_out=ch_out,</span><br><span class="line">            kernel_size=<span class="number">1</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># æœ€æœ«å±‚</span></span><br><span class="line">        self.tip = ConvBNLayer(</span><br><span class="line">            ch_in=ch_out,</span><br><span class="line">            ch_out=ch_out*<span class="number">2</span>,</span><br><span class="line">            kernel_size=<span class="number">3</span>,</span><br><span class="line">            stride=<span class="number">1</span>,</span><br><span class="line">            padding=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        out = self.conv0(inputs)</span><br><span class="line">        out = self.conv1(out)</span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        route = self.route(out)</span><br><span class="line">        tip = self.tip(route)</span><br><span class="line">        <span class="keyword">return</span> route, tip</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">NUM_ANCHORS = <span class="number">3</span> <span class="comment"># é”šæ¡†æ•°</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span> <span class="comment"># ç±»åˆ«æ•°</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters, kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(P0.shape)</span><br></pre></td></tr></table></figure>

<pre><code>[1, 36, 20, 20]
å¡«å……çš„å­˜åœ¨å¤§å°ä¸ä¼šå‘ç”Ÿå˜åŒ–
</code></pre>
<p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œå¯ä»¥ç”±ç‰¹å¾å›¾C0ç”Ÿæˆç‰¹å¾å›¾P0ï¼ŒP0çš„å½¢çŠ¶æ˜¯$[1, 36, 20, 20]$ã€‚æ¯ä¸ªå°æ–¹å—åŒºåŸŸç”Ÿæˆçš„é”šæ¡†æˆ–è€…é¢„æµ‹æ¡†çš„æ•°é‡æ˜¯3ï¼Œç‰©ä½“ç±»åˆ«æ•°ç›®æ˜¯7ï¼Œæ¯ä¸ªåŒºåŸŸéœ€è¦çš„é¢„æµ‹å€¼ä¸ªæ•°æ˜¯$3 \times (5 + 7) &#x3D; 36$ï¼Œæ­£å¥½ç­‰äºP0çš„è¾“å‡ºé€šé“æ•°ã€‚</p>
<p>å°†$P0[t, 0:12, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†æ‰€éœ€è¦çš„12ä¸ªé¢„æµ‹å€¼å¯¹åº”ï¼Œ$P0[t, 12:24, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬2ä¸ªé¢„æµ‹æ¡†æ‰€éœ€è¦çš„12ä¸ªé¢„æµ‹å€¼å¯¹åº”ï¼Œ$P0[t, 24:36, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬3ä¸ªé¢„æµ‹æ¡†æ‰€éœ€è¦çš„12ä¸ªé¢„æµ‹å€¼å¯¹åº”ã€‚</p>
<p>$P0[t, 0:4, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†çš„ä½ç½®å¯¹åº”ï¼Œ$P0[t, 4, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†çš„objectnesså¯¹åº”ï¼Œ$P0[t, 5:12, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†çš„ç±»åˆ«å¯¹åº”ã€‚</p>
<p>å¦‚ <strong>å›¾14</strong> æ‰€ç¤ºï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å·§å¦™çš„å°†ç½‘ç»œè¾“å‡ºç‰¹å¾å›¾ï¼Œä¸æ¯ä¸ªå°æ–¹å—åŒºåŸŸç”Ÿæˆçš„é¢„æµ‹æ¡†å¯¹åº”èµ·æ¥äº†ã€‚<br><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/9ea44b2c11f74f1484ab2bdc93be4008008cdee0b8d34dcb97bc9f89af935d1c" width = "800"></center>
<center><br>å›¾14ï¼šç‰¹å¾å›¾P0ä¸å€™é€‰åŒºåŸŸçš„å…³è” </br></center>

<p><br></br></p>
<h3 id="4-2è®¡ç®—é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡"><a href="#4-2è®¡ç®—é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡" class="headerlink" title="4.2è®¡ç®—é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡"></a><strong>4.2è®¡ç®—é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡</strong></h3><p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œ$P0[t, 4, i, j]$ä¸è¾“å…¥çš„ç¬¬tå¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†çš„objectnesså¯¹åº”ï¼Œ$P0[t, 4+12, i, j]$ä¸ç¬¬2ä¸ªé¢„æµ‹æ¡†çš„objectnesså¯¹åº”ï¼Œâ€¦ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºå°†objectnessç›¸å…³çš„é¢„æµ‹å–å‡ºï¼Œå¹¶ä½¿ç”¨<code>paddle.nn.functional.sigmoid</code>è®¡ç®—è¾“å‡ºæ¦‚ç‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line">reshaped_p0 = paddle.reshape(P0, [-<span class="number">1</span>, NUM_ANCHORS, NUM_CLASSES + <span class="number">5</span>, P0.shape[<span class="number">2</span>], P0.shape[<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(P0.shape, reshaped_p0.shape)</span><br><span class="line">pred_objectness = reshaped_p0[:, :, <span class="number">4</span>, :, :]</span><br><span class="line">pred_objectness_probability = F.sigmoid(pred_objectness)</span><br><span class="line"><span class="built_in">print</span>(pred_objectness.shape, pred_objectness_probability.shape)</span><br></pre></td></tr></table></figure>

<pre><code>[1, 36, 20, 20] [1, 3, 12, 20, 20]
[1, 3, 20, 20] [1, 3, 20, 20]
</code></pre>
<p>ä¸Šé¢çš„è¾“å‡ºç¨‹åºæ˜¾ç¤ºï¼Œé¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡<code>pred_objectness_probability</code>ï¼Œå…¶æ•°æ®å½¢çŠ¶æ˜¯[1, 3, 20, 20]ï¼Œä¸æˆ‘ä»¬ä¸Šé¢æåˆ°çš„é¢„æµ‹æ¡†ä¸ªæ•°ä¸€è‡´ï¼Œæ•°æ®å¤§å°åœ¨0ï½1ä¹‹é—´ï¼Œè¡¨ç¤ºé¢„æµ‹æ¡†ä¸ºæ­£æ ·æœ¬çš„æ¦‚ç‡ã€‚</p>
<h3 id="4-3è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡"><a href="#4-3è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡" class="headerlink" title="4.3è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡"></a><strong>4.3è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡</strong></h3><p>$P0[t, 0:4, i, j]$ä¸è¾“å…¥çš„ç¬¬$t$å¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†çš„ä½ç½®å¯¹åº”ï¼Œ$P0[t, 12:16, i, j]$ä¸ç¬¬2ä¸ªé¢„æµ‹æ¡†çš„ä½ç½®å¯¹åº”ï¼Œä¾æ­¤ç±»æ¨ï¼Œåˆ™ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºå¯ä»¥ä»$P0$ä¸­å–å‡ºè·Ÿé¢„æµ‹æ¡†ä½ç½®ç›¸å…³çš„é¢„æµ‹å€¼ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred =  paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reshaped_p0 = paddle.reshape(P0, [-<span class="number">1</span>, NUM_ANCHORS, NUM_CLASSES + <span class="number">5</span>, P0.shape[<span class="number">2</span>], P0.shape[<span class="number">3</span>]])</span><br><span class="line">pred_objectness = reshaped_p0[:, :, <span class="number">4</span>, :, :]</span><br><span class="line">pred_objectness_probability = F.sigmoid(pred_objectness)</span><br><span class="line"></span><br><span class="line">pred_location = reshaped_p0[:, :, <span class="number">0</span>:<span class="number">4</span>, :, :]</span><br><span class="line"><span class="built_in">print</span>(pred_location.shape)</span><br></pre></td></tr></table></figure>

<pre><code>[1, 3, 4, 20, 20]
</code></pre>
<p>ç½‘ç»œè¾“å‡ºå€¼æ˜¯$(t_x, t_y, t_w, t_h)$ï¼Œè¿˜éœ€è¦å°†å…¶è½¬åŒ–ä¸º$(x_1, y_1, x_2, y_2)$è¿™ç§å½¢å¼çš„åæ ‡è¡¨ç¤ºã€‚æˆ‘ä»¬ä½¿ç”¨Numpyæ¥å®ç°è¿™ä¸€è¿‡ç¨‹ã€‚åœ¨åé¢çš„ä»£ç ä¸­ä½¿ç”¨é£æ¡¨<a target="_blank" rel="noopener" href="https://www.paddlepaddle.org.cn/documentation/docs/zh/api/paddle/vision/ops/yolo_box_cn.html#yolo-box">paddle.vision.ops.yolo_box</a> APIå¯ä»¥ç›´æ¥è®¡ç®—å‡ºç»“æœã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰Sigmoidå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sigmoid</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.</span>/(<span class="number">1.0</span> + np.exp(-x))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘ç»œç‰¹å¾å›¾è¾“å‡ºçš„[tx, ty, th, tw]è½¬åŒ–æˆé¢„æµ‹æ¡†çš„åæ ‡[x1, y1, x2, y2]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_yolo_box_xxyy</span>(<span class="params">pred, anchors, num_classes, downsample</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    predæ˜¯ç½‘ç»œè¾“å‡ºç‰¹å¾å›¾è½¬åŒ–æˆçš„numpy.ndarray</span></span><br><span class="line"><span class="string">    anchors æ˜¯ä¸€ä¸ªlistã€‚è¡¨ç¤ºé”šæ¡†çš„å¤§å°ï¼Œ</span></span><br><span class="line"><span class="string">                ä¾‹å¦‚ anchors = [116, 90, 156, 198, 373, 326]ï¼Œè¡¨ç¤ºæœ‰ä¸‰ä¸ªé”šæ¡†ï¼Œ</span></span><br><span class="line"><span class="string">                ç¬¬ä¸€ä¸ªé”šæ¡†å¤§å°[w, h]æ˜¯[116, 90]ï¼Œç¬¬äºŒä¸ªé”šæ¡†å¤§å°æ˜¯[156, 198]ï¼Œç¬¬ä¸‰ä¸ªé”šæ¡†å¤§å°æ˜¯[373, 326]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    batchsize = pred.shape[<span class="number">0</span>]</span><br><span class="line">    num_rows = pred.shape[-<span class="number">2</span>]</span><br><span class="line">    num_cols = pred.shape[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    input_h = num_rows * downsample</span><br><span class="line">    input_w = num_cols * downsample</span><br><span class="line"></span><br><span class="line">    num_anchors = <span class="built_in">len</span>(anchors) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># predçš„å½¢çŠ¶æ˜¯[N, C, H, W]ï¼Œå…¶ä¸­C = NUM_ANCHORS * (5 + NUM_CLASSES)</span></span><br><span class="line">    <span class="comment"># å¯¹predè¿›è¡Œreshape</span></span><br><span class="line">    pred = pred.reshape([-<span class="number">1</span>, num_anchors, <span class="number">5</span>+num_classes, num_rows, num_cols])</span><br><span class="line">    pred_location = pred[:, :, <span class="number">0</span>:<span class="number">4</span>, :, :]</span><br><span class="line">    pred_location = np.transpose(pred_location, (<span class="number">0</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>)) <span class="comment"># [N, H, W, NUM_ANCHORS, 4]</span></span><br><span class="line">    anchors_this = [] <span class="comment"># è¾“å‡ºé”šæ¡†</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(num_anchors):</span><br><span class="line">        anchors_this.append([anchors[ind*<span class="number">2</span>], anchors[ind*<span class="number">2</span>+<span class="number">1</span>]])</span><br><span class="line">    anchors_this = np.array(anchors_this).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æœ€ç»ˆè¾“å‡ºæ•°æ®ä¿å­˜åœ¨pred_boxä¸­ï¼Œå…¶å½¢çŠ¶æ˜¯[N, H, W, NUM_ANCHORS, 4]ï¼Œ</span></span><br><span class="line">    <span class="comment"># å…¶ä¸­æœ€åä¸€ä¸ªç»´åº¦4ä»£è¡¨ä½ç½®çš„4ä¸ªåæ ‡</span></span><br><span class="line">    pred_box = np.zeros(pred_location.shape)</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(batchsize):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_rows):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(num_cols):</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(num_anchors):</span><br><span class="line">                    pred_box[n, i, j, k, <span class="number">0</span>] = j</span><br><span class="line">                    pred_box[n, i, j, k, <span class="number">1</span>] = i</span><br><span class="line">                    pred_box[n, i, j, k, <span class="number">2</span>] = anchors_this[k][<span class="number">0</span>]</span><br><span class="line">                    pred_box[n, i, j, k, <span class="number">3</span>] = anchors_this[k][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™é‡Œä½¿ç”¨ç›¸å¯¹åæ ‡ï¼Œpred_boxçš„è¾“å‡ºå…ƒç´ æ•°å€¼åœ¨0.~1.0ä¹‹é—´</span></span><br><span class="line">    pred_box[:, :, :, :, <span class="number">0</span>] = (sigmoid(pred_location[:, :, :, :, <span class="number">0</span>]) + pred_box[:, :, :, :, <span class="number">0</span>]) / num_cols</span><br><span class="line">    pred_box[:, :, :, :, <span class="number">1</span>] = (sigmoid(pred_location[:, :, :, :, <span class="number">1</span>]) + pred_box[:, :, :, :, <span class="number">1</span>]) / num_rows</span><br><span class="line">    pred_box[:, :, :, :, <span class="number">2</span>] = np.exp(pred_location[:, :, :, :, <span class="number">2</span>]) * pred_box[:, :, :, :, <span class="number">2</span>] / input_w</span><br><span class="line">    pred_box[:, :, :, :, <span class="number">3</span>] = np.exp(pred_location[:, :, :, :, <span class="number">3</span>]) * pred_box[:, :, :, :, <span class="number">3</span>] / input_h</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†åæ ‡ä»xywhè½¬åŒ–æˆxyxy</span></span><br><span class="line">    pred_box[:, :, :, :, <span class="number">0</span>] = pred_box[:, :, :, :, <span class="number">0</span>] - pred_box[:, :, :, :, <span class="number">2</span>] / <span class="number">2.</span></span><br><span class="line">    pred_box[:, :, :, :, <span class="number">1</span>] = pred_box[:, :, :, :, <span class="number">1</span>] - pred_box[:, :, :, :, <span class="number">3</span>] / <span class="number">2.</span></span><br><span class="line">    pred_box[:, :, :, :, <span class="number">2</span>] = pred_box[:, :, :, :, <span class="number">0</span>] + pred_box[:, :, :, :, <span class="number">2</span>]</span><br><span class="line">    pred_box[:, :, :, :, <span class="number">3</span>] = pred_box[:, :, :, :, <span class="number">1</span>] + pred_box[:, :, :, :, <span class="number">3</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æˆªå– np.clip(a, a_min, a_max, out=None)</span></span><br><span class="line">    pred_box = np.clip(pred_box, <span class="number">0.</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pred_box</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è°ƒç”¨ä¸Šé¢å®šä¹‰çš„<code>get_yolo_box_xxyy</code>å‡½æ•°ï¼Œå¯ä»¥ä»$P0$è®¡ç®—å‡ºé¢„æµ‹æ¡†åæ ‡æ¥ï¼Œå…·ä½“ç¨‹åºå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line">reshaped_p0 = paddle.reshape(P0, [-<span class="number">1</span>, NUM_ANCHORS, NUM_CLASSES + <span class="number">5</span>, P0.shape[<span class="number">2</span>], P0.shape[<span class="number">3</span>]])</span><br><span class="line">pred_objectness = reshaped_p0[:, :, <span class="number">4</span>, :, :]</span><br><span class="line">pred_objectness_probability = F.sigmoid(pred_objectness)</span><br><span class="line"></span><br><span class="line">pred_location = reshaped_p0[:, :, <span class="number">0</span>:<span class="number">4</span>, :, :]</span><br><span class="line"></span><br><span class="line"><span class="comment"># anchorsåŒ…å«äº†é¢„å…ˆè®¾å®šå¥½çš„é”šæ¡†å°ºå¯¸</span></span><br><span class="line">anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line"><span class="comment"># downsample æ˜¯ç‰¹å¾å›¾P0çš„æ­¥å¹…</span></span><br><span class="line"><span class="comment"># ç”±è¾“å‡ºç‰¹å¾å›¾P0è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡</span></span><br><span class="line">pred_boxes = get_yolo_box_xxyy(P0.numpy(), anchors, num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span>(pred_location.shape, pred_boxes.shape)</span><br><span class="line"><span class="built_in">print</span>(pred_boxes[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>].shape, pred_boxes[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>]) <span class="comment"># ä¸€ä¸ªä¸­å¿ƒä¸‰ä¸ªé”šæ¡† location</span></span><br></pre></td></tr></table></figure>

<pre><code>[1, 3, 4, 20, 20] (1, 20, 20, 3, 4)
(3, 4) [[0.         0.         0.11592992 0.09357996]
 [0.         0.         0.14583146 0.17757062]
 [0.         0.         0.32789061 0.26856107]]
</code></pre>
<h3 id="4-4è®¡ç®—ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«æ¦‚ç‡"><a href="#4-4è®¡ç®—ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«æ¦‚ç‡" class="headerlink" title="4.4è®¡ç®—ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«æ¦‚ç‡"></a><strong>4.4è®¡ç®—ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«æ¦‚ç‡</strong></h3><p>$P0[t, 5:12, i, j]$ä¸è¾“å…¥çš„ç¬¬$t$å¼ å›¾ç‰‡ä¸Šå°æ–¹å—åŒºåŸŸ$(i, j)$ç¬¬1ä¸ªé¢„æµ‹æ¡†åŒ…å«ç‰©ä½“çš„ç±»åˆ«å¯¹åº”ï¼Œ$P0[t, 17:24, i, j]$ä¸ç¬¬2ä¸ªé¢„æµ‹æ¡†çš„ç±»åˆ«å¯¹åº”ï¼Œä¾æ­¤ç±»æ¨ï¼Œåˆ™ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºå¯ä»¥ä»$P0$ä¸­å–å‡ºé‚£äº›è·Ÿé¢„æµ‹æ¡†ç±»åˆ«ç›¸å…³çš„é¢„æµ‹å€¼ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = np.random.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">x = paddle.to_tensor(x)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line">reshaped_p0 = paddle.reshape(P0, [-<span class="number">1</span>, NUM_ANCHORS, NUM_CLASSES + <span class="number">5</span>, P0.shape[<span class="number">2</span>], P0.shape[<span class="number">3</span>]])</span><br><span class="line"><span class="comment"># å–å‡ºä¸objectnessç›¸å…³çš„é¢„æµ‹å€¼</span></span><br><span class="line">pred_objectness = reshaped_p0[:, :, <span class="number">4</span>, :, :]</span><br><span class="line">pred_objectness_probability = F.sigmoid(pred_objectness)</span><br><span class="line"><span class="comment"># å–å‡ºä¸ä½ç½®ç›¸å…³çš„é¢„æµ‹å€¼</span></span><br><span class="line">pred_location = reshaped_p0[:, :, <span class="number">0</span>:<span class="number">4</span>, :, :]</span><br><span class="line"><span class="comment"># å–å‡ºä¸ç±»åˆ«ç›¸å…³çš„é¢„æµ‹å€¼</span></span><br><span class="line">pred_classification = reshaped_p0[:, :, <span class="number">5</span>:<span class="number">5</span>+NUM_CLASSES, :, :]</span><br><span class="line">pred_classification_probability = F.sigmoid(pred_classification)</span><br><span class="line"><span class="built_in">print</span>(pred_objectness_probability.shape, pred_location.shape, pred_classification.shape)</span><br></pre></td></tr></table></figure>

<pre><code>[1, 3, 20, 20] [1, 3, 4, 20, 20] [1, 3, 7, 20, 20]
</code></pre>
<p>ä¸Šé¢çš„ç¨‹åºé€šè¿‡$P0$è®¡ç®—å‡ºäº†é¢„æµ‹æ¡†åŒ…å«çš„ç‰©ä½“æ‰€å±ç±»åˆ«çš„æ¦‚ç‡ï¼Œ<code>pred_classification_probability</code>çš„å½¢çŠ¶æ˜¯$[1, 3, 7, 20, 20]$ï¼Œæ•°å€¼åœ¨0~1ä¹‹é—´ã€‚</p>
<h2 id="5-æŸå¤±å‡½æ•°"><a href="#5-æŸå¤±å‡½æ•°" class="headerlink" title="5.æŸå¤±å‡½æ•°"></a><strong>5.æŸå¤±å‡½æ•°</strong></h2><p>ä¸Šé¢ä»æ¦‚å¿µä¸Šå°†è¾“å‡ºç‰¹å¾å›¾ä¸Šçš„åƒç´ ç‚¹ä¸é¢„æµ‹æ¡†å…³è”èµ·æ¥äº†ï¼Œé‚£ä¹ˆè¦å¯¹ç¥ç»ç½‘ç»œè¿›è¡Œæ±‚è§£ï¼Œè¿˜å¿…é¡»ä»æ•°å­¦ä¸Šå°†ç½‘ç»œè¾“å‡ºå’Œé¢„æµ‹æ¡†å…³è”èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯è¦å»ºç«‹èµ·æŸå¤±å‡½æ•°è·Ÿç½‘ç»œè¾“å‡ºä¹‹é—´çš„å…³ç³»ã€‚ä¸‹é¢è®¨è®ºå¦‚ä½•å»ºç«‹èµ·YOLOv3çš„æŸå¤±å‡½æ•°ã€‚</p>
<p>å¯¹äºæ¯ä¸ªé¢„æµ‹æ¡†ï¼ŒYOLOv3æ¨¡å‹ä¼šå»ºç«‹ä¸‰ç§ç±»å‹çš„æŸå¤±å‡½æ•°ï¼š</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/fc7bbc5436d84fb0bb18b817125947cbd441dbdef7ae4365b55da5188ea161b8" width = "800"></center>
<center><br>å›¾15ï¼šæŸå¤±å‡½æ•°çš„å»ºç«‹æ€è·¯ </br></center>

<p><br></br></p>
<ul>
<li><p>è¡¨å¾æ˜¯å¦åŒ…å«ç›®æ ‡ç‰©ä½“çš„æŸå¤±å‡½æ•°ï¼Œé€šè¿‡pred_objectnesså’Œlabel_objectnessè®¡ç®—ã€‚</p>
<pre><code>loss_obj = paddle.nn.fucntional.binary_cross_entropy_with_logits(pred_objectness, label_objectness)
</code></pre>
</li>
<li><p>è¡¨å¾ç‰©ä½“ä½ç½®çš„æŸå¤±å‡½æ•°ï¼Œé€šè¿‡pred_locationå’Œlabel_locationè®¡ç®—ã€‚</p>
<pre><code>pred_location_x = pred_location[:, :, 0, :, :]
pred_location_y = pred_location[:, :, 1, :, :]
pred_location_w = pred_location[:, :, 2, :, :]
pred_location_h = pred_location[:, :, 3, :, :]
loss_location_x = paddle.nn.fucntional.binary_cross_entropy_with_logits(pred_location_x, label_location_x)
loss_location_y = paddle.nn.fucntional.binary_cross_entropy_with_logits(pred_location_y, label_location_y)
loss_location_w = paddle.abs(pred_location_w - label_location_w)
loss_location_h = paddle.abs(pred_location_h - label_location_h)
loss_location = loss_location_x + loss_location_y + loss_location_w + loss_location_h
</code></pre>
</li>
<li><p>è¡¨å¾ç‰©ä½“ç±»åˆ«çš„æŸå¤±å‡½æ•°ï¼Œé€šè¿‡pred_classificationå’Œlabel_classificationè®¡ç®—ã€‚</p>
<pre><code>loss_obj = paddle.nn.fucntional.binary_cross_entropy_with_logits(pred_classification, label_classification)
</code></pre>
</li>
</ul>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“æ€ä¹ˆè®¡ç®—è¿™äº›é¢„æµ‹å€¼å’Œæ ‡ç­¾äº†ï¼Œä½†æ˜¯é—ç•™äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯æ²¡æœ‰æ ‡æ³¨å‡ºå“ªäº›é”šæ¡†çš„objectnessä¸º-1ã€‚ä¸ºäº†å®Œæˆè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºæ‰€æœ‰é¢„æµ‹æ¡†è·ŸçœŸå®æ¡†ä¹‹é—´çš„IoUï¼Œç„¶åæŠŠé‚£äº›IoUå¤§äºé˜ˆå€¼çš„çœŸå®æ¡†æŒ‘é€‰å‡ºæ¥ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‘é€‰å‡ºè·ŸçœŸå®æ¡†IoUå¤§äºé˜ˆå€¼çš„é¢„æµ‹æ¡†</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_iou_above_thresh_inds</span>(<span class="params">pred_box, gt_boxes, iou_threshold</span>):</span><br><span class="line">    batchsize = pred_box.shape[<span class="number">0</span>]</span><br><span class="line">    num_rows = pred_box.shape[<span class="number">1</span>]</span><br><span class="line">    num_cols = pred_box.shape[<span class="number">2</span>]</span><br><span class="line">    num_anchors = pred_box.shape[<span class="number">3</span>]</span><br><span class="line">    ret_inds = np.zeros([batchsize, num_rows, num_cols, num_anchors])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(batchsize):</span><br><span class="line">        pred_box_i = pred_box[i]</span><br><span class="line">        gt_boxes_i = gt_boxes[i]</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(gt_boxes_i)):</span><br><span class="line">            <span class="comment"># è®¡ç®—iou</span></span><br><span class="line">            gt = gt_boxes_i[k]</span><br><span class="line">            gtx_min = gt[<span class="number">0</span>] - gt[<span class="number">2</span>] / <span class="number">2.</span></span><br><span class="line">            gty_min = gt[<span class="number">1</span>] - gt[<span class="number">3</span>] / <span class="number">2.</span></span><br><span class="line">            gtx_max = gt[<span class="number">0</span>] + gt[<span class="number">2</span>] / <span class="number">2.</span></span><br><span class="line">            gty_max = gt[<span class="number">1</span>] + gt[<span class="number">3</span>] / <span class="number">2.</span></span><br><span class="line">            <span class="keyword">if</span> (gtx_max - gtx_min &lt; <span class="number">1e-3</span>) <span class="keyword">or</span> (gty_max - gty_min &lt; <span class="number">1e-3</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            x1 = np.maximum(pred_box_i[:, :, :, <span class="number">0</span>], gtx_min)</span><br><span class="line">            y1 = np.maximum(pred_box_i[:, :, :, <span class="number">1</span>], gty_min)</span><br><span class="line">            x2 = np.minimum(pred_box_i[:, :, :, <span class="number">2</span>], gtx_max)</span><br><span class="line">            y2 = np.minimum(pred_box_i[:, :, :, <span class="number">3</span>], gty_max)</span><br><span class="line">            intersection = np.maximum(x2 - x1, <span class="number">0.</span>) * np.maximum(y2 - y1, <span class="number">0.</span>)</span><br><span class="line">            s1 = (gty_max - gty_min) * (gtx_max - gtx_min)</span><br><span class="line">            s2 = (pred_box_i[:, :, :, <span class="number">2</span>] - pred_box_i[:, :, :, <span class="number">0</span>]) * (pred_box_i[:, :, :, <span class="number">3</span>] - pred_box_i[:, :, :, <span class="number">1</span>])</span><br><span class="line">            union = s2 + s1 - intersection</span><br><span class="line">            iou = intersection / union</span><br><span class="line">            <span class="comment"># np.where(condition) åˆ¤æ–­æ¡ä»¶æˆç«‹æ—¶è¿”å›ç´¢å¼•åæ ‡</span></span><br><span class="line">            above_inds = np.where(iou &gt; iou_threshold)</span><br><span class="line">            ret_inds[i][above_inds] = <span class="number">1</span></span><br><span class="line">    <span class="comment"># [batchsize, num_rows, num_cols, num_anchors]--&gt;[batchsize, num_anchors, num_rows, num_cols]</span></span><br><span class="line">    ret_inds = np.transpose(ret_inds, (<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> ret_inds.astype(<span class="string">&#x27;bool&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„å‡½æ•°å¯ä»¥å¾—åˆ°å“ªäº›é”šæ¡†çš„objectnesséœ€è¦è¢«æ ‡æ³¨ä¸º-1ï¼Œé€šè¿‡ä¸‹é¢çš„ç¨‹åºï¼Œå¯¹label_objectnessè¿›è¡Œå¤„ç†ï¼Œå°†IoUå¤§äºé˜ˆå€¼ï¼Œä½†åˆä¸æ˜¯æ­£æ ·æœ¬çš„é”šæ¡†æ ‡æ³¨ä¸º-1ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">label_objectness_ignore</span>(<span class="params">label_objectness, iou_above_thresh_indices</span>):</span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç®€å•çš„ä½¿ç”¨ label_objectness[iou_above_thresh_indices] = -1ï¼Œ</span></span><br><span class="line">    <span class="comment">#         è¿™æ ·å¯èƒ½ä¼šé€ æˆlabel_objectnessä¸º1çš„ç‚¹è¢«è®¾ç½®ä¸º-1äº†</span></span><br><span class="line">    <span class="comment">#         åªæœ‰å°†é‚£äº›è¢«æ ‡æ³¨ä¸º0ï¼Œä¸”ä¸çœŸå®æ¡†IoUè¶…è¿‡é˜ˆå€¼çš„é¢„æµ‹æ¡†æ‰è¢«æ ‡æ³¨ä¸º-1</span></span><br><span class="line">    negative_indices = (label_objectness &lt; <span class="number">0.5</span>)</span><br><span class="line">    ignore_indices = negative_indices * iou_above_thresh_indices</span><br><span class="line">    label_objectness[ignore_indices] = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> label_objectness</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢é€šè¿‡è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå®ç°å¦‚ä½•å°†éƒ¨åˆ†é¢„æµ‹æ¡†çš„label_objectnessè®¾ç½®ä¸º-1ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–æ•°æ®</span></span><br><span class="line">reader = paddle.io.DataLoader(train_dataset, batch_size=<span class="number">2</span>, shuffle=<span class="literal">True</span>, num_workers=<span class="number">0</span>, drop_last=<span class="literal">True</span>)</span><br><span class="line">img, gt_boxes, gt_labels, im_shape = <span class="built_in">next</span>(reader())</span><br><span class="line">img, gt_boxes, gt_labels, im_shape = img.numpy(), gt_boxes.numpy(), gt_labels.numpy(), im_shape.numpy()</span><br><span class="line"><span class="comment"># è®¡ç®—å‡ºé”šæ¡†å¯¹åº”çš„æ ‡ç­¾</span></span><br><span class="line">label_objectness, label_location, label_classification, scale_location = get_objectness_label(img,</span><br><span class="line">                                                                                              gt_boxes, gt_labels, </span><br><span class="line">                                                                                              iou_threshold = <span class="number">0.7</span>,</span><br><span class="line">                                                                                              anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span><br><span class="line">                                                                                              num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)</span><br><span class="line">                                               </span><br><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = paddle.nn.Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = paddle.to_tensor(img)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># anchorsåŒ…å«äº†é¢„å…ˆè®¾å®šå¥½çš„é”šæ¡†å°ºå¯¸</span></span><br><span class="line">anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line"><span class="comment"># downsampleæ˜¯ç‰¹å¾å›¾P0çš„æ­¥å¹…</span></span><br><span class="line">pred_boxes = get_yolo_box_xxyy(P0.numpy(), anchors, num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)</span><br><span class="line">iou_above_thresh_indices = get_iou_above_thresh_inds(pred_boxes, gt_boxes, iou_threshold=<span class="number">0.7</span>)</span><br><span class="line">label_objectness = label_objectness_ignore(label_objectness, iou_above_thresh_indices)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥å°†é‚£äº›æ²¡æœ‰è¢«æ ‡æ³¨ä¸ºæ­£æ ·æœ¬ï¼Œä½†åˆä¸çœŸå®æ¡†IoUæ¯”è¾ƒå¤§çš„æ ·æœ¬objectnessæ ‡ç­¾è®¾ç½®ä¸º-1äº†ï¼Œä¸è®¡ç®—å…¶å¯¹ä»»ä½•ä¸€ç§æŸå¤±å‡½æ•°çš„è´¡çŒ®ã€‚è®¡ç®—æ€»çš„æŸå¤±å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_loss</span>(<span class="params">output, label_objectness, label_location, label_classification, scales, num_anchors=<span class="number">3</span>, num_classes=<span class="number">7</span></span>):</span><br><span class="line">    <span class="comment"># å°†outputä»[N, C, H, W]å˜å½¢ä¸º[N, NUM_ANCHORS, NUM_CLASSES + 5, H, W]</span></span><br><span class="line">    reshaped_output = paddle.reshape(output, [-<span class="number">1</span>, num_anchors, num_classes + <span class="number">5</span>, output.shape[<span class="number">2</span>], output.shape[<span class="number">3</span>]])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»outputä¸­å–å‡ºè·Ÿobjectnessç›¸å…³çš„é¢„æµ‹å€¼</span></span><br><span class="line">    pred_objectness = reshaped_output[:, :, <span class="number">4</span>, :, :]</span><br><span class="line">    loss_objectness = F.binary_cross_entropy_with_logits(pred_objectness, label_objectness, reduction=<span class="string">&quot;none&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pos_samples åªæœ‰åœ¨æ­£æ ·æœ¬çš„åœ°æ–¹å–å€¼ä¸º1.ï¼Œå…¶å®ƒåœ°æ–¹å–å€¼å…¨ä¸º0.</span></span><br><span class="line">    pos_objectness = label_objectness &gt; <span class="number">0</span> <span class="comment"># æ­£ç±»æ ·æœ¬</span></span><br><span class="line">    <span class="comment"># paddle.cast(x, dtype) å°† x çš„æ•°æ®ç±»å‹è½¬æ¢ä¸º dtype</span></span><br><span class="line">    pos_samples = paddle.cast(pos_objectness, <span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    pos_samples.stop_gradient=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»outputä¸­å–å‡ºæ‰€æœ‰è·Ÿä½ç½®ç›¸å…³çš„é¢„æµ‹å€¼</span></span><br><span class="line">    tx = reshaped_output[:, :, <span class="number">0</span>, :, :]</span><br><span class="line">    ty = reshaped_output[:, :, <span class="number">1</span>, :, :]</span><br><span class="line">    tw = reshaped_output[:, :, <span class="number">2</span>, :, :]</span><br><span class="line">    th = reshaped_output[:, :, <span class="number">3</span>, :, :]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»label_locationä¸­å–å‡ºå„ä¸ªä½ç½®åæ ‡çš„æ ‡ç­¾</span></span><br><span class="line">    dx_label = label_location[:, :, <span class="number">0</span>, :, :]</span><br><span class="line">    dy_label = label_location[:, :, <span class="number">1</span>, :, :]</span><br><span class="line">    tw_label = label_location[:, :, <span class="number">2</span>, :, :]</span><br><span class="line">    th_label = label_location[:, :, <span class="number">3</span>, :, :]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæŸå¤±å‡½æ•°</span></span><br><span class="line">    loss_location_x = F.binary_cross_entropy_with_logits(tx, dx_label, reduction=<span class="string">&quot;none&quot;</span>)</span><br><span class="line">    loss_location_y = F.binary_cross_entropy_with_logits(ty, dy_label, reduction=<span class="string">&quot;none&quot;</span>)</span><br><span class="line">    loss_location_w = paddle.<span class="built_in">abs</span>(tw - tw_label)</span><br><span class="line">    loss_location_h = paddle.<span class="built_in">abs</span>(th - th_label)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—æ€»çš„ä½ç½®æŸå¤±å‡½æ•°</span></span><br><span class="line">    loss_location = loss_location_x + loss_location_y + loss_location_h + loss_location_w</span><br><span class="line">    <span class="comment"># ä¹˜ä»¥scales</span></span><br><span class="line">    loss_location = loss_location * scales <span class="comment"># scales--&gt;(h, w)</span></span><br><span class="line">    <span class="comment"># åªè®¡ç®—æ­£æ ·æœ¬çš„ä½ç½®æŸå¤±å‡½æ•°</span></span><br><span class="line">    loss_location = loss_location * pos_samples</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»outputå–å‡ºæ‰€æœ‰è·Ÿç‰©ä½“ç±»åˆ«ç›¸å…³çš„åƒç´ ç‚¹</span></span><br><span class="line">    pred_classification = reshaped_output[:, :, <span class="number">5</span>:<span class="number">5</span>+num_classes, :, :]</span><br><span class="line">    <span class="comment"># è®¡ç®—åˆ†ç±»ç›¸å…³çš„æŸå¤±å‡½æ•°</span></span><br><span class="line">    loss_classification = F.binary_cross_entropy_with_logits(pred_classification, label_classification, reduction=<span class="string">&quot;none&quot;</span>)</span><br><span class="line">    <span class="comment"># å°†æŸå¤±æ±‚å’Œ</span></span><br><span class="line">    loss_classification = paddle.<span class="built_in">sum</span>(loss_classification, axis=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># åªè®¡ç®—objectnessä¸ºæ­£çš„æ ·æœ¬çš„åˆ†ç±»æŸå¤±å‡½æ•°</span></span><br><span class="line">    loss_classification = loss_classification * pos_samples</span><br><span class="line">    </span><br><span class="line">    total_loss = loss_objectness + loss_location + loss_classification</span><br><span class="line">    <span class="comment"># å¯¹æ‰€æœ‰é¢„æµ‹æ¡†çš„lossè¿›è¡Œæ±‚å’Œ</span></span><br><span class="line">    total_loss = paddle.<span class="built_in">sum</span>(total_loss, axis=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line">    <span class="comment"># å¯¹æ‰€æœ‰æ ·æœ¬æ±‚å¹³å‡</span></span><br><span class="line">    total_loss = paddle.mean(total_loss)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> total_loss</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paddle.nn <span class="keyword">import</span> Conv2D</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—å‡ºé”šæ¡†å¯¹åº”çš„æ ‡ç­¾</span></span><br><span class="line">label_objectness, label_location, label_classification, scale_location = get_objectness_label(img,</span><br><span class="line">                                                                                              gt_boxes, gt_labels, </span><br><span class="line">                                                                                              iou_threshold = <span class="number">0.7</span>,</span><br><span class="line">                                                                                              anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span><br><span class="line">                                                                                              num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)                                                           </span><br><span class="line"></span><br><span class="line">NUM_ANCHORS = <span class="number">3</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line">num_filters=NUM_ANCHORS * (NUM_CLASSES + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">backbone = DarkNet53_conv_body()</span><br><span class="line">detection = YoloDetectionBlock(ch_in=<span class="number">1024</span>, ch_out=<span class="number">512</span>)</span><br><span class="line">conv2d_pred = Conv2D(in_channels=<span class="number">1024</span>, out_channels=num_filters,  kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x = paddle.to_tensor(img)</span><br><span class="line">C0, C1, C2 = backbone(x)</span><br><span class="line">route, tip = detection(C0)</span><br><span class="line">P0 = conv2d_pred(tip)</span><br><span class="line"><span class="comment"># anchorsåŒ…å«äº†é¢„å…ˆè®¾å®šå¥½çš„é”šæ¡†å°ºå¯¸</span></span><br><span class="line">anchors = [<span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line"><span class="comment"># downsampleæ˜¯ç‰¹å¾å›¾P0çš„æ­¥å¹…</span></span><br><span class="line">pred_boxes = get_yolo_box_xxyy(P0.numpy(), anchors, num_classes=<span class="number">7</span>, downsample=<span class="number">32</span>)</span><br><span class="line">iou_above_thresh_indices = get_iou_above_thresh_inds(pred_boxes, gt_boxes, iou_threshold=<span class="number">0.7</span>)</span><br><span class="line">label_objectness = label_objectness_ignore(label_objectness, iou_above_thresh_indices)</span><br><span class="line"></span><br><span class="line">label_objectness = paddle.to_tensor(label_objectness)</span><br><span class="line">label_location = paddle.to_tensor(label_location)</span><br><span class="line">label_classification = paddle.to_tensor(label_classification)</span><br><span class="line">scales = paddle.to_tensor(scale_location)</span><br><span class="line">label_objectness.stop_gradient=<span class="literal">True</span></span><br><span class="line">label_location.stop_gradient=<span class="literal">True</span></span><br><span class="line">label_classification.stop_gradient=<span class="literal">True</span></span><br><span class="line">scales.stop_gradient=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">total_loss = get_loss(P0, label_objectness, label_location, label_classification, scales,</span><br><span class="line">                          num_anchors=NUM_ANCHORS, num_classes=NUM_CLASSES)</span><br><span class="line">total_loss_data = total_loss.numpy()</span><br><span class="line"><span class="built_in">print</span>(total_loss_data)</span><br></pre></td></tr></table></figure>

<pre><code>[896.6715]
</code></pre>
<p>ä¸Šé¢çš„ç¨‹åºè®¡ç®—å‡ºäº†æ€»çš„æŸå¤±å‡½æ•°ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œè¯»è€…å·²ç»äº†è§£åˆ°äº†YOLOv3ç®—æ³•çš„å¤§éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬å¦‚ä½•ç”Ÿæˆé”šæ¡†ã€ç»™é”šæ¡†æ‰“ä¸Šæ ‡ç­¾ã€é€šè¿‡å·ç§¯ç¥ç»ç½‘ç»œæå–ç‰¹å¾ã€å°†è¾“å‡ºç‰¹å¾å›¾è·Ÿé¢„æµ‹æ¡†ç›¸å…³è”ã€å»ºç«‹èµ·æŸå¤±å‡½æ•°ã€‚</p>
<h2 id="6-å¤šå°ºåº¦æ£€æµ‹"><a href="#6-å¤šå°ºåº¦æ£€æµ‹" class="headerlink" title="6.å¤šå°ºåº¦æ£€æµ‹"></a><strong>6.å¤šå°ºåº¦æ£€æµ‹</strong></h2><p>ç›®å‰æˆ‘ä»¬è®¡ç®—æŸå¤±å‡½æ•°æ˜¯åœ¨ç‰¹å¾å›¾P0çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼Œå®ƒçš„æ­¥å¹…stride&#x3D;32ã€‚ç‰¹å¾å›¾çš„å°ºå¯¸æ¯”è¾ƒå°ï¼Œåƒç´ ç‚¹æ•°ç›®æ¯”è¾ƒå°‘ï¼Œæ¯ä¸ªåƒç´ ç‚¹çš„æ„Ÿå—é‡å¾ˆå¤§ï¼Œå…·æœ‰éå¸¸ä¸°å¯Œçš„é«˜å±‚çº§è¯­ä¹‰ä¿¡æ¯ï¼Œå¯èƒ½æ¯”è¾ƒå®¹æ˜“æ£€æµ‹åˆ°è¾ƒå¤§çš„ç›®æ ‡ã€‚ä¸ºäº†èƒ½å¤Ÿæ£€æµ‹åˆ°å°ºå¯¸è¾ƒå°çš„é‚£äº›ç›®æ ‡ï¼Œéœ€è¦åœ¨å°ºå¯¸è¾ƒå¤§çš„ç‰¹å¾å›¾ä¸Šé¢å»ºç«‹é¢„æµ‹è¾“å‡ºã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨C2æˆ–è€…C1è¿™ç§å±‚çº§çš„ç‰¹å¾å›¾ä¸Šç›´æ¥äº§ç”Ÿé¢„æµ‹è¾“å‡ºï¼Œå¯èƒ½é¢ä¸´æ–°çš„é—®é¢˜ï¼Œå®ƒä»¬æ²¡æœ‰ç»è¿‡å……åˆ†çš„ç‰¹å¾æå–ï¼Œåƒç´ ç‚¹åŒ…å«çš„è¯­ä¹‰ä¿¡æ¯ä¸å¤Ÿä¸°å¯Œï¼Œæœ‰å¯èƒ½éš¾ä»¥æå–åˆ°æœ‰æ•ˆçš„ç‰¹å¾æ¨¡å¼ã€‚åœ¨ç›®æ ‡æ£€æµ‹ä¸­ï¼Œè§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹å¼æ˜¯ï¼Œ<strong>å°†é«˜å±‚çº§çš„ç‰¹å¾å›¾å°ºå¯¸æ”¾å¤§ä¹‹åè·Ÿä½å±‚çº§çš„ç‰¹å¾å›¾è¿›è¡Œèåˆ</strong>ï¼Œå¾—åˆ°çš„æ–°ç‰¹å¾å›¾æ—¢èƒ½åŒ…å«ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯ï¼Œåˆå…·æœ‰è¾ƒå¤šçš„åƒç´ ç‚¹ï¼Œèƒ½å¤Ÿæè¿°æ›´åŠ ç²¾ç»†çš„ç»“æ„ã€‚</p>
<p>å…·ä½“çš„ç½‘ç»œå®ç°æ–¹å¼å¦‚ <strong>å›¾16</strong> æ‰€ç¤ºï¼š</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/b6d3b425644342e48bd0a50ebde90d882fd10717e0e44a53a44e98225bbb6df8" width = "800"></center>
<center><br>å›¾16ï¼šç”Ÿæˆå¤šå±‚çº§çš„è¾“å‡ºç‰¹å¾å›¾P0ã€P1ã€P2 </br></center>

<p><br></br></p>
<p>YOLOv3åœ¨æ¯ä¸ªåŒºåŸŸçš„ä¸­å¿ƒä½ç½®äº§ç”Ÿ3ä¸ªé”šæ¡†ï¼Œåœ¨3ä¸ªå±‚çº§çš„ç‰¹å¾å›¾ä¸Šäº§ç”Ÿé”šæ¡†çš„å¤§å°åˆ†åˆ«ä¸ºP2 [(10Ã—13),(16Ã—30),(33Ã—23)]ï¼ŒP1 [(30Ã—61),(62Ã—45),(59Ã— 119)]ï¼ŒP0[(116 Ã— 90), (156 Ã— 198), (373 Ã— 326]ã€‚è¶Šå¾€åçš„ç‰¹å¾å›¾ä¸Šç”¨åˆ°çš„é”šæ¡†å°ºå¯¸ä¹Ÿè¶Šå¤§ï¼Œèƒ½æ•æ‰åˆ°å¤§å°ºå¯¸ç›®æ ‡çš„ä¿¡æ¯ï¼›è¶Šå¾€å‰çš„ç‰¹å¾å›¾ä¸Šé”šæ¡†å°ºå¯¸è¶Šå°ï¼Œèƒ½æ•æ‰åˆ°å°å°ºå¯¸ç›®æ ‡çš„ä¿¡æ¯ã€‚</p>
<p>åœ¨å®Œæ•´ç½‘ç»œå®šä¹‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://www.paddlepaddle.org.cn/documentation/docs/zh/api/paddle/vision/ops/yolo_loss_cn.html#yolo-loss">paddle.vision.ops.yolo_loss</a> APIæ¥è®¡ç®—æŸå¤±å‡½æ•°ï¼Œè¯¥API å°†ä¸Šè¿°å€™é€‰åŒºåŸŸçš„æ ‡æ³¨ä»¥åŠå¤šå°ºåº¦çš„æŸå¤±å‡½æ•°è®¡ç®—ç»Ÿä¸€åœ°è¿›è¡Œäº†å°è£…ã€‚</p>
<blockquote>
<p>paddle.vision.ops.yolo_loss(x, gt_box, gt_label, anchors, anchor_mask, class_num, ignore_thresh, downsample_ratio, gt_score&#x3D;None, use_label_smooth&#x3D;True, name&#x3D;None, scale_x_y&#x3D;1.0)</p>
</blockquote>
<p>å…³é”®å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>x: è¾“å‡ºç‰¹å¾å›¾ã€‚</li>
<li>gt_box: çœŸå®æ¡†ã€‚</li>
<li>gt_label: çœŸå®æ¡†æ ‡ç­¾ã€‚</li>
<li>ignore_threshï¼Œé¢„æµ‹æ¡†ä¸çœŸå®æ¡†IoUé˜ˆå€¼è¶…è¿‡ignore_threshæ—¶ï¼Œä¸ä½œä¸ºè´Ÿæ ·æœ¬ï¼ŒYOLOv3æ¨¡å‹é‡Œè®¾ç½®ä¸º0.7ã€‚</li>
<li>downsample_ratioï¼Œç‰¹å¾å›¾P0çš„ä¸‹é‡‡æ ·æ¯”ä¾‹ï¼Œä½¿ç”¨Darknet53éª¨å¹²ç½‘ç»œæ—¶ä¸º32ã€‚</li>
<li>gt_scoreï¼ŒçœŸå®æ¡†çš„ç½®ä¿¡åº¦ï¼Œåœ¨ä½¿ç”¨äº†mixupï¼ˆæ··ç±»å¢å¼ºï¼‰æŠ€å·§æ—¶ç”¨åˆ°ã€‚</li>
<li>use_label_smoothï¼Œä¸€ç§è®­ç»ƒæŠ€å·§ï¼Œå¦‚ä¸ä½¿ç”¨ï¼Œè®¾ç½®ä¸ºFalseã€‚</li>
<li>nameï¼Œè¯¥å±‚çš„åå­—ï¼Œæ¯”å¦‚â€™yolov3_lossâ€™ï¼Œé»˜è®¤å€¼ä¸ºNoneï¼Œä¸€èˆ¬æ— éœ€è®¾ç½®ã€‚</li>
</ul>
<p>å¯¹äºä½¿ç”¨äº†å¤šå±‚çº§ç‰¹å¾å›¾äº§ç”Ÿé¢„æµ‹æ¡†çš„æ–¹æ³•ï¼Œå…¶å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ä¸Šé‡‡æ ·æ¨¡å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Upsample</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, scale=<span class="number">2</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Upsample,self).__init__()</span><br><span class="line">        self.scale = scale</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        <span class="comment"># è·å–ä¸Šé‡‡æ ·è¿‡ç¨‹ä¸­çš„åŠ¨æ€å°ºå¯¸</span></span><br><span class="line">        shape_nchw = paddle.shape(inputs)</span><br><span class="line">        <span class="comment"># paddle.slice(input, axes, starts, ends)ï¼šæ²¿å¤šä¸ªè½´ç”Ÿæˆ input çš„åˆ‡ç‰‡</span></span><br><span class="line">        shape_hw = paddle.<span class="built_in">slice</span>(shape_nchw, axes=[<span class="number">0</span>], starts=[<span class="number">2</span>], ends=[<span class="number">4</span>])</span><br><span class="line">        shape_hw.stop_gradient = <span class="literal">True</span></span><br><span class="line">        in_shape = paddle.cast(shape_hw, dtype=<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">        out_shape = in_shape * self.scale</span><br><span class="line">        out_shape.stop_gradient = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒæ•´ä¸€ä¸ª batch ä¸­å›¾ç‰‡çš„å¤§å°ï¼šNEAREST æœ€è¿‘é‚»æ’å€¼</span></span><br><span class="line">        out = paddle.nn.functional.interpolate(x=inputs, scale_factor=self.scale, mode=<span class="string">&quot;NEAREST&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YOLOv3</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes=<span class="number">7</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(YOLOv3,self).__init__()</span><br><span class="line"></span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line">        <span class="comment"># æå–å›¾åƒç‰¹å¾çš„éª¨å¹²ä»£ç </span></span><br><span class="line">        self.block = DarkNet53_conv_body()</span><br><span class="line">        self.block_outputs = []</span><br><span class="line">        self.yolo_blocks = []</span><br><span class="line">        self.route_blocks_2 = []</span><br><span class="line">        <span class="comment"># ç”Ÿæˆ3ä¸ªå±‚çº§çš„ç‰¹å¾å›¾P0, P1, P2</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            <span class="comment"># æ·»åŠ ä»ciç”Ÿæˆriå’Œtiçš„æ¨¡å—</span></span><br><span class="line">            yolo_block = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;yolo_detecton_block_%d&quot;</span> % (i),</span><br><span class="line">                YoloDetectionBlock(</span><br><span class="line">                                   ch_in=<span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span> <span class="keyword">if</span> i==<span class="number">0</span> <span class="keyword">else</span> <span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span> + <span class="number">512</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                   ch_out = <span class="number">512</span>//(<span class="number">2</span>**i)))</span><br><span class="line">            self.yolo_blocks.append(yolo_block)</span><br><span class="line"></span><br><span class="line">            num_filters = <span class="number">3</span> * (self.num_classes + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ·»åŠ ä»tiç”Ÿæˆpiçš„æ¨¡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªConv2Dæ“ä½œï¼Œè¾“å‡ºé€šé“æ•°ä¸º3 * (num_classes + 5)</span></span><br><span class="line">            block_out = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;block_out_%d&quot;</span> % (i),</span><br><span class="line">                paddle.nn.Conv2D(in_channels=<span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span>,</span><br><span class="line">                       out_channels=num_filters,</span><br><span class="line">                       kernel_size=<span class="number">1</span>,</span><br><span class="line">                       stride=<span class="number">1</span>,</span><br><span class="line">                       padding=<span class="number">0</span>,</span><br><span class="line">                       weight_attr=paddle.ParamAttr(</span><br><span class="line">                           initializer=paddle.nn.initializer.Normal(<span class="number">0.</span>, <span class="number">0.02</span>)),</span><br><span class="line">                       bias_attr=paddle.ParamAttr(</span><br><span class="line">                           initializer=paddle.nn.initializer.Constant(<span class="number">0.0</span>),</span><br><span class="line">                           regularizer=paddle.regularizer.L2Decay(<span class="number">0.</span>))))</span><br><span class="line">            self.block_outputs.append(block_out)</span><br><span class="line">            <span class="keyword">if</span> i &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œå·ç§¯</span></span><br><span class="line">                route = self.add_sublayer(<span class="string">&quot;route2_%d&quot;</span>%i,</span><br><span class="line">                                          ConvBNLayer(ch_in=<span class="number">512</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                                      ch_out=<span class="number">256</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                                      kernel_size=<span class="number">1</span>,</span><br><span class="line">                                                      stride=<span class="number">1</span>,</span><br><span class="line">                                                      padding=<span class="number">0</span>))</span><br><span class="line">                self.route_blocks_2.append(route)</span><br><span class="line">            <span class="comment"># å°†riæ”¾å¤§ä»¥ä¾¿è·Ÿc_&#123;i+1&#125;ä¿æŒåŒæ ·çš„å°ºå¯¸</span></span><br><span class="line">            self.upsample = Upsample()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        outputs = []</span><br><span class="line">        blocks = self.block(inputs)</span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">            <span class="keyword">if</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># å°†r_&#123;i-1&#125;ç»è¿‡å·ç§¯å’Œä¸Šé‡‡æ ·ä¹‹åå¾—åˆ°ç‰¹å¾å›¾ï¼Œä¸è¿™ä¸€çº§çš„ciè¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">                block = paddle.concat([route, block], axis=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># ä»ciç”Ÿæˆtiå’Œri</span></span><br><span class="line">            route, tip = self.yolo_blocks[i](block)</span><br><span class="line">            <span class="comment"># ä»tiç”Ÿæˆpi</span></span><br><span class="line">            block_out = self.block_outputs[i](tip)</span><br><span class="line">            <span class="comment"># å°†piæ”¾å…¥åˆ—è¡¨</span></span><br><span class="line">            outputs.append(block_out)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> i &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œå·ç§¯è°ƒæ•´é€šé“æ•°</span></span><br><span class="line">                route = self.route_blocks_2[i](route)</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œæ”¾å¤§ï¼Œä½¿å…¶å°ºå¯¸å’Œc_&#123;i+1&#125;ä¿æŒä¸€è‡´</span></span><br><span class="line">                route = self.upsample(route)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_loss</span>(<span class="params">self, outputs, gtbox, gtlabel, gtscore=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 anchors = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span></span><br><span class="line"><span class="params">                 anchor_masks = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]],</span></span><br><span class="line"><span class="params">                 ignore_thresh=<span class="number">0.7</span>,</span></span><br><span class="line"><span class="params">                 use_label_smooth=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨ paddle.vision.ops.yolo_lossï¼Œç›´æ¥è®¡ç®—æŸå¤±å‡½æ•°ï¼Œè¿‡ç¨‹æ›´ç®€æ´ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.losses = []</span><br><span class="line">        downsample = <span class="number">32</span></span><br><span class="line">        <span class="keyword">for</span> i, out <span class="keyword">in</span> <span class="built_in">enumerate</span>(outputs): <span class="comment"># å¯¹ä¸‰ä¸ªå±‚çº§åˆ†åˆ«æ±‚æŸå¤±å‡½æ•°</span></span><br><span class="line">            anchor_mask_i = anchor_masks[i]</span><br><span class="line">            loss = paddle.vision.ops.yolo_loss(</span><br><span class="line">                    x=out,  <span class="comment"># outæ˜¯P0, P1, P2ä¸­çš„ä¸€ä¸ª</span></span><br><span class="line">                    gt_box=gtbox,  <span class="comment"># çœŸå®æ¡†åæ ‡</span></span><br><span class="line">                    gt_label=gtlabel,  <span class="comment"># çœŸå®æ¡†ç±»åˆ«</span></span><br><span class="line">                    gt_score=gtscore,  <span class="comment"># çœŸå®æ¡†å¾—åˆ†ï¼Œä½¿ç”¨mixupè®­ç»ƒæŠ€å·§æ—¶éœ€è¦ï¼Œä¸ä½¿ç”¨è¯¥æŠ€å·§æ—¶ç›´æ¥è®¾ç½®ä¸º1ï¼Œå½¢çŠ¶ä¸gtlabelç›¸åŒ</span></span><br><span class="line">                    anchors=anchors,   <span class="comment"># é”šæ¡†å°ºå¯¸ï¼ŒåŒ…å«[w0, h0, w1, h1, ..., w8, h8]å…±9ä¸ªé”šæ¡†çš„å°ºå¯¸</span></span><br><span class="line">                    anchor_mask=anchor_mask_i, <span class="comment"># ç­›é€‰é”šæ¡†çš„maskï¼Œä¾‹å¦‚anchor_mask_i=[3, 4, 5]ï¼Œå°†anchorsä¸­ç¬¬3ã€4ã€5ä¸ªé”šæ¡†æŒ‘é€‰å‡ºæ¥ç»™è¯¥å±‚çº§ä½¿ç”¨</span></span><br><span class="line">                    class_num=self.num_classes, <span class="comment"># åˆ†ç±»ç±»åˆ«æ•°</span></span><br><span class="line">                    ignore_thresh=ignore_thresh, <span class="comment"># å½“é¢„æµ‹æ¡†ä¸çœŸå®æ¡†IoU &gt; ignore_threshï¼Œæ ‡æ³¨objectness = -1</span></span><br><span class="line">                    downsample_ratio=downsample, <span class="comment"># ç‰¹å¾å›¾ç›¸å¯¹äºåŸå›¾ç¼©å°çš„å€æ•°ï¼Œä¾‹å¦‚P0æ˜¯32ï¼Œ P1æ˜¯16ï¼ŒP2æ˜¯8</span></span><br><span class="line">                    use_label_smooth=<span class="literal">False</span>)      <span class="comment"># ä½¿ç”¨label_smoothè®­ç»ƒæŠ€å·§æ—¶ä¼šç”¨åˆ°ï¼Œè¿™é‡Œæ²¡ç”¨æ­¤æŠ€å·§ï¼Œç›´æ¥è®¾ç½®ä¸ºFalse</span></span><br><span class="line">            self.losses.append(paddle.mean(loss))  <span class="comment">#meanå¯¹æ¯å¼ å›¾ç‰‡æ±‚å’Œ</span></span><br><span class="line">            downsample = downsample // <span class="number">2</span> <span class="comment"># ä¸‹ä¸€çº§ç‰¹å¾å›¾çš„ç¼©æ”¾å€æ•°ä¼šå‡åŠ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(self.losses) <span class="comment"># å¯¹æ¯ä¸ªå±‚çº§æ±‚å’Œ</span></span><br></pre></td></tr></table></figure>

<h2 id="7-å¼€å¯ç«¯åˆ°ç«¯è®­ç»ƒ"><a href="#7-å¼€å¯ç«¯åˆ°ç«¯è®­ç»ƒ" class="headerlink" title="7.å¼€å¯ç«¯åˆ°ç«¯è®­ç»ƒ"></a><strong>7.å¼€å¯ç«¯åˆ°ç«¯è®­ç»ƒ</strong></h2><p>è®­ç»ƒè¿‡ç¨‹å¦‚ <strong>å›¾17</strong> æ‰€ç¤ºï¼Œè¾“å…¥å›¾ç‰‡ç»è¿‡ç‰¹å¾æå–å¾—åˆ°ä¸‰ä¸ªå±‚çº§çš„è¾“å‡ºç‰¹å¾å›¾P0(stride&#x3D;32)ã€P1(stride&#x3D;16)å’ŒP2(stride&#x3D;8)ï¼Œç›¸åº”çš„åˆ†åˆ«ä½¿ç”¨ä¸åŒå¤§å°çš„å°æ–¹å—åŒºåŸŸå»ç”Ÿæˆå¯¹åº”çš„é”šæ¡†å’Œé¢„æµ‹æ¡†ï¼Œå¹¶å¯¹è¿™äº›é”šæ¡†è¿›è¡Œæ ‡æ³¨ã€‚</p>
<ul>
<li><p>P0å±‚çº§ç‰¹å¾å›¾ï¼Œå¯¹åº”ç€ä½¿ç”¨$32\times32$å¤§å°çš„å°æ–¹å—ï¼Œåœ¨æ¯ä¸ªåŒºåŸŸä¸­å¿ƒç”Ÿæˆå¤§å°åˆ†åˆ«ä¸º$[116, 90]$, $[156, 198]$, $[373, 326]$çš„ä¸‰ç§é”šæ¡†ã€‚</p>
</li>
<li><p>P1å±‚çº§ç‰¹å¾å›¾ï¼Œå¯¹åº”ç€ä½¿ç”¨$16\times16$å¤§å°çš„å°æ–¹å—ï¼Œåœ¨æ¯ä¸ªåŒºåŸŸä¸­å¿ƒç”Ÿæˆå¤§å°åˆ†åˆ«ä¸º$[30, 61]$, $[62, 45]$, $[59, 119]$çš„ä¸‰ç§é”šæ¡†ã€‚</p>
</li>
<li><p>P2å±‚çº§ç‰¹å¾å›¾ï¼Œå¯¹åº”ç€ä½¿ç”¨$8\times8$å¤§å°çš„å°æ–¹å—ï¼Œåœ¨æ¯ä¸ªåŒºåŸŸä¸­å¿ƒç”Ÿæˆå¤§å°åˆ†åˆ«ä¸º$[10, 13]$, $[16, 30]$, $[33, 23]$çš„ä¸‰ç§é”šæ¡†ã€‚</p>
</li>
</ul>
<p>å°†ä¸‰ä¸ªå±‚çº§çš„ç‰¹å¾å›¾ä¸å¯¹åº”é”šæ¡†ä¹‹é—´çš„æ ‡ç­¾å…³è”èµ·æ¥ï¼Œå¹¶å»ºç«‹æŸå¤±å‡½æ•°ï¼Œæ€»çš„æŸå¤±å‡½æ•°ç­‰äºä¸‰ä¸ªå±‚çº§çš„æŸå¤±å‡½æ•°ç›¸åŠ ã€‚é€šè¿‡æå°åŒ–æŸå¤±å‡½æ•°ï¼Œå¯ä»¥å¼€å¯ç«¯åˆ°ç«¯çš„è®­ç»ƒè¿‡ç¨‹ã€‚</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/736da9cd3a4f4a1c98187a6cdf1a0334af73470b6d7c4b2fbaa9660d4bd20621" width = "600"></center>
<center><br>å›¾17ï¼šç«¯åˆ°ç«¯è®­ç»ƒæµç¨‹ </br></center>

<p><br></br></p>
<p>è®­ç»ƒè¿‡ç¨‹çš„å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############# è¿™æ®µä»£ç è¿è¡Œå‰ï¼šè¯·é‡å¯é¡¹ç›®ç¯å¢ƒï¼ˆGPUï¼‰#######################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"></span><br><span class="line">ANCHORS = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line">ANCHOR_MASKS = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line">IGNORE_THRESH = <span class="number">.7</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lr</span>(<span class="params">base_lr = <span class="number">0.0001</span>, lr_decay = <span class="number">0.1</span></span>):</span><br><span class="line">    bd = [<span class="number">10000</span>, <span class="number">20000</span>]</span><br><span class="line">    lr = [base_lr, base_lr * lr_decay, base_lr * lr_decay * lr_decay]</span><br><span class="line">    learning_rate = paddle.optimizer.lr.PiecewiseDecay(boundaries=bd, values=lr)</span><br><span class="line">    <span class="keyword">return</span> learning_rate</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    TRAINDIR = <span class="string">&#x27;/home/aistudio/work/insects/train&#x27;</span></span><br><span class="line">    TESTDIR = <span class="string">&#x27;/home/aistudio/work/insects/test&#x27;</span></span><br><span class="line">    VALIDDIR = <span class="string">&#x27;/home/aistudio/work/insects/val&#x27;</span></span><br><span class="line">    paddle.set_device(<span class="string">&quot;gpu:0&quot;</span>)</span><br><span class="line">    <span class="comment"># åˆ›å»ºæ•°æ®è¯»å–ç±»</span></span><br><span class="line">    train_dataset = TrainDataset(TRAINDIR, mode=<span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    valid_dataset = TrainDataset(VALIDDIR, mode=<span class="string">&#x27;valid&#x27;</span>)</span><br><span class="line">    test_dataset = TrainDataset(VALIDDIR, mode=<span class="string">&#x27;valid&#x27;</span>)</span><br><span class="line">    <span class="comment"># ä½¿ç”¨paddle.io.DataLoaderåˆ›å»ºæ•°æ®è¯»å–å™¨ï¼Œå¹¶è®¾ç½®batchsizeï¼Œè¿›ç¨‹æ•°é‡num_workersç­‰å‚æ•°</span></span><br><span class="line">    train_loader = paddle.io.DataLoader(train_dataset, batch_size=<span class="number">4</span>, shuffle=<span class="literal">True</span>, num_workers=<span class="number">0</span>, drop_last=<span class="literal">True</span>, use_shared_memory=<span class="literal">False</span>)</span><br><span class="line">    valid_loader = paddle.io.DataLoader(valid_dataset, batch_size=<span class="number">4</span>, shuffle=<span class="literal">False</span>, num_workers=<span class="number">0</span>, drop_last=<span class="literal">False</span>, use_shared_memory=<span class="literal">False</span>)</span><br><span class="line">    model = YOLOv3(num_classes = NUM_CLASSES)    <span class="comment"># åˆ›å»ºæ¨¡å‹</span></span><br><span class="line">    learning_rate = get_lr()</span><br><span class="line">    opt = paddle.optimizer.Momentum(</span><br><span class="line">                 learning_rate=learning_rate,</span><br><span class="line">                 momentum=<span class="number">0.9</span>,</span><br><span class="line">                 weight_decay=paddle.regularizer.L2Decay(<span class="number">0.0005</span>),</span><br><span class="line">                 parameters=model.parameters())  <span class="comment"># åˆ›å»ºä¼˜åŒ–å™¨</span></span><br><span class="line">    <span class="comment"># opt = paddle.optimizer.Adam(learning_rate=learning_rate, weight_decay=paddle.regularizer.L2Decay(0.0005), parameters=model.parameters())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">####è¿­ä»£å‘¨æœŸæ•°è‡ªè¡Œè°ƒæ•´######</span></span><br><span class="line"></span><br><span class="line">    MAX_EPOCH = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(MAX_EPOCH):</span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader()):</span><br><span class="line">            img, gt_boxes, gt_labels, img_scale = data</span><br><span class="line">            gt_scores = np.ones(gt_labels.shape).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">            gt_scores = paddle.to_tensor(gt_scores)</span><br><span class="line">            img = paddle.to_tensor(img)</span><br><span class="line">            gt_boxes = paddle.to_tensor(gt_boxes)</span><br><span class="line">            gt_labels = paddle.to_tensor(gt_labels)</span><br><span class="line">            outputs = model(img)  <span class="comment"># å‰å‘ä¼ æ’­ï¼Œè¾“å‡º[P0, P1, P2]</span></span><br><span class="line">            loss = model.get_loss(outputs, gt_boxes, gt_labels, gtscore=gt_scores,</span><br><span class="line">                                  anchors = ANCHORS,</span><br><span class="line">                                  anchor_masks = ANCHOR_MASKS,</span><br><span class="line">                                  ignore_thresh=IGNORE_THRESH,</span><br><span class="line">                                  use_label_smooth=<span class="literal">False</span>)        <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">            loss.backward()    <span class="comment"># åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">            opt.step()         <span class="comment"># æ›´æ–°å‚æ•°</span></span><br><span class="line">            opt.clear_grad()</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                timestring = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,time.localtime(time.time()))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;[TRAIN]epoch &#123;&#125;, iter &#123;&#125;, output loss: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(timestring, epoch, i, loss.numpy()))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save params of model</span></span><br><span class="line">        <span class="keyword">if</span> (epoch % <span class="number">5</span> == <span class="number">0</span>) <span class="keyword">or</span> (epoch == MAX_EPOCH -<span class="number">1</span>):</span><br><span class="line">            paddle.save(model.state_dict(), <span class="string">&#x27;yolo_epoch&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(epoch))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¯ä¸ªepochç»“æŸä¹‹ååœ¨éªŒè¯é›†ä¸Šè¿›è¡Œæµ‹è¯•</span></span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(valid_loader()):</span><br><span class="line">            img, gt_boxes, gt_labels, img_scale = data</span><br><span class="line">            gt_scores = np.ones(gt_labels.shape).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">            gt_scores = paddle.to_tensor(gt_scores)</span><br><span class="line">            img = paddle.to_tensor(img)</span><br><span class="line">            gt_boxes = paddle.to_tensor(gt_boxes)</span><br><span class="line">            gt_labels = paddle.to_tensor(gt_labels)</span><br><span class="line">            outputs = model(img)</span><br><span class="line">            loss = model.get_loss(outputs, gt_boxes, gt_labels, gtscore=gt_scores,</span><br><span class="line">                                  anchors = ANCHORS,</span><br><span class="line">                                  anchor_masks = ANCHOR_MASKS,</span><br><span class="line">                                  ignore_thresh=IGNORE_THRESH,</span><br><span class="line">                                  use_label_smooth=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                timestring = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,time.localtime(time.time()))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;[VALID]epoch &#123;&#125;, iter &#123;&#125;, output loss: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(timestring, epoch, i, loss.numpy()))</span><br><span class="line">        model.train()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">paddle.save(model.state_dict(), <span class="string">&quot;linear_net.pdparams&quot;</span>)</span><br><span class="line">paddle.save(opt.state_dict(), <span class="string">&quot;opt.pdopt&quot;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load</span></span><br><span class="line"><span class="comment"># layer_state_dict = paddle.load(&quot;linear_net.pdparams&quot;)</span></span><br><span class="line"><span class="comment"># opt_state_dict = paddle.load(&quot;opt.pdopt&quot;)</span></span><br><span class="line"><span class="comment"># layer.set_state_dict(layer_state_dict)</span></span><br><span class="line"><span class="comment"># opt.set_state_dict(opt_state_dict)</span></span><br></pre></td></tr></table></figure>

<h2 id="8-é¢„æµ‹"><a href="#8-é¢„æµ‹" class="headerlink" title="8.é¢„æµ‹"></a><strong>8.é¢„æµ‹</strong></h2><p>é¢„æµ‹è¿‡ç¨‹æµç¨‹ <strong>å›¾18</strong> å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><br></br></p>
<center><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-studio-static-online.cdn.bcebos.com/15c140b1844d419cbe237b1a70f4099266aa168c05dc413f8e232f688050fa75" width = "400"></center>
<center><br>å›¾18ï¼šé¢„æµ‹æµç¨‹ </br></center>

<p><br></br></p>
<p><strong>é¢„æµ‹è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤æ­¥</strong>ï¼š</p>
<ol>
<li>é€šè¿‡ç½‘ç»œè¾“å‡ºè®¡ç®—å‡ºé¢„æµ‹æ¡†ä½ç½®å’Œæ‰€å±ç±»åˆ«çš„å¾—åˆ†ã€‚ </li>
<li>ä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶æ¥æ¶ˆé™¤é‡å è¾ƒå¤§çš„é¢„æµ‹æ¡†ã€‚</li>
</ol>
<p>å¯¹äºç¬¬1æ­¥ï¼Œå‰é¢æˆ‘ä»¬å·²ç»è®²è¿‡å¦‚ä½•é€šè¿‡ç½‘ç»œè¾“å‡ºå€¼è®¡ç®—pred_objectness_probability, pred_boxesä»¥åŠpred_classification_probabilityï¼Œè¿™é‡Œæ¨èå¤§å®¶ç›´æ¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://www.paddlepaddle.org.cn/documentation/docs/zh/api/paddle/vision/ops/yolo_box_cn.html#yolo-box">paddle.vision.ops.yolo_box</a>ï¼Œå…³é”®å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p>
<p><code>paddle.vision.ops.yolo_box(x, img_size, anchors, class_num, conf_thresh, downsample_ratio, clip_bbox=True, name=None, scale_x_y=1.0)</code></p>
<ul>
<li>xï¼Œç½‘ç»œè¾“å‡ºç‰¹å¾å›¾ï¼Œä¾‹å¦‚ä¸Šé¢æåˆ°çš„P0æˆ–è€…P1ã€P2ã€‚</li>
<li>img_sizeï¼Œè¾“å…¥å›¾ç‰‡å°ºå¯¸ã€‚</li>
<li>anchorsï¼Œä½¿ç”¨åˆ°çš„anchorçš„å°ºå¯¸ï¼Œå¦‚[10, 13, 16, 30, 33, 23, 30, 61, 62, 45, 59, 119, 116, 90, 156, 198, 373, 326]</li>
<li>class_numï¼Œç‰©ä½“ç±»åˆ«æ•°ã€‚</li>
<li>conf_thresh, ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œå¾—åˆ†ä½äºè¯¥é˜ˆå€¼çš„é¢„æµ‹æ¡†ä½ç½®æ•°å€¼ä¸ç”¨è®¡ç®—ç›´æ¥è®¾ç½®ä¸º0.0ã€‚</li>
<li>downsample_ratio, ç‰¹å¾å›¾çš„ä¸‹é‡‡æ ·æ¯”ä¾‹ï¼Œä¾‹å¦‚P0æ˜¯32ï¼ŒP1æ˜¯16ï¼ŒP2æ˜¯8ã€‚</li>
<li>name&#x3D;Noneï¼Œåå­—ï¼Œä¾‹å¦‚â€™yolo_boxâ€™ï¼Œä¸€èˆ¬æ— éœ€è®¾ç½®ï¼Œé»˜è®¤å€¼ä¸ºNoneã€‚</li>
</ul>
<p>è¿”å›å€¼åŒ…æ‹¬ä¸¤é¡¹ï¼Œ<code>boxes</code>å’Œ<code>scores</code>ï¼Œå…¶ä¸­<code>boxes</code>æ˜¯æ‰€æœ‰é¢„æµ‹æ¡†çš„åæ ‡å€¼ï¼Œ<code>scores</code>æ˜¯æ‰€æœ‰é¢„æµ‹æ¡†çš„å¾—åˆ†ã€‚</p>
<p>é¢„æµ‹æ¡†å¾—åˆ†çš„å®šä¹‰æ˜¯æ‰€å±ç±»åˆ«çš„æ¦‚ç‡ä¹˜ä»¥å…¶é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç›®æ ‡ç‰©ä½“çš„objectnessæ¦‚ç‡ï¼Œå³</p>
<p>$$score &#x3D; P_{obj} \cdot P_{classification}$$</p>
<p>åœ¨ä¸Šé¢å®šä¹‰çš„ç±»YOLOv3ä¸‹é¢æ·»åŠ å‡½æ•°<code>get_pred</code>ï¼Œé€šè¿‡è°ƒç”¨<code>paddle.vision.ops.yolo_box</code>è·å¾—P0ã€P1ã€P2ä¸‰ä¸ªå±‚çº§çš„ç‰¹å¾å›¾å¯¹åº”çš„é¢„æµ‹æ¡†å’Œå¾—åˆ†ï¼Œå¹¶å°†ä»–ä»¬æ‹¼æ¥åœ¨ä¸€å—ï¼Œå³å¯å¾—åˆ°æ‰€æœ‰çš„é¢„æµ‹æ¡†åŠå…¶å±äºå„ä¸ªç±»åˆ«çš„å¾—åˆ†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰YOLOv3æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YOLOv3</span>(paddle.nn.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes=<span class="number">7</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(YOLOv3,self).__init__()</span><br><span class="line"></span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line">        <span class="comment"># æå–å›¾åƒç‰¹å¾çš„éª¨å¹²ä»£ç </span></span><br><span class="line">        self.block = DarkNet53_conv_body()</span><br><span class="line">        self.block_outputs = []</span><br><span class="line">        self.yolo_blocks = []</span><br><span class="line">        self.route_blocks_2 = []</span><br><span class="line">        <span class="comment"># ç”Ÿæˆ3ä¸ªå±‚çº§çš„ç‰¹å¾å›¾P0, P1, P2</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            <span class="comment"># æ·»åŠ ä»ciç”Ÿæˆriå’Œtiçš„æ¨¡å—</span></span><br><span class="line">            yolo_block = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;yolo_detecton_block_%d&quot;</span> % (i),</span><br><span class="line">                YoloDetectionBlock(</span><br><span class="line">                                   ch_in=<span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span> <span class="keyword">if</span> i==<span class="number">0</span> <span class="keyword">else</span> <span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span> + <span class="number">512</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                   ch_out = <span class="number">512</span>//(<span class="number">2</span>**i)))</span><br><span class="line">            self.yolo_blocks.append(yolo_block)</span><br><span class="line"></span><br><span class="line">            num_filters = <span class="number">3</span> * (self.num_classes + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ·»åŠ ä»tiç”Ÿæˆpiçš„æ¨¡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªConv2Dæ“ä½œï¼Œè¾“å‡ºé€šé“æ•°ä¸º3 * (num_classes + 5)</span></span><br><span class="line">            block_out = self.add_sublayer(</span><br><span class="line">                <span class="string">&quot;block_out_%d&quot;</span> % (i),</span><br><span class="line">                paddle.nn.Conv2D(in_channels=<span class="number">512</span>//(<span class="number">2</span>**i)*<span class="number">2</span>,</span><br><span class="line">                       out_channels=num_filters,</span><br><span class="line">                       kernel_size=<span class="number">1</span>,</span><br><span class="line">                       stride=<span class="number">1</span>,</span><br><span class="line">                       padding=<span class="number">0</span>,</span><br><span class="line">                       weight_attr=paddle.ParamAttr(</span><br><span class="line">                           initializer=paddle.nn.initializer.Normal(<span class="number">0.</span>, <span class="number">0.02</span>)),</span><br><span class="line">                       bias_attr=paddle.ParamAttr(</span><br><span class="line">                           initializer=paddle.nn.initializer.Constant(<span class="number">0.0</span>),</span><br><span class="line">                           regularizer=paddle.regularizer.L2Decay(<span class="number">0.</span>))))</span><br><span class="line">            self.block_outputs.append(block_out)</span><br><span class="line">            <span class="keyword">if</span> i &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œå·ç§¯</span></span><br><span class="line">                route = self.add_sublayer(<span class="string">&quot;route2_%d&quot;</span>%i,</span><br><span class="line">                                          ConvBNLayer(ch_in=<span class="number">512</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                                      ch_out=<span class="number">256</span>//(<span class="number">2</span>**i),</span><br><span class="line">                                                      kernel_size=<span class="number">1</span>,</span><br><span class="line">                                                      stride=<span class="number">1</span>,</span><br><span class="line">                                                      padding=<span class="number">0</span>))</span><br><span class="line">                self.route_blocks_2.append(route)</span><br><span class="line">            <span class="comment"># å°†riæ”¾å¤§ä»¥ä¾¿è·Ÿc_&#123;i+1&#125;ä¿æŒåŒæ ·çš„å°ºå¯¸</span></span><br><span class="line">            self.upsample = Upsample()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        outputs = []</span><br><span class="line">        blocks = self.block(inputs)</span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">            <span class="keyword">if</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># å°†r_&#123;i-1&#125;ç»è¿‡å·ç§¯å’Œä¸Šé‡‡æ ·ä¹‹åå¾—åˆ°ç‰¹å¾å›¾ï¼Œä¸è¿™ä¸€çº§çš„ciè¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">                block = paddle.concat([route, block], axis=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># ä»ciç”Ÿæˆtiå’Œri</span></span><br><span class="line">            route, tip = self.yolo_blocks[i](block)</span><br><span class="line">            <span class="comment"># ä»tiç”Ÿæˆpi</span></span><br><span class="line">            block_out = self.block_outputs[i](tip)</span><br><span class="line">            <span class="comment"># å°†piæ”¾å…¥åˆ—è¡¨</span></span><br><span class="line">            outputs.append(block_out)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> i &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œå·ç§¯è°ƒæ•´é€šé“æ•°</span></span><br><span class="line">                route = self.route_blocks_2[i](route)</span><br><span class="line">                <span class="comment"># å¯¹riè¿›è¡Œæ”¾å¤§ï¼Œä½¿å…¶å°ºå¯¸å’Œc_&#123;i+1&#125;ä¿æŒä¸€è‡´</span></span><br><span class="line">                route = self.upsample(route)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_loss</span>(<span class="params">self, outputs, gtbox, gtlabel, gtscore=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 anchors = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span></span><br><span class="line"><span class="params">                 anchor_masks = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]],</span></span><br><span class="line"><span class="params">                 ignore_thresh=<span class="number">0.7</span>,</span></span><br><span class="line"><span class="params">                 use_label_smooth=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨paddle.vision.ops.yolo_lossï¼Œç›´æ¥è®¡ç®—æŸå¤±å‡½æ•°ï¼Œè¿‡ç¨‹æ›´ç®€æ´ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.losses = []</span><br><span class="line">        downsample = <span class="number">32</span></span><br><span class="line">        <span class="keyword">for</span> i, out <span class="keyword">in</span> <span class="built_in">enumerate</span>(outputs): <span class="comment"># å¯¹ä¸‰ä¸ªå±‚çº§åˆ†åˆ«æ±‚æŸå¤±å‡½æ•°</span></span><br><span class="line">            anchor_mask_i = anchor_masks[i]</span><br><span class="line">            loss = paddle.vision.ops.yolo_loss(</span><br><span class="line">                    x=out,  <span class="comment"># outæ˜¯P0, P1, P2ä¸­çš„ä¸€ä¸ª</span></span><br><span class="line">                    gt_box=gtbox,  <span class="comment"># çœŸå®æ¡†åæ ‡</span></span><br><span class="line">                    gt_label=gtlabel,  <span class="comment"># çœŸå®æ¡†ç±»åˆ«</span></span><br><span class="line">                    gt_score=gtscore,  <span class="comment"># çœŸå®æ¡†å¾—åˆ†ï¼Œä½¿ç”¨mixupè®­ç»ƒæŠ€å·§æ—¶éœ€è¦ï¼Œä¸ä½¿ç”¨è¯¥æŠ€å·§æ—¶ç›´æ¥è®¾ç½®ä¸º1ï¼Œå½¢çŠ¶ä¸gtlabelç›¸åŒ</span></span><br><span class="line">                    anchors=anchors,   <span class="comment"># é”šæ¡†å°ºå¯¸ï¼ŒåŒ…å«[w0, h0, w1, h1, ..., w8, h8]å…±9ä¸ªé”šæ¡†çš„å°ºå¯¸</span></span><br><span class="line">                    anchor_mask=anchor_mask_i, <span class="comment"># ç­›é€‰é”šæ¡†çš„maskï¼Œä¾‹å¦‚anchor_mask_i=[3, 4, 5]ï¼Œå°†anchorsä¸­ç¬¬3ã€4ã€5ä¸ªé”šæ¡†æŒ‘é€‰å‡ºæ¥ç»™è¯¥å±‚çº§ä½¿ç”¨</span></span><br><span class="line">                    class_num=self.num_classes, <span class="comment"># åˆ†ç±»ç±»åˆ«æ•°</span></span><br><span class="line">                    ignore_thresh=ignore_thresh, <span class="comment"># å½“é¢„æµ‹æ¡†ä¸çœŸå®æ¡†IoU &gt; ignore_threshï¼Œæ ‡æ³¨objectness = -1</span></span><br><span class="line">                    downsample_ratio=downsample, <span class="comment"># ç‰¹å¾å›¾ç›¸å¯¹äºåŸå›¾ç¼©å°çš„å€æ•°ï¼Œä¾‹å¦‚P0æ˜¯32ï¼Œ P1æ˜¯16ï¼ŒP2æ˜¯8</span></span><br><span class="line">                    use_label_smooth=<span class="literal">False</span>)      <span class="comment"># ä½¿ç”¨label_smoothè®­ç»ƒæŠ€å·§æ—¶ä¼šç”¨åˆ°ï¼Œè¿™é‡Œæ²¡ç”¨æ­¤æŠ€å·§ï¼Œç›´æ¥è®¾ç½®ä¸ºFalse</span></span><br><span class="line">            self.losses.append(paddle.mean(loss))  <span class="comment">#meanå¯¹æ¯å¼ å›¾ç‰‡æ±‚å’Œ</span></span><br><span class="line">            downsample = downsample // <span class="number">2</span> <span class="comment"># ä¸‹ä¸€çº§ç‰¹å¾å›¾çš„ç¼©æ”¾å€æ•°ä¼šå‡åŠ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(self.losses) <span class="comment"># å¯¹æ¯ä¸ªå±‚çº§æ±‚å’Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_pred</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 outputs,</span></span><br><span class="line"><span class="params">                 im_shape=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 anchors = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>],</span></span><br><span class="line"><span class="params">                 anchor_masks = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]],</span></span><br><span class="line"><span class="params">                 valid_thresh = <span class="number">0.01</span></span>):</span><br><span class="line">        downsample = <span class="number">32</span></span><br><span class="line">        total_boxes = []</span><br><span class="line">        total_scores = []</span><br><span class="line">        <span class="keyword">for</span> i, out <span class="keyword">in</span> <span class="built_in">enumerate</span>(outputs):</span><br><span class="line">            anchor_mask = anchor_masks[i]</span><br><span class="line">            anchors_this_level = []</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> anchor_mask:</span><br><span class="line">                anchors_this_level.append(anchors[<span class="number">2</span> * m])</span><br><span class="line">                anchors_this_level.append(anchors[<span class="number">2</span> * m + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            boxes, scores = paddle.vision.ops.yolo_box(</span><br><span class="line">                   x=out,</span><br><span class="line">                   img_size=im_shape,</span><br><span class="line">                   anchors=anchors_this_level,</span><br><span class="line">                   class_num=self.num_classes,</span><br><span class="line">                   conf_thresh=valid_thresh,</span><br><span class="line">                   downsample_ratio=downsample,</span><br><span class="line">                   name=<span class="string">&quot;yolo_box&quot;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">            total_boxes.append(boxes)</span><br><span class="line">            total_scores.append(</span><br><span class="line">                        paddle.transpose(</span><br><span class="line">                        scores, perm=[<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>]))</span><br><span class="line">            downsample = downsample // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        yolo_boxes = paddle.concat(total_boxes, axis=<span class="number">1</span>)</span><br><span class="line">        yolo_scores = paddle.concat(total_scores, axis=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> yolo_boxes, yolo_scores</span><br></pre></td></tr></table></figure>

<p>ç¬¬1æ­¥çš„è®¡ç®—ç»“æœä¼šåœ¨æ¯ä¸ªå°æ–¹å—åŒºåŸŸä¸Šç”Ÿæˆå¤šä¸ªé¢„æµ‹æ¡†ï¼Œè€Œè¿™äº›é¢„æµ‹æ¡†ä¸­å¾ˆå¤šéƒ½æœ‰è¾ƒå¤§çš„é‡åˆåº¦ï¼Œå› æ­¤éœ€è¦æ¶ˆé™¤é‡å è¾ƒå¤§çš„å†—ä½™æ£€æµ‹æ¡†ã€‚</p>
<p>ä¸‹é¢ç¤ºä¾‹ä»£ç ä¸­çš„é¢„æµ‹æ¡†æ˜¯ä½¿ç”¨æ¨¡å‹å¯¹å›¾ç‰‡é¢„æµ‹ä¹‹åè¾“å‡ºçš„ï¼Œè¿™é‡Œä¸€å…±é€‰å‡ºäº†11ä¸ªé¢„æµ‹æ¡†ï¼Œåœ¨å›¾ä¸Šç”»å‡ºé¢„æµ‹æ¡†å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨æ¯ä¸ªäººåƒå‘¨å›´ï¼Œéƒ½å‡ºç°äº†å¤šä¸ªé¢„æµ‹æ¡†ï¼Œéœ€è¦æ¶ˆé™¤å†—ä½™çš„é¢„æµ‹æ¡†ä»¥å¾—åˆ°æœ€ç»ˆçš„é¢„æµ‹ç»“æœã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”»å›¾å±•ç¤ºç›®æ ‡ç‰©ä½“è¾¹ç•Œæ¡†</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.patches <span class="keyword">as</span> patches</span><br><span class="line"><span class="keyword">from</span> matplotlib.image <span class="keyword">import</span> imread</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç”»çŸ©å½¢æ¡†çš„ç¨‹åº    </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_rectangle</span>(<span class="params">currentAxis, bbox, edgecolor = <span class="string">&#x27;k&#x27;</span>, facecolor = <span class="string">&#x27;y&#x27;</span>, fill=<span class="literal">False</span>, linestyle=<span class="string">&#x27;-&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># currentAxisï¼Œåæ ‡è½´ï¼Œé€šè¿‡plt.gca()è·å–</span></span><br><span class="line">    <span class="comment"># bboxï¼Œè¾¹ç•Œæ¡†ï¼ŒåŒ…å«å››ä¸ªæ•°å€¼çš„listï¼Œ [x1, y1, x2, y2]</span></span><br><span class="line">    <span class="comment"># edgecolorï¼Œè¾¹æ¡†çº¿æ¡é¢œè‰²</span></span><br><span class="line">    <span class="comment"># facecolorï¼Œå¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment"># fill, æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment"># linestypeï¼Œè¾¹æ¡†çº¿å‹</span></span><br><span class="line">    <span class="comment"># patches.Rectangleéœ€è¦ä¼ å…¥å·¦ä¸Šè§’åæ ‡ã€çŸ©å½¢åŒºåŸŸçš„å®½åº¦ã€é«˜åº¦ç­‰å‚æ•°</span></span><br><span class="line">    rect=patches.Rectangle((bbox[<span class="number">0</span>], bbox[<span class="number">1</span>]), bbox[<span class="number">2</span>]-bbox[<span class="number">0</span>]+<span class="number">1</span>, bbox[<span class="number">3</span>]-bbox[<span class="number">1</span>]+<span class="number">1</span>, linewidth=<span class="number">1</span>,</span><br><span class="line">                           edgecolor=edgecolor,facecolor=facecolor,fill=fill, linestyle=linestyle)</span><br><span class="line">    currentAxis.add_patch(rect)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">plt.figure(figsize=(<span class="number">5</span>, <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&#x27;/home/aistudio/000000086956.jpg&#x27;</span></span><br><span class="line">im = imread(filename)</span><br><span class="line">plt.imshow(im)</span><br><span class="line"></span><br><span class="line">currentAxis=plt.gca()</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æµ‹æ¡†ä½ç½®</span></span><br><span class="line">boxes = np.array([[<span class="number">4.21716537e+01</span>, <span class="number">1.28230896e+02</span>, <span class="number">2.26547668e+02</span>, <span class="number">6.00434631e+02</span>],</span><br><span class="line">       [<span class="number">3.18562988e+02</span>, <span class="number">1.23168472e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.05688416e+02</span>],</span><br><span class="line">       [<span class="number">2.62704697e+01</span>, <span class="number">1.39430557e+02</span>, <span class="number">2.20587097e+02</span>, <span class="number">6.38959656e+02</span>],</span><br><span class="line">       [<span class="number">4.24965363e+01</span>, <span class="number">1.42706665e+02</span>, <span class="number">2.25955185e+02</span>, <span class="number">6.35671204e+02</span>],</span><br><span class="line">       [<span class="number">2.37462646e+02</span>, <span class="number">1.35731537e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.31451294e+02</span>],</span><br><span class="line">       [<span class="number">3.19390472e+02</span>, <span class="number">1.29295090e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.33003845e+02</span>],</span><br><span class="line">       [<span class="number">3.28933838e+02</span>, <span class="number">1.22736115e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.39000000e+02</span>],</span><br><span class="line">       [<span class="number">4.44292603e+01</span>, <span class="number">1.70438187e+02</span>, <span class="number">2.26841858e+02</span>, <span class="number">6.39000000e+02</span>],</span><br><span class="line">       [<span class="number">2.17988785e+02</span>, <span class="number">3.02472412e+02</span>, <span class="number">4.06062927e+02</span>, <span class="number">6.29106628e+02</span>],</span><br><span class="line">       [<span class="number">2.00241089e+02</span>, <span class="number">3.23755096e+02</span>, <span class="number">3.96929321e+02</span>, <span class="number">6.36386108e+02</span>],</span><br><span class="line">       [<span class="number">2.14310303e+02</span>, <span class="number">3.23443665e+02</span>, <span class="number">4.06732849e+02</span>, <span class="number">6.35775269e+02</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æµ‹æ¡†å¾—åˆ†</span></span><br><span class="line">scores = np.array([<span class="number">0.5247661</span> , <span class="number">0.51759845</span>, <span class="number">0.86075854</span>, <span class="number">0.9910175</span> , <span class="number">0.39170712</span>,</span><br><span class="line">       <span class="number">0.9297706</span> , <span class="number">0.5115228</span> , <span class="number">0.270992</span>  , <span class="number">0.19087596</span>, <span class="number">0.64201415</span>, <span class="number">0.879036</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºæ‰€æœ‰é¢„æµ‹æ¡†</span></span><br><span class="line"><span class="keyword">for</span> box <span class="keyword">in</span> boxes:</span><br><span class="line">    draw_rectangle(currentAxis, box)</span><br></pre></td></tr></table></figure>


<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/article_img/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/72.png" alt="png"></p>
<br>

<p><strong>éæå¤§å€¼æŠ‘åˆ¶ï¼ˆnon-maximum suppression, nmsï¼‰</strong></p>
<p>è¿™é‡Œä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶æ¥æ¶ˆé™¤å†—ä½™æ¡†ã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªé¢„æµ‹æ¡†éƒ½å¯¹åº”åŒä¸€ä¸ªç‰©ä½“ï¼Œåˆ™åªé€‰å‡ºå¾—åˆ†æœ€é«˜çš„é‚£ä¸ªé¢„æµ‹æ¡†ï¼Œå‰©ä¸‹çš„é¢„æµ‹æ¡†è¢«ä¸¢å¼ƒæ‰ã€‚å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªé¢„æµ‹æ¡†å¯¹åº”çš„æ˜¯åŒä¸€ä¸ªç‰©ä½“å‘¢ï¼Œæ ‡å‡†è¯¥æ€ä¹ˆè®¾ç½®ï¼Ÿ<strong>å¦‚æœä¸¤ä¸ªé¢„æµ‹æ¡†çš„ç±»åˆ«ä¸€æ ·ï¼Œè€Œä¸”ä»–ä»¬çš„ä½ç½®é‡åˆåº¦æ¯”è¾ƒå¤§ï¼Œåˆ™å¯ä»¥è®¤ä¸ºä»–ä»¬æ˜¯åœ¨é¢„æµ‹åŒä¸€ä¸ªç›®æ ‡</strong>ã€‚</p>
<p><code>éæå¤§å€¼æŠ‘åˆ¶çš„åšæ³•æ˜¯ï¼Œé€‰å‡ºæŸä¸ªç±»åˆ«å¾—åˆ†æœ€é«˜çš„é¢„æµ‹æ¡†ï¼Œç„¶åçœ‹å“ªäº›é¢„æµ‹æ¡†è·Ÿå®ƒçš„IoUå¤§äºé˜ˆå€¼ï¼Œå°±æŠŠè¿™äº›é¢„æµ‹æ¡†ç»™ä¸¢å¼ƒæ‰ã€‚è¿™é‡ŒIoUçš„é˜ˆå€¼æ˜¯è¶…å‚æ•°ï¼Œéœ€è¦æå‰è®¾ç½®ï¼ŒYOLOv3æ¨¡å‹é‡Œé¢è®¾ç½®çš„æ˜¯0.5</code>ã€‚</p>
<p>æ¯”å¦‚åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œboxesé‡Œé¢ä¸€å…±å¯¹åº”11ä¸ªé¢„æµ‹æ¡†ï¼Œscoresç»™å‡ºäº†å®ƒä»¬é¢„æµ‹â€äººâ€è¿™ä¸€ç±»åˆ«çš„å¾—åˆ†ã€‚</p>
<ul>
<li>Step0ï¼šåˆ›å»ºé€‰ä¸­åˆ—è¡¨ï¼Œkeep_list &#x3D; []</li>
<li>Step1ï¼šå¯¹å¾—åˆ†è¿›è¡Œæ’åºï¼Œremain_list &#x3D; [ 3,  5, 10,  2,  9,  0,  1,  6,  4,  7,  8]ï¼Œ </li>
<li>Step2ï¼šé€‰å‡ºboxes[3]ï¼Œæ­¤æ—¶keep_listä¸ºç©ºï¼Œä¸éœ€è¦è®¡ç®—IoUï¼Œç›´æ¥å°†å…¶æ”¾å…¥keep_listï¼Œkeep_list &#x3D; [3]ï¼Œ remain_list&#x3D;[5, 10,  2,  9,  0,  1,  6,  4,  7,  8]</li>
<li>Step3ï¼šé€‰å‡ºboxes[5]ï¼Œæ­¤æ—¶keep_listä¸­å·²ç»å­˜åœ¨boxes[3]ï¼Œè®¡ç®—å‡ºIoU(boxes[3], boxes[5]) &#x3D; 0.0ï¼Œæ˜¾ç„¶å°äºé˜ˆå€¼ï¼Œåˆ™keep_list&#x3D;[3, 5], remain_list &#x3D; [10,  2,  9,  0,  1,  6,  4,  7,  8]</li>
<li>Step4ï¼šé€‰å‡ºboxes[10]ï¼Œæ­¤æ—¶keep_list&#x3D;[3, 5]ï¼Œè®¡ç®—IoU(boxes[3], boxes[10])&#x3D;0.0268ï¼ŒIoU(boxes[5], boxes[10])&#x3D;0.0268 &#x3D; 0.24ï¼Œéƒ½å°äºé˜ˆå€¼ï¼Œåˆ™keep_list &#x3D; [3, 5, 10]ï¼Œremain_list&#x3D;[2,  9,  0,  1,  6,  4,  7,  8]</li>
<li>Step5ï¼šé€‰å‡ºboxes[2]ï¼Œæ­¤æ—¶keep_list &#x3D; [3, 5, 10]ï¼Œè®¡ç®—IoU(boxes[3], boxes[2]) &#x3D; 0.88ï¼Œè¶…è¿‡äº†é˜ˆå€¼ï¼Œç›´æ¥å°†boxes[2]ä¸¢å¼ƒï¼Œkeep_list&#x3D;[3, 5, 10]ï¼Œremain_list&#x3D;[9,  0,  1,  6,  4,  7,  8]</li>
<li>Step6ï¼šé€‰å‡ºboxes[9]ï¼Œæ­¤æ—¶keep_list &#x3D; [3, 5, 10]ï¼Œè®¡ç®—IoU(boxes[3], boxes[9]) &#x3D; 0.0577ï¼ŒIoU(boxes[5], boxes[9]) &#x3D; 0.205ï¼ŒIoU(boxes[10], boxes[9]) &#x3D; 0.88ï¼Œè¶…è¿‡äº†é˜ˆå€¼ï¼Œå°†boxes[9]ä¸¢å¼ƒæ‰ã€‚keep_list&#x3D;[3, 5, 10]ï¼Œremain_list&#x3D;[0,  1,  6,  4,  7,  8]</li>
<li>Step7ï¼šé‡å¤ä¸Šè¿°Step6ç›´åˆ°remain_listä¸ºç©ºã€‚</li>
</ul>
<p>æœ€ç»ˆå¾—åˆ°keep_list&#x3D;[3, 5, 10]ï¼Œä¹Ÿå°±æ˜¯é¢„æµ‹æ¡†3ã€5ã€10è¢«æœ€ç»ˆæŒ‘é€‰å‡ºæ¥äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”»å›¾å±•ç¤ºç›®æ ‡ç‰©ä½“è¾¹ç•Œæ¡†</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.patches <span class="keyword">as</span> patches</span><br><span class="line"><span class="keyword">from</span> matplotlib.image <span class="keyword">import</span> imread</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç”»çŸ©å½¢æ¡†çš„ç¨‹åº    </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_rectangle</span>(<span class="params">currentAxis, bbox, edgecolor = <span class="string">&#x27;k&#x27;</span>, facecolor = <span class="string">&#x27;y&#x27;</span>, fill=<span class="literal">False</span>, linestyle=<span class="string">&#x27;-&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># currentAxisï¼Œåæ ‡è½´ï¼Œé€šè¿‡plt.gca()è·å–</span></span><br><span class="line">    <span class="comment"># bboxï¼Œè¾¹ç•Œæ¡†ï¼ŒåŒ…å«å››ä¸ªæ•°å€¼çš„listï¼Œ [x1, y1, x2, y2]</span></span><br><span class="line">    <span class="comment"># edgecolorï¼Œè¾¹æ¡†çº¿æ¡é¢œè‰²</span></span><br><span class="line">    <span class="comment"># facecolorï¼Œå¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment"># fill, æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment"># linestypeï¼Œè¾¹æ¡†çº¿å‹</span></span><br><span class="line">    <span class="comment"># patches.Rectangleéœ€è¦ä¼ å…¥å·¦ä¸Šè§’åæ ‡ã€çŸ©å½¢åŒºåŸŸçš„å®½åº¦ã€é«˜åº¦ç­‰å‚æ•°</span></span><br><span class="line">    rect=patches.Rectangle((bbox[<span class="number">0</span>], bbox[<span class="number">1</span>]), bbox[<span class="number">2</span>]-bbox[<span class="number">0</span>]+<span class="number">1</span>, bbox[<span class="number">3</span>]-bbox[<span class="number">1</span>]+<span class="number">1</span>, linewidth=<span class="number">1</span>,</span><br><span class="line">                           edgecolor=edgecolor,facecolor=facecolor,fill=fill, linestyle=linestyle)</span><br><span class="line">    currentAxis.add_patch(rect)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">plt.figure(figsize=(<span class="number">5</span>, <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&#x27;000000086956.jpg&#x27;</span></span><br><span class="line">im = imread(filename)</span><br><span class="line">plt.imshow(im)</span><br><span class="line"></span><br><span class="line">currentAxis=plt.gca()</span><br><span class="line"></span><br><span class="line">boxes = np.array([[<span class="number">4.21716537e+01</span>, <span class="number">1.28230896e+02</span>, <span class="number">2.26547668e+02</span>, <span class="number">6.00434631e+02</span>],</span><br><span class="line">       [<span class="number">3.18562988e+02</span>, <span class="number">1.23168472e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.05688416e+02</span>],</span><br><span class="line">       [<span class="number">2.62704697e+01</span>, <span class="number">1.39430557e+02</span>, <span class="number">2.20587097e+02</span>, <span class="number">6.38959656e+02</span>],</span><br><span class="line">       [<span class="number">4.24965363e+01</span>, <span class="number">1.42706665e+02</span>, <span class="number">2.25955185e+02</span>, <span class="number">6.35671204e+02</span>],</span><br><span class="line">       [<span class="number">2.37462646e+02</span>, <span class="number">1.35731537e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.31451294e+02</span>],</span><br><span class="line">       [<span class="number">3.19390472e+02</span>, <span class="number">1.29295090e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.33003845e+02</span>],</span><br><span class="line">       [<span class="number">3.28933838e+02</span>, <span class="number">1.22736115e+02</span>, <span class="number">4.79000000e+02</span>, <span class="number">6.39000000e+02</span>],</span><br><span class="line">       [<span class="number">4.44292603e+01</span>, <span class="number">1.70438187e+02</span>, <span class="number">2.26841858e+02</span>, <span class="number">6.39000000e+02</span>],</span><br><span class="line">       [<span class="number">2.17988785e+02</span>, <span class="number">3.02472412e+02</span>, <span class="number">4.06062927e+02</span>, <span class="number">6.29106628e+02</span>],</span><br><span class="line">       [<span class="number">2.00241089e+02</span>, <span class="number">3.23755096e+02</span>, <span class="number">3.96929321e+02</span>, <span class="number">6.36386108e+02</span>],</span><br><span class="line">       [<span class="number">2.14310303e+02</span>, <span class="number">3.23443665e+02</span>, <span class="number">4.06732849e+02</span>, <span class="number">6.35775269e+02</span>]])</span><br><span class="line"> </span><br><span class="line">scores = np.array([<span class="number">0.5247661</span> , <span class="number">0.51759845</span>, <span class="number">0.86075854</span>, <span class="number">0.9910175</span> , <span class="number">0.39170712</span>,</span><br><span class="line">       <span class="number">0.9297706</span> , <span class="number">0.5115228</span> , <span class="number">0.270992</span>  , <span class="number">0.19087596</span>, <span class="number">0.64201415</span>, <span class="number">0.879036</span>])</span><br><span class="line"></span><br><span class="line">colors = [<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºæœ€ç»ˆä¿ç•™çš„é¢„æµ‹æ¡†</span></span><br><span class="line">inds = [<span class="number">3</span>, <span class="number">5</span>, <span class="number">10</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    box = boxes[inds[i]]</span><br><span class="line">    draw_rectangle(currentAxis, box, edgecolor=colors[i])</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/article_img/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/73.png" alt="png"></p>
<p>éæå¤§å€¼æŠ‘åˆ¶çš„å…·ä½“å®ç°ä»£ç å¦‚ä¸‹é¢çš„<code>nms</code>å‡½æ•°çš„å®šä¹‰ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯æ•°æ®é›†ä¸­å«æœ‰å¤šä¸ªç±»åˆ«çš„ç‰©ä½“ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åšå¤šåˆ†ç±»éæå¤§å€¼æŠ‘åˆ¶ï¼Œå…¶å®ç°åŸç†ä¸éæå¤§å€¼æŠ‘åˆ¶ç›¸åŒï¼ŒåŒºåˆ«åœ¨äºéœ€è¦å¯¹æ¯ä¸ªç±»åˆ«éƒ½åšéæå¤§å€¼æŠ‘åˆ¶ï¼Œå®ç°ä»£ç å¦‚ä¸‹é¢çš„<code>multiclass_nms</code>æ‰€ç¤ºã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éæå¤§å€¼æŠ‘åˆ¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nms</span>(<span class="params">bboxes, scores, score_thresh, nms_thresh, pre_nms_topk, i=<span class="number">0</span>, c=<span class="number">0</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    nms</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ä»å°åˆ°å¤§æ’åˆ—å–å‡ºç´¢å¼•</span></span><br><span class="line">    inds = np.argsort(scores)</span><br><span class="line">    inds = inds[::-<span class="number">1</span>]</span><br><span class="line">    keep_inds = []</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">len</span>(inds) &gt; <span class="number">0</span>):</span><br><span class="line">        cur_ind = inds[<span class="number">0</span>]</span><br><span class="line">        cur_score = scores[cur_ind]</span><br><span class="line">        <span class="comment"># if score of the box is less than score_thresh, just drop it</span></span><br><span class="line">        <span class="keyword">if</span> cur_score &lt; score_thresh:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        keep = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> ind <span class="keyword">in</span> keep_inds:</span><br><span class="line">            current_box = bboxes[cur_ind]</span><br><span class="line">            remain_box = bboxes[ind]</span><br><span class="line">            iou = box_iou_xyxy(current_box, remain_box)</span><br><span class="line">            <span class="keyword">if</span> iou &gt; nms_thresh:</span><br><span class="line">                keep = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#if i == 0 and c == 4 and cur_ind == 951:</span></span><br><span class="line">            <span class="comment">#print(&#x27;suppressed, &#x27;, keep, i, c, cur_ind, ind, iou)</span></span><br><span class="line">        <span class="keyword">if</span> keep:</span><br><span class="line">            keep_inds.append(cur_ind)</span><br><span class="line">        inds = inds[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> np.array(keep_inds)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šåˆ†ç±»éæå¤§å€¼æŠ‘åˆ¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiclass_nms</span>(<span class="params">bboxes, scores, score_thresh=<span class="number">0.01</span>, nms_thresh=<span class="number">0.45</span>, pre_nms_topk=<span class="number">1000</span>, pos_nms_topk=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is for multiclass_nms</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    batch_size = bboxes.shape[<span class="number">0</span>]</span><br><span class="line">    class_num = scores.shape[<span class="number">1</span>]</span><br><span class="line">    rets = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">        bboxes_i = bboxes[i]</span><br><span class="line">        scores_i = scores[i]</span><br><span class="line">        ret = []</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(class_num):</span><br><span class="line">            scores_i_c = scores_i[c]</span><br><span class="line">            keep_inds = nms(bboxes_i, scores_i_c, score_thresh, nms_thresh, pre_nms_topk, i=i, c=c)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(keep_inds) &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            keep_bboxes = bboxes_i[keep_inds]</span><br><span class="line">            keep_scores = scores_i_c[keep_inds]</span><br><span class="line">            keep_results = np.zeros([keep_scores.shape[<span class="number">0</span>], <span class="number">6</span>])</span><br><span class="line">            keep_results[:, <span class="number">0</span>] = c</span><br><span class="line">            keep_results[:, <span class="number">1</span>] = keep_scores[:]</span><br><span class="line">            keep_results[:, <span class="number">2</span>:<span class="number">6</span>] = keep_bboxes[:, :]</span><br><span class="line">            ret.append(keep_results)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ret) &lt; <span class="number">1</span>:</span><br><span class="line">            rets.append(ret)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ret_i = np.concatenate(ret, axis=<span class="number">0</span>)</span><br><span class="line">        scores_i = ret_i[:, <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(scores_i) &gt; pos_nms_topk:</span><br><span class="line">            inds = np.argsort(scores_i)[::-<span class="number">1</span>]</span><br><span class="line">            inds = inds[:pos_nms_topk]</span><br><span class="line">            ret_i = ret_i[inds]</span><br><span class="line"></span><br><span class="line">        rets.append(ret_i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rets</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å®Œæ•´çš„æµ‹è¯•ç¨‹åºï¼Œåœ¨æµ‹è¯•æ•°æ®é›†ä¸Šçš„è¾“å‡ºç»“æœå°†ä¼šè¢«ä¿å­˜åœ¨<code>pred_results.json</code>æ–‡ä»¶ä¸­ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—IoUï¼ŒçŸ©å½¢æ¡†çš„åæ ‡å½¢å¼ä¸ºxyxy</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">box_iou_xyxy</span>(<span class="params">box1, box2</span>):</span><br><span class="line">    <span class="comment"># è·å–box1å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„åæ ‡</span></span><br><span class="line">    x1min, y1min, x1max, y1max = box1[<span class="number">0</span>], box1[<span class="number">1</span>], box1[<span class="number">2</span>], box1[<span class="number">3</span>]</span><br><span class="line">    <span class="comment"># è®¡ç®—box1çš„é¢ç§¯</span></span><br><span class="line">    s1 = (y1max - y1min + <span class="number">1.</span>) * (x1max - x1min + <span class="number">1.</span>)</span><br><span class="line">    <span class="comment"># è·å–box2å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„åæ ‡</span></span><br><span class="line">    x2min, y2min, x2max, y2max = box2[<span class="number">0</span>], box2[<span class="number">1</span>], box2[<span class="number">2</span>], box2[<span class="number">3</span>]</span><br><span class="line">    <span class="comment"># è®¡ç®—box2çš„é¢ç§¯</span></span><br><span class="line">    s2 = (y2max - y2min + <span class="number">1.</span>) * (x2max - x2min + <span class="number">1.</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¡ç®—ç›¸äº¤çŸ©å½¢æ¡†çš„åæ ‡</span></span><br><span class="line">    xmin = np.maximum(x1min, x2min)</span><br><span class="line">    ymin = np.maximum(y1min, y2min)</span><br><span class="line">    xmax = np.minimum(x1max, x2max)</span><br><span class="line">    ymax = np.minimum(y1max, y2max)</span><br><span class="line">    <span class="comment"># è®¡ç®—ç›¸äº¤çŸ©å½¢è¡Œçš„é«˜åº¦ã€å®½åº¦ã€é¢ç§¯</span></span><br><span class="line">    inter_h = np.maximum(ymax - ymin + <span class="number">1.</span>, <span class="number">0.</span>)</span><br><span class="line">    inter_w = np.maximum(xmax - xmin + <span class="number">1.</span>, <span class="number">0.</span>)</span><br><span class="line">    intersection = inter_h * inter_w</span><br><span class="line">    <span class="comment"># è®¡ç®—ç›¸å¹¶é¢ç§¯</span></span><br><span class="line">    union = s1 + s2 - intersection</span><br><span class="line">    <span class="comment"># è®¡ç®—äº¤å¹¶æ¯”</span></span><br><span class="line">    iou = intersection / union</span><br><span class="line">    <span class="keyword">return</span> iou</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§£å‹ yolo_epoch50 æ•°æ®è„šæœ¬</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¼€å§‹è§£å‹......&#x27;</span>)</span><br><span class="line">!unzip  -o -q -d  /home/aistudio /home/aistudio/data/data170339/yolo_epoch50.<span class="built_in">zip</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;è§£å‹å®Œæˆ&#x27;</span>)</span><br></pre></td></tr></table></figure>

<pre><code>å¼€å§‹è§£å‹......
è§£å‹å®Œæˆ
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">ANCHORS = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line">ANCHOR_MASKS = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line">VALID_THRESH = <span class="number">0.01</span></span><br><span class="line">NMS_TOPK = <span class="number">400</span></span><br><span class="line">NMS_POSK = <span class="number">100</span></span><br><span class="line">NMS_THRESH = <span class="number">0.45</span></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    TRAINDIR = <span class="string">&#x27;/home/aistudio/work/insects/train/images&#x27;</span></span><br><span class="line">    TESTDIR = <span class="string">&#x27;/home/aistudio/work/insects/test/images&#x27;</span></span><br><span class="line">    VALIDDIR = <span class="string">&#x27;/home/aistudio/work/insects/val&#x27;</span></span><br><span class="line"></span><br><span class="line">    model = YOLOv3(num_classes=NUM_CLASSES)</span><br><span class="line">    params_file_path = <span class="string">&#x27;/home/aistudio/yolo_epoch50.pdparams&#x27;</span></span><br><span class="line">    model_state_dict = paddle.load(params_file_path)</span><br><span class="line">    model.load_dict(model_state_dict)</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    total_results = []</span><br><span class="line">    test_loader = test_data_loader(TESTDIR, batch_size= <span class="number">1</span>, mode=<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader()):</span><br><span class="line">        img_name, img_data, img_scale_data = data</span><br><span class="line">        img = paddle.to_tensor(img_data)</span><br><span class="line">        img_scale = paddle.to_tensor(img_scale_data)</span><br><span class="line"></span><br><span class="line">        outputs = model.forward(img)</span><br><span class="line">        bboxes, scores = model.get_pred(outputs,</span><br><span class="line">                                 im_shape=img_scale,</span><br><span class="line">                                 anchors=ANCHORS,</span><br><span class="line">                                 anchor_masks=ANCHOR_MASKS,</span><br><span class="line">                                 valid_thresh = VALID_THRESH)</span><br><span class="line"></span><br><span class="line">        bboxes_data = bboxes.numpy()</span><br><span class="line">        scores_data = scores.numpy()</span><br><span class="line">        result = multiclass_nms(bboxes_data, scores_data,</span><br><span class="line">                      score_thresh=VALID_THRESH, </span><br><span class="line">                      nms_thresh=NMS_THRESH, </span><br><span class="line">                      pre_nms_topk=NMS_TOPK, </span><br><span class="line">                      pos_nms_topk=NMS_POSK)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)):</span><br><span class="line">            result_j = result[j]</span><br><span class="line">            img_name_j = img_name[j]</span><br><span class="line">            total_results.append([img_name_j, result_j.tolist()])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;processed &#123;&#125; pictures&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(total_results)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    json.dump(total_results, <span class="built_in">open</span>(<span class="string">&#x27;pred_results.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>jsonæ–‡ä»¶ä¸­ä¿å­˜ç€æµ‹è¯•ç»“æœï¼Œæ˜¯åŒ…å«æ‰€æœ‰å›¾ç‰‡é¢„æµ‹ç»“æœçš„listï¼Œå…¶æ„æˆå¦‚ä¸‹ï¼š</p>
<pre><code>[[img_name, [[label, score, x1, y1, x2, y2], ..., [label, score, x1, y1, x2, y2]]], 
 [img_name, [[label, score, x1, y1, x2, y2], ..., [label, score, x1, y1, x2, y2]]],
  ...
 [img_name, [[label, score, x1, y1, x2, y2],..., [label, score, x1, y1, x2, y2]]]]
</code></pre>
<p>listä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€å¼ å›¾ç‰‡çš„é¢„æµ‹ç»“æœï¼Œlistçš„æ€»é•¿åº¦ç­‰äºå›¾ç‰‡çš„æ•°ç›®ï¼Œæ¯å¼ å›¾ç‰‡é¢„æµ‹ç»“æœçš„æ ¼å¼æ˜¯ï¼š</p>
<pre><code> [img_name, [[label, score, x1, y1, x2, y2],..., [label, score, x1, y1, x2, y2]]]
</code></pre>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å›¾ç‰‡åç§°image_nameï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯åŒ…å«è¯¥å›¾ç‰‡æ‰€æœ‰é¢„æµ‹æ¡†çš„listï¼Œ é¢„æµ‹æ¡†åˆ—è¡¨ï¼š</p>
<pre><code> [[label, score, x1, x2, y1, y2],..., [label, score, x1, y1, x2, y2]]
</code></pre>
<p>é¢„æµ‹æ¡†åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ [label, score, x1, y1, x2, y2]æè¿°äº†ä¸€ä¸ªé¢„æµ‹æ¡†ï¼Œlabelæ˜¯é¢„æµ‹æ¡†æ‰€å±ç±»åˆ«æ ‡ç­¾ï¼Œscoreæ˜¯é¢„æµ‹æ¡†çš„å¾—åˆ†ï¼›x1, y1, x2, y2å¯¹åº”é¢„æµ‹æ¡†å·¦ä¸Šè§’åæ ‡(x1, y1)ï¼Œå³ä¸‹è§’åæ ‡(x2, y2)ã€‚æ¯å¼ å›¾ç‰‡å¯èƒ½æœ‰å¾ˆå¤šä¸ªé¢„æµ‹æ¡†ï¼Œåˆ™å°†å…¶å…¨éƒ¨æ”¾åœ¨é¢„æµ‹æ¡†åˆ—è¡¨ä¸­ã€‚</p>
<h2 id="9-æ¨¡å‹æ•ˆæœåŠå¯è§†åŒ–å±•ç¤º"><a href="#9-æ¨¡å‹æ•ˆæœåŠå¯è§†åŒ–å±•ç¤º" class="headerlink" title="9.æ¨¡å‹æ•ˆæœåŠå¯è§†åŒ–å±•ç¤º"></a><strong>9.æ¨¡å‹æ•ˆæœåŠå¯è§†åŒ–å±•ç¤º</strong></h2><p>ä¸Šé¢çš„ç¨‹åºå±•ç¤ºäº†å¦‚ä½•è¯»å–æµ‹è¯•æ•°æ®é›†çš„å›¾ç‰‡ï¼Œå¹¶å°†æœ€ç»ˆç»“æœä¿å­˜åœ¨jsonæ ¼å¼çš„æ–‡ä»¶ä¸­ã€‚ä¸ºäº†æ›´ç›´è§‚çš„ç»™è¯»è€…å±•ç¤ºæ¨¡å‹æ•ˆæœï¼Œä¸‹é¢çš„ç¨‹åºæ·»åŠ äº†å¦‚ä½•è¯»å–å•å¼ å›¾ç‰‡ï¼Œå¹¶ç”»å‡ºå…¶äº§ç”Ÿçš„é¢„æµ‹æ¡†ã€‚</p>
<p><strong>1. åˆ›å»ºæ•°æ®è¯»å–å™¨ä»¥è¯»å–å•å¼ å›¾ç‰‡çš„æ•°æ®</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–å•å¼ æµ‹è¯•å›¾ç‰‡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">single_image_data_loader</span>(<span class="params">filename, test_image_size=<span class="number">608</span>, mode=<span class="string">&#x27;test&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åŠ è½½æµ‹è¯•ç”¨çš„å›¾ç‰‡ï¼Œæµ‹è¯•æ•°æ®æ²¡æœ‰groundtruthæ ‡ç­¾</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    batch_size= <span class="number">1</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reader</span>():</span><br><span class="line">        batch_data = []</span><br><span class="line">        img_size = test_image_size</span><br><span class="line">        file_path = os.path.join(filename)</span><br><span class="line">        img = cv2.imread(file_path)</span><br><span class="line">        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">        H = img.shape[<span class="number">0</span>]</span><br><span class="line">        W = img.shape[<span class="number">1</span>]</span><br><span class="line">        img = cv2.resize(img, (img_size, img_size))</span><br><span class="line"></span><br><span class="line">        mean = [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]</span><br><span class="line">        std = [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]</span><br><span class="line">        mean = np.array(mean).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">        std = np.array(std).reshape((<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">        out_img = (img / <span class="number">255.0</span> - mean) / std</span><br><span class="line">        out_img = out_img.astype(<span class="string">&#x27;float32&#x27;</span>).transpose((<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        img = out_img <span class="comment">#np.transpose(out_img, (2,0,1))</span></span><br><span class="line">        im_shape = [H, W]</span><br><span class="line"></span><br><span class="line">        batch_data.append((image_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>], img, im_shape))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(batch_data) == batch_size:</span><br><span class="line">            <span class="keyword">yield</span> make_test_array(batch_data)</span><br><span class="line">            batch_data = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> reader</span><br></pre></td></tr></table></figure>

<p><strong>2. å®šä¹‰ç»˜åˆ¶é¢„æµ‹æ¡†çš„ç”»å›¾å‡½æ•°</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ç”»å›¾å‡½æ•°</span></span><br><span class="line">INSECT_NAMES = [<span class="string">&#x27;Boerner&#x27;</span>, <span class="string">&#x27;Leconte&#x27;</span>, <span class="string">&#x27;Linnaeus&#x27;</span>, </span><br><span class="line">                <span class="string">&#x27;acuminatus&#x27;</span>, <span class="string">&#x27;armandi&#x27;</span>, <span class="string">&#x27;coleoptera&#x27;</span>, <span class="string">&#x27;linnaeus&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç”»çŸ©å½¢æ¡†çš„å‡½æ•° </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_rectangle</span>(<span class="params">currentAxis, bbox, edgecolor = <span class="string">&#x27;k&#x27;</span>, facecolor = <span class="string">&#x27;y&#x27;</span>, fill=<span class="literal">False</span>, linestyle=<span class="string">&#x27;-&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># currentAxisï¼Œåæ ‡è½´ï¼Œé€šè¿‡plt.gca()è·å–</span></span><br><span class="line">    <span class="comment"># bboxï¼Œè¾¹ç•Œæ¡†ï¼ŒåŒ…å«å››ä¸ªæ•°å€¼çš„listï¼Œ [x1, y1, x2, y2]</span></span><br><span class="line">    <span class="comment"># edgecolorï¼Œè¾¹æ¡†çº¿æ¡é¢œè‰²</span></span><br><span class="line">    <span class="comment"># facecolorï¼Œå¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment"># fill, æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment"># linestypeï¼Œè¾¹æ¡†çº¿å‹</span></span><br><span class="line">    <span class="comment"># patches.Rectangleéœ€è¦ä¼ å…¥å·¦ä¸Šè§’åæ ‡ã€çŸ©å½¢åŒºåŸŸçš„å®½åº¦ã€é«˜åº¦ç­‰å‚æ•°</span></span><br><span class="line">    rect=patches.Rectangle((bbox[<span class="number">0</span>], bbox[<span class="number">1</span>]), bbox[<span class="number">2</span>]-bbox[<span class="number">0</span>]+<span class="number">1</span>, bbox[<span class="number">3</span>]-bbox[<span class="number">1</span>]+<span class="number">1</span>, linewidth=<span class="number">1</span>,</span><br><span class="line">                           edgecolor=edgecolor,facecolor=facecolor,fill=fill, linestyle=linestyle)</span><br><span class="line">    currentAxis.add_patch(rect)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç»˜åˆ¶é¢„æµ‹ç»“æœçš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_results</span>(<span class="params">result, filename, draw_thresh=<span class="number">0.5</span></span>):</span><br><span class="line">    plt.figure(figsize=(<span class="number">5</span>, <span class="number">5</span>))</span><br><span class="line">    im = imread(filename)</span><br><span class="line">    plt.imshow(im)</span><br><span class="line">    currentAxis=plt.gca()</span><br><span class="line">    colors = [<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;purple&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result:</span><br><span class="line">        box = item[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">        label = <span class="built_in">int</span>(item[<span class="number">0</span>])</span><br><span class="line">        name = INSECT_NAMES[label]</span><br><span class="line">        <span class="keyword">if</span> item[<span class="number">1</span>] &gt; draw_thresh:</span><br><span class="line">            draw_rectangle(currentAxis, box, edgecolor = colors[label])</span><br><span class="line">            plt.text(box[<span class="number">0</span>], box[<span class="number">1</span>], name, fontsize=<span class="number">12</span>, color=colors[label])</span><br></pre></td></tr></table></figure>

<p><strong>3. è¯»å–ä¸é¢„æµ‹å¯è§†åŒ–</strong></p>
<p>ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„single_image_data_loaderå‡½æ•°è¯»å–æŒ‡å®šçš„å›¾ç‰‡ï¼Œè¾“å…¥ç½‘ç»œå¹¶è®¡ç®—å‡ºé¢„æµ‹æ¡†å’Œå¾—åˆ†ï¼Œç„¶åä½¿ç”¨å¤šåˆ†ç±»éæå¤§å€¼æŠ‘åˆ¶æ¶ˆé™¤å†—ä½™çš„æ¡†ã€‚å°†æœ€ç»ˆç»“æœç”»å›¾å±•ç¤ºå‡ºæ¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"></span><br><span class="line">ANCHORS = [<span class="number">10</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">23</span>, <span class="number">30</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">45</span>, <span class="number">59</span>, <span class="number">119</span>, <span class="number">116</span>, <span class="number">90</span>, <span class="number">156</span>, <span class="number">198</span>, <span class="number">373</span>, <span class="number">326</span>]</span><br><span class="line">ANCHOR_MASKS = [[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line">VALID_THRESH = <span class="number">0.01</span></span><br><span class="line">NMS_TOPK = <span class="number">400</span></span><br><span class="line">NMS_POSK = <span class="number">100</span></span><br><span class="line">NMS_THRESH = <span class="number">0.45</span></span><br><span class="line"></span><br><span class="line">NUM_CLASSES = <span class="number">7</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    image_name = <span class="string">&#x27;/home/aistudio/work/insects/test/images/1880.jpeg&#x27;</span></span><br><span class="line">    params_file_path = <span class="string">&#x27;/home/aistudio/yolo_epoch50.pdparams&#x27;</span></span><br><span class="line"></span><br><span class="line">    model = YOLOv3(num_classes=NUM_CLASSES)</span><br><span class="line">    model_state_dict = paddle.load(params_file_path)</span><br><span class="line">    model.load_dict(model_state_dict)</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    total_results = []</span><br><span class="line">    test_loader = single_image_data_loader(image_name, mode=<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader()):</span><br><span class="line">        img_name, img_data, img_scale_data = data</span><br><span class="line">        img = paddle.to_tensor(img_data)</span><br><span class="line">        img_scale = paddle.to_tensor(img_scale_data)</span><br><span class="line"></span><br><span class="line">        outputs = model.forward(img)</span><br><span class="line">        bboxes, scores = model.get_pred(outputs,</span><br><span class="line">                                 im_shape=img_scale,</span><br><span class="line">                                 anchors=ANCHORS,</span><br><span class="line">                                 anchor_masks=ANCHOR_MASKS,</span><br><span class="line">                                 valid_thresh = VALID_THRESH)</span><br><span class="line"></span><br><span class="line">        bboxes_data = bboxes.numpy()</span><br><span class="line">        scores_data = scores.numpy()</span><br><span class="line">        results = multiclass_nms(bboxes_data, scores_data,</span><br><span class="line">                      score_thresh=VALID_THRESH, </span><br><span class="line">                      nms_thresh=NMS_THRESH, </span><br><span class="line">                      pre_nms_topk=NMS_TOPK, </span><br><span class="line">                      pos_nms_topk=NMS_POSK)</span><br><span class="line"></span><br><span class="line">result = results[<span class="number">0</span>]</span><br><span class="line">draw_results(result, image_name, draw_thresh=<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>


<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/article_img/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/74.png" alt="png"></p>
<p>é€šè¿‡ä¸Šé¢çš„ç¨‹åºï¼Œæ¸…æ™°çš„ç»™è¯»è€…å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è®­ç»ƒå¥½çš„æƒé‡ï¼Œå¯¹å›¾ç‰‡è¿›è¡Œé¢„æµ‹å¹¶å°†ç»“æœå¯è§†åŒ–ã€‚æœ€ç»ˆè¾“å‡ºçš„å›¾ç‰‡ä¸Šï¼Œæ£€æµ‹å‡ºäº†æ¯ä¸ªæ˜†è™«ï¼Œæ ‡å‡ºäº†å®ƒä»¬çš„è¾¹ç•Œæ¡†å’Œå…·ä½“ç±»åˆ«ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://blog.dai2yutou.space">å°æ¼å¤´&amp;å°æˆ´</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://blog.dai2yutou.space/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.3-YOLOv3%E5%AE%9E%E7%8E%B0AI%E8%AF%86%E8%99%AB%EF%BC%88%E4%B8%8B%EF%BC%89/">http://blog.dai2yutou.space/2023/01/03/æ·±åº¦å­¦ä¹ 6.3-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸‹ï¼‰/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://blog.dai2yutou.space" target="_blank">å°æ¼å¤´|å°æˆ´</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a><a class="post-meta__tags" href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">äººå·¥æ™ºèƒ½</a><a class="post-meta__tags" href="/tags/paddle/">paddle</a><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%AB%98%E7%BA%A7-%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E4%B9%8B%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">æ·±åº¦å­¦ä¹ é«˜çº§_è®¡ç®—æœºè§†è§‰ä¹‹ç›®æ ‡æ£€æµ‹</a></div><div class="post_share"><div class="social-share" data-image="https://picbed.dai2yutou.space/web_img/19.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.2-YOLOv3%E5%AE%9E%E7%8E%B0AI%E8%AF%86%E8%99%AB%EF%BC%88%E4%B8%8A%EF%BC%89/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">æ·±åº¦å­¦ä¹ 6.2-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸Šï¼‰</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.4-%E5%85%B6%E4%BB%96%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%E6%A6%82%E8%BF%B0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">æ·±åº¦å­¦ä¹ 6.4-å…¶ä»–ç›®æ ‡æ£€æµ‹æ¨¡å‹æ¦‚è¿°</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.2-YOLOv3%E5%AE%9E%E7%8E%B0AI%E8%AF%86%E8%99%AB%EF%BC%88%E4%B8%8A%EF%BC%89/" title="æ·±åº¦å­¦ä¹ 6.2-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸Šï¼‰"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-03</div><div class="title">æ·±åº¦å­¦ä¹ 6.2-YOLOv3å®ç°AIè¯†è™«ï¼ˆä¸Šï¼‰</div></div></a></div><div><a href="/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.1-%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" title="æ·±åº¦å­¦ä¹ 6.1-ç›®æ ‡æ£€æµ‹åŸºæœ¬æ¦‚å¿µ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-03</div><div class="title">æ·±åº¦å­¦ä¹ 6.1-ç›®æ ‡æ£€æµ‹åŸºæœ¬æ¦‚å¿µ</div></div></a></div><div><a href="/2023/01/03/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A06.4-%E5%85%B6%E4%BB%96%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%E6%A6%82%E8%BF%B0/" title="æ·±åº¦å­¦ä¹ 6.4-å…¶ä»–ç›®æ ‡æ£€æµ‹æ¨¡å‹æ¦‚è¿°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-03</div><div class="title">æ·±åº¦å­¦ä¹ 6.4-å…¶ä»–ç›®æ ‡æ£€æµ‹æ¨¡å‹æ¦‚è¿°</div></div></a></div><div><a href="/2022/12/18/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A01.1-%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%AE%BA/" title="æ·±åº¦å­¦ä¹ 1.1-æ·±åº¦å­¦ä¹ æ¦‚è®º"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-18</div><div class="title">æ·±åº¦å­¦ä¹ 1.1-æ·±åº¦å­¦ä¹ æ¦‚è®º</div></div></a></div><div><a href="/2022/12/20/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A02.1-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="æ·±åº¦å­¦ä¹ 2.1-çº¿æ€§å›å½’æ¨¡å‹çš„å®ç°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-20</div><div class="title">æ·±åº¦å­¦ä¹ 2.1-çº¿æ€§å›å½’æ¨¡å‹çš„å®ç°</div></div></a></div><div><a href="/2022/12/20/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A02.2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E5%88%86%E7%B1%BB%E4%BB%BB%E5%8A%A1/" title="æ·±åº¦å­¦ä¹ 2.2-ç¥ç»ç½‘ç»œä¸­çš„åˆ†ç±»ä»»åŠ¡"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-20</div><div class="title">æ·±åº¦å­¦ä¹ 2.2-ç¥ç»ç½‘ç»œä¸­çš„åˆ†ç±»ä»»åŠ¡</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="animate__fadeIn card-info card-widget wow" data-wow-delay="0" data-wow-duration="" data-wow-iteration="" data-wow-offset="" style="visibility: visible; animation-name: fadeIn;"><div class="author-info-top"><div class="card-info-avatar"><a class="avatar-img" data-pjax-state="" href="/about"><img class="entered loaded" alt="avatar" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/apple-touch-icon.jpg" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;"/></a><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="palm_tree" fallback-src="/img/tree_icon.png">ğŸŸ</g-emoji><span>æ‘¸é±¼ä¸­~</span></div></div></div></div><div class="author-info__sayhi" id="author-info__sayhi">æ™šå®‰ğŸ˜´ï¼æˆ‘æ˜¯</div><h1 class="author-info__name">XiaoYutou|XiaoDai</h1><div class="author-info__description">çƒ­çˆ±ç”Ÿæ´»ç‚¹æ»´ï¼Œåˆ†äº«æ—¶åˆ»ç²¾å½©ã€‚</div><a id="card-info-btn" data-pjax-state="" onclick="pjax.loadUrl(/about/)"><i></i><span style="padding-left:32px;font-weight:600;font-size:large">äº†è§£æ›´å¤š<i class="faa-passing animated" style="padding-left:-2px;display:inline-block;vertical-align:middle;"><span style="height:28px;width:28px;fill:currentColor;position:relative;top:-1.5px">ğŸ’¨</span></i></span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xiaoyutoua" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2143191301@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content"><center>ä¸»åŸŸå:<a target="_blank" rel="noopener" href="https://www.dai2yutou.space">å°æ¼å¤´|å°æˆ´</a><br><span>æŠ€æœ¯é—®é¢˜æ¬¢è¿äº¤æµğŸ§</span><span color="#3eb8be">VX:yuguolong_001</span></center></div><div id="welcome-info"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E4%BA%8EYOLOv3%E7%9A%84AI%E8%AF%86%E8%99%AB%E5%AE%9E%E9%AA%8C"><span class="toc-text">ä¸€ã€åŸºäºYOLOv3çš„AIè¯†è™«å®éªŒ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">å®éªŒç¯å¢ƒ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%8D%95%E9%98%B6%E6%AE%B5%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8BYOLOv3"><span class="toc-text">äºŒã€å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-YOLOv3%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-text">2. YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-YOLOv3%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83"><span class="toc-text">3. YOLOv3æ¨¡å‹è®­ç»ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BA%A7%E7%94%9F%E5%80%99%E9%80%89%E5%8C%BA%E5%9F%9F"><span class="toc-text">3.1 äº§ç”Ÿå€™é€‰åŒºåŸŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8D%B7%E7%A7%AF%E7%BD%91%E7%BB%9C%E6%8F%90%E5%8F%96%E7%89%B9%E5%BE%81"><span class="toc-text">3.2 å·ç§¯ç½‘ç»œæå–ç‰¹å¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%A0%B9%E6%8D%AE%E8%BE%93%E5%87%BA%E7%89%B9%E5%BE%81%E5%9B%BE%E8%AE%A1%E7%AE%97%E9%A2%84%E6%B5%8B%E6%A1%86%E4%BD%8D%E7%BD%AE%E5%92%8C%E7%B1%BB%E5%88%AB"><span class="toc-text">4.æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E5%BB%BA%E7%AB%8B%E8%BE%93%E5%87%BA%E7%89%B9%E5%BE%81%E5%9B%BE%E4%B8%8E%E9%A2%84%E6%B5%8B%E6%A1%86%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E8%81%94"><span class="toc-text">4.1å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E8%AE%A1%E7%AE%97%E9%A2%84%E6%B5%8B%E6%A1%86%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E7%89%A9%E4%BD%93%E7%9A%84%E6%A6%82%E7%8E%87"><span class="toc-text">4.2è®¡ç®—é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3%E8%AE%A1%E7%AE%97%E9%A2%84%E6%B5%8B%E6%A1%86%E4%BD%8D%E7%BD%AE%E5%9D%90%E6%A0%87"><span class="toc-text">4.3è®¡ç®—é¢„æµ‹æ¡†ä½ç½®åæ ‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4%E8%AE%A1%E7%AE%97%E7%89%A9%E4%BD%93%E5%B1%9E%E4%BA%8E%E6%AF%8F%E4%B8%AA%E7%B1%BB%E5%88%AB%E6%A6%82%E7%8E%87"><span class="toc-text">4.4è®¡ç®—ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«æ¦‚ç‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0"><span class="toc-text">5.æŸå¤±å‡½æ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%A4%9A%E5%B0%BA%E5%BA%A6%E6%A3%80%E6%B5%8B"><span class="toc-text">6.å¤šå°ºåº¦æ£€æµ‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%BC%80%E5%90%AF%E7%AB%AF%E5%88%B0%E7%AB%AF%E8%AE%AD%E7%BB%83"><span class="toc-text">7.å¼€å¯ç«¯åˆ°ç«¯è®­ç»ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%A2%84%E6%B5%8B"><span class="toc-text">8.é¢„æµ‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%A8%A1%E5%9E%8B%E6%95%88%E6%9E%9C%E5%8F%8A%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B1%95%E7%A4%BA"><span class="toc-text">9.æ¨¡å‹æ•ˆæœåŠå¯è§†åŒ–å±•ç¤º</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/07/%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%EF%BC%9F%EF%BC%9F%EF%BC%9F/" title="å¦‚ä½•å­¦ä¹ åŠ¨æ€è§„åˆ’ï¼Ÿï¼Ÿï¼Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/28.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å¦‚ä½•å­¦ä¹ åŠ¨æ€è§„åˆ’ï¼Ÿï¼Ÿï¼Ÿ"/></a><div class="content"><a class="title" href="/2023/06/07/%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%EF%BC%9F%EF%BC%9F%EF%BC%9F/" title="å¦‚ä½•å­¦ä¹ åŠ¨æ€è§„åˆ’ï¼Ÿï¼Ÿï¼Ÿ">å¦‚ä½•å­¦ä¹ åŠ¨æ€è§„åˆ’ï¼Ÿï¼Ÿï¼Ÿ</a><time datetime="2023-06-07T15:58:25.000Z" title="å‘è¡¨äº 2023-06-07 23:58:25">2023-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/30/%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%89%87%E8%BD%AE%E8%BD%AC%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="åŸºäºæ—¶é—´ç‰‡è½®è½¬çš„è¿›ç¨‹ç®¡ç†ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/27.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åŸºäºæ—¶é—´ç‰‡è½®è½¬çš„è¿›ç¨‹ç®¡ç†ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°"/></a><div class="content"><a class="title" href="/2023/05/30/%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%89%87%E8%BD%AE%E8%BD%AC%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="åŸºäºæ—¶é—´ç‰‡è½®è½¬çš„è¿›ç¨‹ç®¡ç†ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°">åŸºäºæ—¶é—´ç‰‡è½®è½¬çš„è¿›ç¨‹ç®¡ç†ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°</a><time datetime="2023-05-30T15:25:36.000Z" title="å‘è¡¨äº 2023-05-30 23:25:36">2023-05-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/29/Python%E5%9B%9B%E5%A4%A7%E6%B3%95%E5%AE%9D/" title="Pythonå››å¤§æ³•å®"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/article_img/Python/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Pythonå››å¤§æ³•å®"/></a><div class="content"><a class="title" href="/2023/05/29/Python%E5%9B%9B%E5%A4%A7%E6%B3%95%E5%AE%9D/" title="Pythonå››å¤§æ³•å®">Pythonå››å¤§æ³•å®</a><time datetime="2023-05-29T05:19:20.000Z" title="å‘è¡¨äº 2023-05-29 13:19:20">2023-05-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By å°æ¼å¤´&å°æˆ´</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.6/translate/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script defer src="/js/light.js"></script><canvas id="universe"></canvas><script defer src="/js/starry_sky.js"></script><script defer src="/js/console.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script async data-pjax src="/js/card_author.js"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"JzK9w99AgP1g6fso",ck:"JzK9w99AgP1g6fso"})</script><script type="text/javascript" src ="/js/reward.js" ></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="/js/txmap.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.2.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://dashboard.4everland.org/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œå¤‡ç”¨çº¿è·¯æ‰˜ç®¡äº4EVERLAND" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-4EVERLAND-22DDDD?style=flat&amp;logo=IPFS" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/02/02/è®ºæ–‡ç¿»è¯‘/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-02-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/02/02/è®ºæ–‡ç¿»è¯‘/&quot;);" href="javascript:void(0);" alt="">è‹±æ–‡æ°´å¹³ä¸é«˜ï¼Œå’‹ç¿»è¯‘è®ºæ–‡ï¼Ÿ</a><div class="blog-slider__text">è‹±æ–‡æ°´å¹³ä¸é«˜ï¼Œå’‹ç¿»è¯‘è®ºæ–‡ï¼Ÿ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/02/02/è®ºæ–‡ç¿»è¯‘/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/17/åšå®¢æ­å»ºå­¦ä¹ ç¬”è®°/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/web_background2.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/17/åšå®¢æ­å»ºå­¦ä¹ ç¬”è®°/&quot;);" href="javascript:void(0);" alt="">ğŸŒåšå®¢æ­å»ºå­¦ä¹ ç¬”è®°</a><div class="blog-slider__text">è¿™æ˜¯å†æ­å»ºåšå®¢å·²ç»å†™æ–‡ç« æ—¶é‡åˆ°çš„bugå’Œå¯¹åšå®¢çš„ä¸€äº›å¿…è¦æ“ä½œï¼Œä¸å®šæ—¶æ›´æ–°å“¦~</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/17/åšå®¢æ­å»ºå­¦ä¹ ç¬”è®°/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/Butterflyå¤–æŒ‚æ ‡ç­¾/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/9.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/Butterflyå¤–æŒ‚æ ‡ç­¾/&quot;);" href="javascript:void(0);" alt="">Butterflyå¤–æŒ‚æ ‡ç­¾</a><div class="blog-slider__text">æœ¬æ–‡æ˜¯æ’°å†™åšå®¢æ–‡ç« æ—¶å¯èƒ½ä¼šç”¨åˆ°çš„å¤–æŒ‚æ ‡ç­¾æ±‡æ€»ï¼Œæ”¾åˆ°ä¸€èµ·ï¼Œä¾¿äºæŸ¥é˜…å’Œä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/Butterflyå¤–æŒ‚æ ‡ç­¾/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/09/hello-world/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/3.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/09/hello-world/&quot;);" href="javascript:void(0);" alt="">ç¬¬ä¸€ç¯‡æ–‡ç« </a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/09/hello-world/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/erro_spawn_failed/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/7.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/erro_spawn_failed/&quot;);" href="javascript:void(0);" alt="">Hexoå‘ç”Ÿerrorï¼šspawn failedé”™è¯¯çš„è§£å†³æ–¹æ³•</a><div class="blog-slider__text">Hexoå‘ç”Ÿerrorï¼šspawn failedé”™è¯¯çš„è§£å†³æ–¹æ³•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/erro_spawn_failed/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/06/Hexoåšå®¢å¤‡ä»½ä¸æ¢å¤/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/7.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/06/Hexoåšå®¢å¤‡ä»½ä¸æ¢å¤/&quot;);" href="javascript:void(0);" alt="">Hexoåšå®¢å¤‡ä»½ä¸æ¢å¤</a><div class="blog-slider__text">æœ¬æ–‡æ—¨åœ¨è§£å†³åœ¨ä¸åŒç”µè„‘ä¸Šéƒ½èƒ½ç»´æŠ¤åšå®¢æˆ–é…ç½®ã€å‘å¸ƒçš„å†…å®¹ä¸¢å¤±å¯æ¢å¤çš„é—®é¢˜ã€‚</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/06/Hexoåšå®¢å¤‡ä»½ä¸æ¢å¤/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/24/Echartsç¤¾åŒºåœ°å€/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picbed.dai2yutou.space/web_img/10.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-24</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/24/Echartsç¤¾åŒºåœ°å€/&quot;);" href="javascript:void(0);" alt="">Echartsç¤¾åŒºåœ°å€</a><div class="blog-slider__text">ä¸€äº›Echartså›¾æ ‡çš„å¼€æºç½‘ç«™ã€‚</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/24/Echartsç¤¾åŒºåœ°å€/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__bounceInRight');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/about/'|| '/about/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.dai2yutou.space/api?xiaoyutoua",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'xiaoyutoua')
    }
  </script><!-- hexo injector body_end end --><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>